<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calm Mind - Controle de Ansiedade</title>
    <meta name="description" content="App para controle e acompanhamento de ansiedade">
    <meta name="theme-color" content="#7c9cbf">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calm Mind">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'calm-blue': '#7c9cbf',
                        'calm-blue-dark': '#5a7a9e',
                        'calm-green': '#a8c5a8',
                        'calm-lavender': '#b8a9d4',
                        'calm-sand': '#e8dcc4',
                        'calm-mint': '#b8d8d8',
                        'calm-bg': '#2a3d4a',
                        'calm-card': '#3a5260'
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes breathe {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.2); 
                opacity: 1;
            }
        }
        
        @keyframes pulse-gentle {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05);
            }
        }
        
        @keyframes breathe-in {
            0% { transform: scale(1); }
            100% { transform: scale(1.3); }
        }
        
        @keyframes breathe-out {
            0% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Anima√ß√£o para frases motivacionais */
        @keyframes fadeInOut {
            0% { 
                opacity: 0; 
                transform: translateY(10px);
            }
            10%, 90% { 
                opacity: 1; 
                transform: translateY(0);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-10px);
            }
        }
        
        .animate-breathe {
            animation: breathe 8s infinite;
        }
        
        .animate-breathe-in {
            animation: breathe-in 4s ease-in-out;
        }
        
        .animate-breathe-out {
            animation: breathe-out 6s ease-in-out;
        }
        
        .animate-pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        
        .animate-fade-in-out {
            animation: fadeInOut 9s ease-in-out;
        }
        
        /* Scale classes for SOS breathing */
        .scale-100 {
            transform: scale(1);
        }
        
        .scale-150 {
            transform: scale(1.5);
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Efeito de favorito */
        .favorite-icon {
            transition: all 0.3s ease;
        }
        
        .favorite-icon.active {
            color: #fbbf24;
            transform: scale(1.2);
        }

        /* Sleep Quality Button Effects */
        .sleep-quality-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .sleep-quality-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(124, 156, 191, 0.6) 0%, transparent 70%);
            opacity: 0;
            transform: scale(2);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .sleep-quality-btn:active {
            transform: scale(0.95);
        }

        .sleep-quality-btn:active::after {
            opacity: 1;
            transform: scale(1);
        }

        .sleep-quality-btn.selected {
            transform: scale(1.1);
            background: rgba(124, 156, 191, 0.2);
            box-shadow: 0 0 15px rgba(124, 156, 191, 0.3);
        }
    </style>
</head>

<body class="bg-calm-bg text-white font-sans">
    <!-- Modal SOS -->
<div id="sosModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl space-y-6">
    <h2 class="text-2xl font-bold text-red-600 text-center">Modo SOS</h2>

    <!-- Respira√ß√£o Guiada -->
    <div id="breathingSection" class="space-y-4 text-center">
      <p class="text-gray-700">Respire com o c√≠rculo:</p>
      <div id="breathingCircle" class="mx-auto w-24 h-24 rounded-full bg-red-200 my-6 flex items-center justify-center"></div>
      <p id="breathingInstruction" class="text-lg font-semibold text-gray-800">Inspire...</p>
    </div>

    <!-- Contatos -->
    <div class="border-t pt-4">
      <h3 class="text-lg font-bold text-gray-800 mb-2">Contatos de Emerg√™ncia</h3>
      <ul class="space-y-2 text-center">
        <li><a href="tel:188" class="block bg-red-500 text-white py-2 rounded-lg">üìû CVV - 188</a></li>
        <li><a href="tel:192" class="block bg-orange-500 text-white py-2 rounded-lg">üöë SAMU - 192</a></li>
      </ul>
      <div id="customContacts" class="mt-4"></div>
      <button onclick="addContact()" class="mt-2 w-full bg-gray-200 py-2 rounded-lg">‚ûï Adicionar Contato</button>
    </div>

    <!-- T√©cnica de Ancoragem -->
    <div class="border-t pt-4 text-center">
      <button onclick="startGrounding()" class="bg-blue-500 text-white py-2 px-4 rounded-lg">üßò T√©cnica 5-4-3-2-1</button>
    </div>

    <button onclick="closeSOS()" class="w-full mt-4 py-2 bg-gray-300 rounded-lg">Fechar</button>
  </div>
</div>

        <!-- Loading Screen -->
        <div id="loading" class="fixed inset-0 bg-calm-bg flex items-center justify-center z-50">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-calm-blue border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <h2 class="text-xl font-semibold text-calm-blue">Calm Mind</h2>
                <p class="text-gray-400">Carregando...</p>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <header class="bg-calm-card p-4 shadow-lg">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-center text-calm-blue">üå∏ Calm Mind</h1>
                    <div class="flex gap-2">
                        <!-- Community Button -->
                        <button onclick="openCommunityModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg animate-pulse shadow-md z-50 text-sm" title="Comunidade">
                            Comunidade
                        </button>
                        <!-- SOS Button -->
                        <button onclick="activateSOS()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg animate-pulse shadow-md z-50 text-sm" title="Modo de emerg√™ncia">
                            SOS
                        </button>
                    </div>
                </div>
                <p class="text-center text-gray-400 text-sm mt-1">Seu espa√ßo de bem-estar mental</p>
                <div class="flex justify-center mt-3">
                    <button id="installBtn" onclick="promptInstall()" class="hidden bg-calm-sand text-calm-blue-dark px-3 py-1 rounded text-sm shadow">
                        ‚ú® Instalar App
                    </button>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="bg-calm-card border-t border-gray-700">
                <div class="flex justify-around py-2">
                    <button onclick="showSection('dashboard')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="dashboard">
                        <span class="text-xl mb-1">üìà</span>
                        <span class="text-xs">Dashboard</span>
                    </button>
                    <button onclick="showSection('mood')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="mood">
                        <span class="text-xl mb-1">üí≠</span>
                        <span class="text-xs">Humor</span>
                    </button>
                    <button onclick="showSection('breathing')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="breathing">
                        <span class="text-xl mb-1">üí®</span>
                        <span class="text-xs">Respira√ß√£o</span>
                    </button>
                    <button onclick="showSection('sleep')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="sleep">
                        <span class="text-xl mb-1">üåô</span>
                        <span class="text-xs">Sono</span>
                    </button>
                    <button onclick="showSection('diary')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="diary">
                        <span class="text-xl mb-1">‚úçÔ∏è</span>
                        <span class="text-xs">Di√°rio</span>
                    </button>
                </div>
            </nav>

            <!-- Content Sections -->
            <main class="p-4 pb-20">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="section">
                    <!-- Sleep Stats Card -->
                    <div class="mb-6 bg-calm-card p-6 rounded-2xl shadow-lg flex items-center gap-6">
                        <div class="bg-calm-bg p-4 rounded-xl flex-1 text-center">
                            <span class="text-2xl block mb-1">üåô</span>
                            <span id="avgSleepHours" class="text-xl font-bold block">0h</span>
                            <span class="text-sm text-gray-400">M√©dia de Sono</span>
                        </div>
                        <div class="bg-calm-bg p-4 rounded-xl flex-1 text-center">
                            <span class="text-2xl block mb-1">üò¥</span>
                            <span id="sleepQuality" class="text-xl font-bold block">-</span>
                            <span class="text-sm text-gray-400">Qualidade</span>
                        </div>
                        <div class="bg-calm-bg p-4 rounded-xl flex-1 text-center">
                            <span class="text-2xl block mb-1">üìä</span>
                            <span id="sleepStreak" class="text-xl font-bold block">0</span>
                            <span class="text-sm text-gray-400">Registros</span>
                        </div>
                    </div>

                    <!-- COMPONENTE DE FRASES MOTIVACIONAIS -->
                    <div class="mb-6 bg-gradient-to-br from-calm-card to-calm-bg p-6 rounded-2xl border border-calm-lavender/20 shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-calm-lavender/10 rounded-full blur-3xl"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-calm-mint/10 rounded-full blur-2xl"></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-calm-lavender">üí´ Mensagem do dia</h3>
                                <button 
                                    onclick="toggleFavoritePhrase()" 
                                    class="favorite-icon text-xl transition-all hover:scale-110"
                                    id="favoriteBtn"
                                    title="Salvar como favorita">
                                    ‚≠ê
                                </button>
                            </div>
                            
                            <div class="min-h-[80px] flex items-center justify-center">
                                <p id="motivationalPhrase" class="text-lg text-center text-gray-200 leading-relaxed animate-fade-in-out">
                                    Carregando mensagem inspiradora...
                                </p>
                            </div>
                            
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-400">
                                <span id="phraseTimer">Pr√≥xima em 9s</span>
                                <button 
                                    onclick="nextPhrase()" 
                                    class="text-calm-mint hover:text-calm-green transition-colors">
                                    Pr√≥xima ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- NOVA SE√á√ÉO: Frases Favoritas -->
                    <div id="favoritesSection" class="mb-6 hidden">
                        <div class="bg-calm-card p-4 rounded-lg border border-calm-sand/20">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-medium text-calm-sand">‚≠ê Suas frases favoritas</h3>
                                <button onclick="toggleFavoritesView()" class="text-xs text-gray-400 hover:text-white">
                                    Ocultar
                                </button>
                            </div>
                            <div id="favoritesList" class="space-y-2">
                                <!-- Favoritas ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-xl font-semibold mb-4 text-calm-blue">üìà Seu Progresso</h2>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-calm-card p-4 rounded-lg border border-calm-blue/20">
                                <h3 class="text-sm text-gray-400">Registros este m√™s</h3>
                                <p class="text-2xl font-bold text-calm-blue" id="monthlyRecords">0</p>
                            </div>
                            <div class="bg-calm-card p-4 rounded-lg border border-calm-green/20">
                                <h3 class="text-sm text-gray-400">Exerc√≠cios feitos</h3>
                                <p class="text-2xl font-bold text-calm-green" id="exercisesCount">0</p>
                            </div>
                        </div>

                        <!-- Recent Mood Chart -->
                        <div class="bg-calm-card p-4 rounded-lg border border-calm-lavender/20">
                            <h3 class="text-lg font-medium mb-3 text-calm-lavender">Humor dos √∫ltimos 7 dias</h3>
                            <div id="moodChart" class="h-32 flex items-end justify-around">
                                <!-- Chart will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Recent Entries -->
                    <div class="bg-calm-card p-4 rounded-lg border border-calm-mint/20">
                        <h3 class="text-lg font-medium mb-3 text-calm-mint">√öltimos registros</h3>
                        <div id="recentEntries" class="space-y-3">
                            <!-- Recent entries will be populated by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- Mood Section -->
                <section id="mood-section" class="section hidden">
                    <h2 class="text-xl font-semibold mb-4 text-calm-blue">üí≠ Como voc√™ est√° se sentindo?</h2>
                    
                    <div class="bg-calm-card p-6 rounded-lg mb-4 border border-calm-blue/20">
                        <div class="text-center mb-6">
                            <p class="text-gray-300 mb-4">Selecione seu humor atual:</p>
                            <div class="flex justify-around mb-6">
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="1" title="Muito mal">üò∞</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="2" title="Mal">üòû</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="3" title="Neutro">üòê</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="4" title="Bem">üòä</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="5" title="Muito bem">üòÑ</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">N√≠vel de ansiedade (1-10):</label>
                            <input type="range" id="anxietyLevel" min="1" max="10" value="5" class="w-full accent-calm-lavender">
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>Baixa</span>
                                <span>Moderada</span>
                                <span>Alta</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">O que voc√™ est√° sentindo?</label>
                            <textarea id="moodNotes" placeholder="Descreva suas emo√ß√µes, pensamentos ou o que aconteceu hoje..." class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none resize-none" rows="3"></textarea>
                        </div>

                        <button onclick="saveMoodEntry()" class="w-full bg-calm-blue hover:bg-calm-blue-dark text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            üíæ Salvar Registro
                        </button>
                    </div>
                </section>

                <!-- Breathing Section -->
                <section id="breathing-section" class="section hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-calm-blue">üí® Exerc√≠cios de Respira√ß√£o</h2>
                        <button onclick="toggleAudioGuide()" id="audioToggle" class="flex items-center gap-2 bg-calm-card px-3 py-2 rounded-lg border border-calm-blue/30 transition-colors hover:bg-calm-blue/20" title="Ativar/desativar √°udio guiado">
                            <span id="audioIcon">üîä</span>
                            <span class="text-xs">√Åudio</span>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Breathing Exercise 1 -->
                        <div class="bg-calm-card p-6 rounded-lg border border-calm-mint/20">
                            <h3 class="text-lg font-medium mb-2 text-calm-mint">4-7-8 (Relaxamento)</h3>
                            <p class="text-gray-400 mb-4">Inspire por 4, segure por 7, expire por 8 segundos</p>
                            <button onclick="startBreathing('478')" class="bg-calm-mint hover:bg-calm-mint/80 text-calm-bg px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>

                        <!-- Breathing Exercise 2 -->
                        <div class="bg-calm-card p-6 rounded-lg border border-calm-green/20">
                            <h3 class="text-lg font-medium mb-2 text-calm-green">Box Breathing (Foco)</h3>
                            <p class="text-gray-400 mb-4">4 tempos para cada fase: inspire, segure, expire, segure</p>
                            <button onclick="startBreathing('box')" class="bg-calm-green hover:bg-calm-green/80 text-calm-bg px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>

                        <!-- Breathing Exercise 3 -->
                        <div class="bg-calm-card p-6 rounded-lg border border-calm-lavender/20">
                            <h3 class="text-lg font-medium mb-2 text-calm-lavender">Respira√ß√£o Simples</h3>
                            <p class="text-gray-400 mb-4">Inspire por 4, expire por 6 segundos</p>
                            <button onclick="startBreathing('simple')" class="bg-calm-lavender hover:bg-calm-lavender/80 text-calm-bg px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Breathing Exercise Modal -->
                <div id="breathingModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50">
                    <div class="bg-calm-card p-8 rounded-lg max-w-sm w-full mx-4 text-center border-2 border-calm-blue/30">
                        <h3 id="exerciseTitle" class="text-xl font-semibold mb-4 text-calm-blue"></h3>
                        
                        <!-- Breathing Animation -->
                        <div class="relative mb-6">
                            <div id="breathingCircle" class="w-32 h-32 mx-auto bg-gradient-to-br from-calm-mint to-calm-lavender rounded-full flex items-center justify-center text-calm-bg font-bold text-lg shadow-lg">
                                <span id="breathingText">Prepare-se</span>
                            </div>
                        </div>

                        <div id="instructionText" class="text-lg mb-4 h-6 text-gray-300">Preparando...</div>
                        <div id="timerText" class="text-3xl font-bold mb-6 text-calm-blue">3</div>
                        
                        <div class="flex gap-4">
                            <button onclick="stopBreathing()" class="flex-1 bg-calm-lavender hover:bg-calm-lavender/80 text-calm-bg py-2 px-4 rounded-lg transition-colors">
                                ‚èπÔ∏è Parar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sleep Section -->
                <section id="sleep-section" class="section hidden">
                    <!-- Registro de Sono -->
                    <div class="mb-6 bg-calm-card p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üåô</span> Registro do Sono
                        </h2>
                        <form id="sleepForm" class="space-y-4">
                            <div class="form-group">
                                <label class="block text-gray-400 text-sm font-medium mb-2">Hora que dormiu</label>
                                <input type="datetime-local" id="sleepTime" required 
                                    class="w-full bg-calm-bg p-3 rounded-lg border border-calm-blue/20 focus:border-calm-blue/50 transition-colors">
                            </div>
                            <div class="form-group">
                                <label class="block text-gray-400 text-sm font-medium mb-2">Hora que acordou</label>
                                <input type="datetime-local" id="wakeTime" required
                                    class="w-full bg-calm-bg p-3 rounded-lg border border-calm-blue/20 focus:border-calm-blue/50 transition-colors">
                            </div>
                            <div class="form-group">
                                <label class="block text-gray-400 text-sm font-medium mb-2">Qualidade do sono</label>
                                <div class="grid grid-cols-5 gap-3">
                                    <button type="button" class="quality-btn bg-calm-bg p-4 rounded-xl text-2xl hover:bg-calm-blue/10 transition-all" data-quality="1">üò´</button>
                                    <button type="button" class="quality-btn bg-calm-bg p-4 rounded-xl text-2xl hover:bg-calm-blue/10 transition-all" data-quality="2">üòï</button>
                                    <button type="button" class="quality-btn bg-calm-bg p-4 rounded-xl text-2xl hover:bg-calm-blue/10 transition-all" data-quality="3">üòê</button>
                                    <button type="button" class="quality-btn bg-calm-bg p-4 rounded-xl text-2xl hover:bg-calm-blue/10 transition-all" data-quality="4">üòä</button>
                                    <button type="button" class="quality-btn bg-calm-bg p-4 rounded-xl text-2xl hover:bg-calm-blue/10 transition-all" data-quality="5">üò¥</button>
                                </div>
                                <input type="hidden" id="sleepQuality" required>
                            </div>
                            <button type="submit" class="w-full bg-calm-blue text-white py-4 rounded-xl font-medium hover:bg-calm-blue/90 transition-colors">
                                Salvar Registro
                            </button>
                        </form>
                    </div>

                    <!-- Insights -->
                    <div class="mb-6 bg-calm-card p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üìä</span> Insights Semanais
                        </h2>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-calm-bg p-4 rounded-xl text-center">
                                <div class="text-sm text-gray-400 mb-2">M√©dia de Horas</div>
                                <div class="text-2xl font-bold text-calm-blue" id="avgSleepHoursInsights">-</div>
                            </div>
                            <div class="bg-calm-bg p-4 rounded-xl text-center">
                                <div class="text-sm text-gray-400 mb-2">Regularidade</div>
                                <div class="text-2xl font-bold text-calm-blue" id="sleepRegularity">-</div>
                            </div>
                            <div class="bg-calm-bg p-4 rounded-xl text-center">
                                <div class="text-sm text-gray-400 mb-2">Qualidade</div>
                                <div class="text-2xl font-bold text-calm-blue" id="avgSleepQuality">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifica√ß√µes -->
                    <div class="mb-6 bg-calm-card p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üîî</span> Lembretes
                        </h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between bg-calm-bg p-4 rounded-xl">
                                <div>
                                    <div class="font-medium">Hora de Dormir</div>
                                    <div class="text-sm text-gray-400">22:00 todos os dias</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="sleepReminder" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-calm-blue"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between bg-calm-bg p-4 rounded-xl">
                                <div>
                                    <div class="font-medium">Como foi seu sono?</div>
                                    <div class="text-sm text-gray-400">8:00 todos os dias</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="morningReminder" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-calm-blue"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Hist√≥rico -->
                    <div class="bg-calm-card p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üìÖ</span> Hist√≥rico
                        </h2>
                        <div id="sleepHistory" class="space-y-3">
                            <!-- Sleep history entries will be inserted here -->
                        </div>
                    </div>
                </section>

                <!-- Diary Section -->
                <section id="diary-section" class="section hidden">
                    <h2 class="text-xl font-semibold mb-4 text-calm-blue">‚úçÔ∏è Di√°rio Emocional</h2>
                    
                    <!-- New Entry Form -->
                    <div class="bg-calm-card p-6 rounded-lg mb-6 border border-calm-sand/20">
                        <h3 class="text-lg font-medium mb-4 text-calm-sand">Nova entrada</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">T√≠tulo (opcional)</label>
                            <input type="text" id="diaryTitle" placeholder="Ex: Dia tranquilo em casa" class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Como foi seu dia?</label>
                            <textarea id="diaryEntry" placeholder="Escreva sobre seus pensamentos, sentimentos, o que aconteceu hoje..." class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none resize-none" rows="5"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Tags (separe por v√≠rgula)</label>
                            <input type="text" id="diaryTags" placeholder="trabalho, fam√≠lia, gratid√£o, paz" class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none">
                        </div>

                        <button onclick="saveDiaryEntry()" class="w-full bg-calm-blue hover:bg-calm-blue-dark text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            üíæ Salvar Entrada
                        </button>
                    </div>

                    <!-- Diary Entries -->
                    <div>
                        <h3 class="text-lg font-medium mb-4 text-calm-lavender">Suas entradas</h3>
                        <div id="diaryEntries" class="space-y-4">
                            <!-- Diary entries will be populated by JavaScript -->
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Success Toast -->
        <div id="toast" class="fixed top-4 right-4 bg-calm-green text-calm-bg px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform z-50">
            <span id="toastMessage"></span>
        </div>

        <!-- Community Modal -->
        <div id="communityModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50">
            <div class="bg-calm-card p-8 rounded-lg max-w-4xl w-full mx-4 border-2 border-calm-blue/30">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-calm-blue">Comunidade Calm Mind</h2>
                    <button onclick="closeCommunityModal()" class="text-gray-400 hover:text-white">
                        <span class="text-2xl">√ó</span>
                    </button>
                </div>

                <!-- Social Links Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Discord -->
                    <a href="https://discord.gg/your-invite" target="_blank" 
                       class="flex items-center gap-4 bg-[#5865F2] p-4 rounded-lg hover:opacity-90 transition-opacity">
                        <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.369-.444.85-.608 1.23a18.566 18.566 0 0 0-5.487 0 12.36 12.36 0 0 0-.617-1.23A.077.077 0 0 0 8.562 3c-1.714.29-3.354.8-4.885 1.491a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055 20.03 20.03 0 0 0 5.993 2.98.078.078 0 0 0 .084-.026 13.83 13.83 0 0 0 1.226-1.963.074.074 0 0 0-.041-.104 13.175 13.175 0 0 1-1.872-.878.075.075 0 0 1-.008-.125c.126-.093.252-.19.372-.287a.075.075 0 0 1 .078-.01c3.927 1.764 8.18 1.764 12.061 0a.075.075 0 0 1 .079.009c.12.098.245.195.372.288a.075.075 0 0 1-.006.125c-.598.344-1.22.635-1.873.877a.075.075 0 0 0-.041.105c.36.687.772 1.341 1.225 1.962a.077.077 0 0 0 .084.028 19.963 19.963 0 0 0 6.002-2.981.076.076 0 0 0 .032-.054c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 0 0-.031-.028zM8.02 15.278c-1.182 0-2.157-1.069-2.157-2.38 0-1.312.956-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.956 2.38-2.157 2.38zm7.975 0c-1.183 0-2.157-1.069-2.157-2.38 0-1.312.955-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.946 2.38-2.157 2.38z"/>
                        </svg>
                        <div class="text-white">
                            <h3 class="font-bold">Discord</h3>
                            <p class="text-sm opacity-90">Junte-se √† nossa comunidade</p>
                        </div>
                    </a>

                    <!-- Telegram -->
                    <a href="https://t.me/your-channel" target="_blank" 
                       class="flex items-center gap-4 bg-[#0088cc] p-4 rounded-lg hover:opacity-90 transition-opacity">
                        <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06-.01.13-.02.2z"/>
                        </svg>
                        <div class="text-white">
                            <h3 class="font-bold">Telegram</h3>
                            <p class="text-sm opacity-90">Receba atualiza√ß√µes</p>
                        </div>
                    </a>

                    <!-- Blog -->
                    <a href="https://blog.calm-mind.com" target="_blank" 
                       class="flex items-center gap-4 bg-calm-mint p-4 rounded-lg hover:opacity-90 transition-opacity">
                        <span class="text-3xl">‚úçÔ∏è</span>
                        <div class="text-calm-bg">
                            <h3 class="font-bold">Blog</h3>
                            <p class="text-sm opacity-90">Artigos e dicas</p>
                        </div>
                    </a>
                </div>

                <!-- Psychologist Search Section -->
                <div class="bg-calm-bg p-6 rounded-lg">
                    <h3 class="text-xl font-bold text-calm-blue mb-4">Encontre um Psic√≥logo</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Search Input -->
                        <div class="md:col-span-2">
                            <input type="text" id="psychologistSearch" 
                                   placeholder="Buscar por nome, especialidade ou cidade..." 
                                   class="w-full p-3 bg-calm-card rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none">
                        </div>
                        
                        <!-- Filter Select -->
                        <select id="psychologistFilter" 
                                class="p-3 bg-calm-card rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none">
                            <option value="all">Todos</option>
                            <option value="anxiety">Ansiedade</option>
                            <option value="depression">Depress√£o</option>
                            <option value="online">Atendimento Online</option>
                        </select>
                    </div>

                    <!-- Results Container -->
                    <div id="psychologistResults" class="space-y-4 max-h-60 overflow-y-auto">
                        <!-- Results will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // SISTEMA DE FRASES MOTIVACIONAIS
        // ==========================================
        
        const motivationalPhrases = {
            morning: [
                { emoji: 'üåø', text: 'Respire fundo. Voc√™ n√£o precisa resolver tudo agora.' },
                { emoji: '‚òÄÔ∏è', text: 'Hoje √© um bom dia para tentar com calma.' },
                { emoji: 'üåª', text: 'Voc√™ est√° fazendo o melhor que pode ‚Äî e isso √© o suficiente.' },
                { emoji: 'üåû', text: 'A calma cresce quando voc√™ a cultiva todos os dias.' },
                { emoji: '‚òï', text: 'A pausa tamb√©m faz parte do caminho.' },
                { emoji: 'üåÖ', text: 'Mesmo os pequenos avan√ßos merecem reconhecimento.' }
            ],
            afternoon: [
                { emoji: 'üåä', text: 'A mar√© da vida sobe e desce, mas sempre volta a se acalmar.' },
                { emoji: 'üå§Ô∏è', text: 'Tudo bem n√£o estar bem o tempo todo.' },
                { emoji: 'üåº', text: 'Um passo de cada vez tamb√©m √© progresso.' },
                { emoji: 'üçÉ', text: 'Nada precisa ser perfeito, apenas verdadeiro.' },
                { emoji: 'üíß', text: 'Permita-se sentir. Emo√ß√µes tamb√©m passam.' },
                { emoji: 'üå∫', text: 'Voc√™ j√° superou dias dif√≠ceis antes. Vai conseguir de novo.' }
            ],
            evening: [
                { emoji: 'üåô', text: 'Descanse. Amanh√£ voc√™ recome√ßa com mais leveza.' },
                { emoji: 'üåæ', text: 'N√£o apresse o seu tempo. A cura tamb√©m tem o pr√≥prio ritmo.' },
                { emoji: 'üå∏', text: 'Voc√™ √© mais forte do que pensa e mais amado do que imagina.' },
                { emoji: 'üïäÔ∏è', text: 'A ansiedade n√£o define quem voc√™ √©.' },
                { emoji: 'üåô', text: 'Feche os olhos e lembre-se: o agora √© seguro.' },
                { emoji: 'üåª', text: 'Voc√™ n√£o est√° sozinho. Est√° aprendendo a se cuidar.' },
                { emoji: 'üí´', text: 'Sua mente precisa de descanso tanto quanto seu corpo.' },
                { emoji: 'üå∑', text: 'H√° beleza at√© mesmo nos dias em que voc√™ apenas tenta.' }
            ]
        };

        // Estado do componente de frases
        let currentPhraseIndex = 0;
        let currentPeriod = 'morning';
        let phraseRotationInterval = null;
        let phraseTimerInterval = null;
        let timeLeft = 9;
        let currentPhrase = null;
        let favoritePhrases = [];

        // Determina o per√≠odo do dia
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 18) return 'afternoon';
            return 'evening';
        }

        // Carrega frases favoritas do localStorage
        function loadFavoritePhrases() {
            const stored = localStorage.getItem('calmMindFavorites');
            favoritePhrases = stored ? JSON.parse(stored) : [];
            updateFavoritesDisplay();
        }

        // Salva frases favoritas no localStorage
        function saveFavoritePhrases() {
            localStorage.setItem('calmMindFavorites', JSON.stringify(favoritePhrases));
        }

        // Verifica se a frase atual est√° nos favoritos
        function isCurrentPhraseFavorite() {
            if (!currentPhrase) return false;
            return favoritePhrases.some(fav => fav.text === currentPhrase.text);
        }

        // Toggle favorito da frase atual
        function toggleFavoritePhrase() {
            if (!currentPhrase) return;

            const isFavorite = isCurrentPhraseFavorite();
            const favoriteBtn = document.getElementById('favoriteBtn');

            if (isFavorite) {
                // Remove dos favoritos
                favoritePhrases = favoritePhrases.filter(fav => fav.text !== currentPhrase.text);
                favoriteBtn.classList.remove('active');
                showToast('Frase removida dos favoritos');
            } else {
                // Adiciona aos favoritos
                favoritePhrases.push({...currentPhrase, savedAt: new Date().toISOString()});
                favoriteBtn.classList.add('active');
                showToast('Frase salva nos favoritos! ‚≠ê');
            }

            saveFavoritePhrases();
            updateFavoritesDisplay();
        }

        // Atualiza a exibi√ß√£o de favoritos
        function updateFavoritesDisplay() {
            const favoritesSection = document.getElementById('favoritesSection');
            const favoritesList = document.getElementById('favoritesList');

            if (favoritePhrases.length === 0) {
                favoritesSection.classList.add('hidden');
                return;
            }

            favoritesSection.classList.remove('hidden');
            favoritesList.innerHTML = favoritePhrases.map((phrase, index) => `
                <div class="bg-calm-bg p-3 rounded-lg flex items-start gap-3 border border-calm-sand/10">
                    <span class="text-xl">${phrase.emoji}</span>
                    <div class="flex-1">
                        <p class="text-sm text-gray-300">${phrase.text}</p>
                    </div>
                    <button 
                        onclick="removeFavorite(${index})" 
                        class="text-gray-400 hover:text-red-400 transition-colors text-sm"
                        title="Remover">
                        √ó
                    </button>
                </div>
            `).join('');
        }

        // Remove um favorito
        function removeFavorite(index) {
            favoritePhrases.splice(index, 1);
            saveFavoritePhrases();
            updateFavoritesDisplay();
            updateFavoriteButtonState();
            showToast('Frase removida dos favoritos');
        }

        // Toggle visualiza√ß√£o de favoritos
        function toggleFavoritesView() {
            const favoritesSection = document.getElementById('favoritesSection');
            favoritesSection.classList.toggle('hidden');
        }

        // Atualiza o estado do bot√£o de favorito
        function updateFavoriteButtonState() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            if (isCurrentPhraseFavorite()) {
                favoriteBtn.classList.add('active');
            } else {
                favoriteBtn.classList.remove('active');
            }
        }

        // Exibe uma frase motivacional
        function displayMotivationalPhrase() {
            currentPeriod = getTimeOfDay();
            const phrases = motivationalPhrases[currentPeriod];
            currentPhrase = phrases[currentPhraseIndex];

            const phraseElement = document.getElementById('motivationalPhrase');
            
            // Remove anima√ß√£o para resetar
            phraseElement.classList.remove('animate-fade-in-out');
            
            // Aguarda um frame para aplicar a nova anima√ß√£o
            setTimeout(() => {
                phraseElement.innerHTML = `${currentPhrase.emoji} ${currentPhrase.text}`;
                phraseElement.classList.add('animate-fade-in-out');
                updateFavoriteButtonState();
            }, 50);

            // Avan√ßa para pr√≥xima frase
            currentPhraseIndex = (currentPhraseIndex + 1) % phrases.length;
        }

        // Avan√ßa para pr√≥xima frase manualmente
        function nextPhrase() {
            clearInterval(phraseRotationInterval);
            clearInterval(phraseTimerInterval);
            timeLeft = 9;
            displayMotivationalPhrase();
            startPhraseRotation();
        }

        // Timer visual da pr√≥xima frase
        function updatePhraseTimer() {
            const timerElement = document.getElementById('phraseTimer');
            timerElement.textContent = `Pr√≥xima em ${timeLeft}s`;
            timeLeft--;
            
            if (timeLeft < 0) {
                timeLeft = 9;
            }
        }

        // Inicia a rota√ß√£o autom√°tica de frases
        function startPhraseRotation() {
            // Limpa intervalos existentes
            if (phraseRotationInterval) clearInterval(phraseRotationInterval);
            if (phraseTimerInterval) clearInterval(phraseTimerInterval);

            // Exibe a primeira frase
            displayMotivationalPhrase();

            // Timer visual
            timeLeft = 9;
            phraseTimerInterval = setInterval(updatePhraseTimer, 1000);

            // Rota√ß√£o de frases a cada 9 segundos
            phraseRotationInterval = setInterval(() => {
                displayMotivationalPhrase();
                timeLeft = 9;
            }, 9000);
        }

        // ==========================================
        // FIM DO SISTEMA DE FRASES MOTIVACIONAIS
        // ==========================================

        // ==========================================
        // SISTEMA DE REL√ìGIO MESTRE PARA EXERC√çCIOS DE RESPIRA√á√ÉO
        // ==========================================
        
        // Rel√≥gio mestre para coordenar todos os exerc√≠cios de respira√ß√£o
        class MasterClock {
            constructor() {
                this.animationFrameId = null;
                this.subscribers = new Set();
                this.isRunning = false;
                this.startTime = null;
            }
            
            // Adicionar um subscriber (exerc√≠cio de respira√ß√£o)
            subscribe(callback) {
                this.subscribers.add(callback);
            }
            
            // Remover um subscriber
            unsubscribe(callback) {
                this.subscribers.delete(callback);
            }
            
            // Iniciar o rel√≥gio mestre
            start() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.startTime = performance.now();
                this.tick();
            }
            
            // Parar o rel√≥gio mestre
            stop() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.isRunning = false;
                this.startTime = null;
            }
            
            // Loop principal usando requestAnimationFrame
            tick = (timestamp) => {
                if (!this.startTime) {
                    this.startTime = timestamp;
                }
                
                const elapsed = timestamp - this.startTime;
                
                // Notificar todos os subscribers
                this.subscribers.forEach(callback => {
                    try {
                        callback(elapsed, timestamp);
                    } catch (error) {
                        console.error('Error in master clock subscriber:', error);
                    }
                });
                
                // Continuar o loop
                this.animationFrameId = requestAnimationFrame(this.tick);
            }
        }
        
        // Inst√¢ncia global do rel√≥gio mestre
        const masterClock = new MasterClock();
        
        // ==========================================
        // FIM DO SISTEMA DE REL√ìGIO MESTRE
        // ==========================================

        // ==========================================
        // SISTEMA DE COMUNIDADE
        // ==========================================
        
        // Mock data para psic√≥logos (em produ√ß√£o, isso viria de uma API)
        const psychologists = [
            {
                name: "Dra. Ana Silva",
                specialty: "Ansiedade, Depress√£o",
                city: "S√£o Paulo",
                online: true,
                crp: "06/12345",
                rating: 4.8,
                image: "https://placeholder.com/150"
            },
            {
                name: "Dr. Carlos Santos",
                specialty: "Ansiedade, TOC",
                city: "Rio de Janeiro",
                online: true,
                crp: "05/54321",
                rating: 4.9,
                image: "https://placeholder.com/150"
            },
            // Adicione mais psic√≥logos aqui
        ];

        function openCommunityModal() {
            const modal = document.getElementById('communityModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            initializePsychologistSearch();
        }

        function closeCommunityModal() {
            const modal = document.getElementById('communityModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function initializePsychologistSearch() {
            const searchInput = document.getElementById('psychologistSearch');
            const filterSelect = document.getElementById('psychologistFilter');

            // Limpa resultados anteriores
            displayPsychologistResults(psychologists);

            // Event listeners para busca e filtro
            searchInput.addEventListener('input', updatePsychologistResults);
            filterSelect.addEventListener('change', updatePsychologistResults);
        }

        function updatePsychologistResults() {
            const searchTerm = document.getElementById('psychologistSearch').value.toLowerCase();
            const filter = document.getElementById('psychologistFilter').value;

            let filteredResults = psychologists.filter(psych => {
                const matchesSearch = 
                    psych.name.toLowerCase().includes(searchTerm) ||
                    psych.specialty.toLowerCase().includes(searchTerm) ||
                    psych.city.toLowerCase().includes(searchTerm);

                const matchesFilter = 
                    filter === 'all' ||
                    (filter === 'online' && psych.online) ||
                    psych.specialty.toLowerCase().includes(filter);

                return matchesSearch && matchesFilter;
            });

            displayPsychologistResults(filteredResults);
        }

        function displayPsychologistResults(results) {
            const container = document.getElementById('psychologistResults');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-4">
                        Nenhum resultado encontrado
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map(psych => `
                <div class="bg-calm-card p-4 rounded-lg border border-calm-blue/20 hover:border-calm-blue/50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-calm-blue">${psych.name}</h4>
                            <p class="text-sm text-gray-400">${psych.specialty}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs bg-calm-bg px-2 py-1 rounded">CRP: ${psych.crp}</span>
                                ${psych.online ? '<span class="text-xs bg-calm-green/20 text-calm-green px-2 py-1 rounded">Online</span>' : ''}
                                <span class="text-xs text-yellow-400">‚òÖ ${psych.rating}</span>
                            </div>
                        </div>
                        <button onclick="contactPsychologist('${psych.name}')" 
                                class="bg-calm-blue hover:bg-calm-blue-dark text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            Contatar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function contactPsychologist(name) {
            // Aqui voc√™ implementaria a l√≥gica de contato
            showToast(`Solicita√ß√£o de contato enviada para ${name}`);
        }

        // ==========================================
        // FIM DO SISTEMA DE COMUNIDADE
        // ==========================================

        // ==========================================
        // SISTEMA SOS PARA CRISES DE ANSIEDADE
        // ==========================================

        // Vari√°veis para o controle do loop de anima√ß√£o
        let sosAnimationFrameId = null;
        let sosStartTime = null;
        let sosPreviousPhase = null;

        // Fases da respira√ß√£o SOS
        const sosBreathingPhases = [
          { name: 'Inspire', duration: 4000, text: 'Inspire (4s)...' },
          { name: 'Segure', duration: 7000, text: 'Segure (7s)...' },
          { name: 'Expire', duration: 8000, text: 'Expire (8s)...' }
        ];

        function activateSOS() {
          document.getElementById('sosModal').classList.remove('hidden');
          if (navigator.vibrate) navigator.vibrate(200);
          startSOSBreathing();
        }

        function closeSOS() {
          document.getElementById('sosModal').classList.add('hidden');
          stopSOSBreathing();
        }

        // Iniciar respira√ß√£o SOS com um √∫nico loop de tempo
        function startSOSBreathing() {
          // Cancelar qualquer anima√ß√£o em andamento
          if (sosAnimationFrameId) {
            cancelAnimationFrame(sosAnimationFrameId);
          }
          
          // Resetar vari√°veis
          sosStartTime = null;
          sosPreviousPhase = null;
          
          // Iniciar o loop de anima√ß√£o
          sosAnimationFrameId = requestAnimationFrame(sosBreathingLoop);
        }

        // Parar respira√ß√£o SOS e limpar todos os recursos
        function stopSOSBreathing() {
          if (sosAnimationFrameId) {
            cancelAnimationFrame(sosAnimationFrameId);
            sosAnimationFrameId = null;
          }
          sosStartTime = null;
          sosPreviousPhase = null;
        }

        // Loop principal de respira√ß√£o SOS usando requestAnimationFrame
        function sosBreathingLoop(timestamp) {
          if (!sosStartTime) {
            sosStartTime = timestamp;
          }
          
          const elapsed = timestamp - sosStartTime;
          const totalCycleDuration = sosBreathingPhases.reduce((sum, phase) => sum + phase.duration, 0);
          const timeInCycle = elapsed % totalCycleDuration;
          
          // Determinar a fase atual com base no tempo
          let accumulated = 0;
          let currentPhase = null;
          let timeRemainingInPhase = 0;
          
          for (let i = 0; i < sosBreathingPhases.length; i++) {
            accumulated += sosBreathingPhases[i].duration;
            if (timeInCycle < accumulated) {
              currentPhase = sosBreathingPhases[i];
              timeRemainingInPhase = accumulated - timeInCycle;
              break;
            }
          }
          
          // Atualizar UI com base na fase atual
          updateSOSUI(currentPhase, timeRemainingInPhase);
          
          // Continuar o loop
          sosAnimationFrameId = requestAnimationFrame(sosBreathingLoop);
        }

        // Atualizar interface do usu√°rio com base na fase atual
        function updateSOSUI(phase, timeRemaining) {
          const instruction = document.getElementById('breathingInstruction');
          const circle = document.getElementById('breathingCircle');
          
          if (!instruction || !circle) return;
          
          // Atualizar texto de instru√ß√£o
          instruction.textContent = phase.text;
          
          // Calcular progresso da fase (0 a 1)
          const phaseDuration = phase.duration;
          const progress = 1 - (timeRemaining / phaseDuration);
          
          // Atualizar timer no c√≠rculo
          const secondsLeft = Math.ceil(timeRemaining / 1000);
          if (!circle.querySelector('#sosTimer')) {
            circle.innerHTML = '<div id="sosTimer" class="text-calm-bg font-bold text-2xl flex items-center justify-center w-full h-full"></div>';
          }
          document.getElementById('sosTimer').textContent = secondsLeft;
          
          // Aplicar transforma√ß√µes visuais com base na fase
          circle.style.transition = 'transform 0.1s ease-out';
          
          switch(phase.name) {
            case 'Inspire':
              // Escalar para cima durante inspira√ß√£o
              const inspireScale = 1 + (progress * 0.5); // Escala de 1 a 1.5
              circle.style.transform = `scale(${inspireScale})`;
              circle.className = 'mx-auto w-24 h-24 rounded-full bg-red-200 my-6 flex items-center justify-center';
              break;
              
            case 'Segure':
              // Manter tamanho constante e pulsar suavemente
              circle.style.transform = 'scale(1.5)';
              circle.className = 'mx-auto w-24 h-24 rounded-full bg-red-200 animate-pulse my-6 flex items-center justify-center';
              break;
              
            case 'Expire':
              // Escalar para baixo durante expira√ß√£o
              const expireScale = 1.5 - (progress * 0.5); // Escala de 1.5 a 1
              circle.style.transform = `scale(${expireScale})`;
              circle.className = 'mx-auto w-24 h-24 rounded-full bg-red-200 my-6 flex items-center justify-center';
              break;
          }
          
          // Sincronizar √°udio se necess√°rio (chamado apenas quando a fase muda)
          if (sosPreviousPhase !== phase.name) {
            sosSpeakInstruction(phase.name);
            sosPreviousPhase = phase.name;
          }
        }

        // Fun√ß√£o para falar instru√ß√µes de forma s√≠ncrona
        function sosSpeakInstruction(text) {
          // Esta fun√ß√£o pode ser expandida para incluir √°udio se necess√°rio
          // Por enquanto, estamos apenas sincronizando a UI
          console.log('SOS Phase:', text);
        }

// T√©cnica de Ancoragem 5-4-3-2-1
function startGrounding() {
  // Close the SOS modal first
  closeSOS();
  
  // Create a new modal for the grounding technique
  const groundingModal = document.createElement('div');
  groundingModal.id = 'groundingModal';
  groundingModal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
  
  // Steps for the 5-4-3-2-1 technique
  const groundingSteps = [
    { title: 'T√©cnica 5-4-3-2-1', instruction: 'Nome 5 coisas que voc√™ pode ver', count: 5 },
    { title: 'T√©cnica 4-3-2-1', instruction: 'Nome 4 coisas que voc√™ pode tocar', count: 4 },
    { title: 'T√©cnica 3-2-1', instruction: 'Nome 3 coisas que voc√™ pode ouvir', count: 3 },
    { title: 'T√©cnica 2-1', instruction: 'Nome 2 coisas que voc√™ pode cheirar', count: 2 },
    { title: 'T√©cnica Final', instruction: 'Nome 1 coisa que voc√™ pode saborear', count: 1 }
  ];
  
  let currentStep = 0;
  
  function updateGroundingStep() {
    const step = groundingSteps[currentStep];
    let dotsHtml = '';
    for (let i = 0; i < 5; i++) {
      if (i < step.count) {
        dotsHtml += `<span class="w-3 h-3 bg-blue-500 rounded-full inline-block mr-1"></span>`;
      } else {
        dotsHtml += `<span class="w-3 h-3 bg-gray-300 rounded-full inline-block mr-1"></span>`;
      }
    }
    
    groundingModal.innerHTML = `
      <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-2xl font-bold text-blue-600 text-center mb-4">${step.title}</h2>
        <p class="text-gray-700 text-center mb-6">${step.instruction}</p>
        <div class="flex justify-center space-x-2 mb-6">
          ${dotsHtml}
        </div>
        <div class="flex justify-between">
          <button onclick="closeGrounding()" class="py-2 px-4 bg-gray-300 rounded-lg">Fechar</button>
          <button onclick="nextGroundingStep()" class="py-2 px-4 bg-blue-500 text-white rounded-lg">
            ${currentStep < groundingSteps.length - 1 ? 'Pr√≥ximo' : 'Concluir'}
          </button>
        </div>
      </div>
    `;
  }
  
  window.nextGroundingStep = function() {
    if (currentStep < groundingSteps.length - 1) {
      currentStep++;
      updateGroundingStep();
    } else {
      // This is the last step, show completion message
      groundingModal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl text-center">
          <h2 class="text-2xl font-bold text-blue-600 mb-4">T√©cnica Conclu√≠da!</h2>
          <p class="text-gray-700 mb-6">Parab√©ns! Voc√™ completou a t√©cnica de ancoragem 5-4-3-2-1.</p>
          <button onclick="closeGrounding()" class="py-2 px-4 bg-blue-500 text-white rounded-lg">Fechar</button>
        </div>
      `;
    }
  };
  
  window.closeGrounding = function() {
    document.body.removeChild(groundingModal);
  };
  
  document.body.appendChild(groundingModal);
  updateGroundingStep();
}

function closeGrounding() {
  const groundingModal = document.getElementById('groundingModal');
  if (groundingModal) {
    groundingModal.remove();
  }
  // Remove the global functions
  delete window.nextGroundingStep;
  delete window.closeGrounding;
}

// Clean up duplicate/incorrect code
// The following functions were duplicated or incorrect, so we're removing them
// function openSOS() { ... }
// function closeSOS() { ... } (duplicate)

// Contatos personalizados
function addContact() {
  const name = prompt('Nome do contato:');
  const phone = prompt('N√∫mero (com DDD):');
  if (!name || !phone) return;

  const contacts = JSON.parse(localStorage.getItem('sosContacts') || '[]');
  contacts.push({ name, phone });
  localStorage.setItem('sosContacts', JSON.stringify(contacts));
  renderContacts();
}

function renderContacts() {
  const div = document.getElementById('customContacts');
  const contacts = JSON.parse(localStorage.getItem('sosContacts') || '[]');
  div.innerHTML = contacts.map(c =>
    `<a href="tel:${c.phone}" class="block bg-green-500 text-white py-2 rounded-lg mt-2">${c.name}</a>`
  ).join('');
}

// Render contacts when the page loads
document.addEventListener('DOMContentLoaded', function() {
  renderContacts();
});

        // ==========================================
        // FIM DO SISTEMA SOS
        // ==========================================

        // IndexedDB setup
        let db;
        const DB_NAME = 'CalmMindDB';
        const DB_VERSION = 2;

        const initDB = async () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('Failed to open database:', request.error);
                    reject(request.error);
                };
                request.onsuccess = () => {
                    db = request.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    console.log('Database upgrade needed');
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('moodEntries')) {
                        const moodStore = db.createObjectStore('moodEntries', { keyPath: 'id', autoIncrement: true });
                        moodStore.createIndex('date', 'date', { unique: false });
                        console.log('Created moodEntries store');
                    }
                    
                    if (!db.objectStoreNames.contains('diaryEntries')) {
                        const diaryStore = db.createObjectStore('diaryEntries', { keyPath: 'id', autoIncrement: true });
                        diaryStore.createIndex('date', 'date', { unique: false });
                        console.log('Created diaryEntries store');
                    }
                    
                    if (!db.objectStoreNames.contains('breathingSessions')) {
                        const breathingStore = db.createObjectStore('breathingSessions', { keyPath: 'id', autoIncrement: true });
                        breathingStore.createIndex('date', 'date', { unique: false });
                        console.log('Created breathingSessions store');
                    }
                    
                    if (!db.objectStoreNames.contains('sleepEntries')) {
                        const sleepStore = db.createObjectStore('sleepEntries', { keyPath: 'id', autoIncrement: true });
                        sleepStore.createIndex('date', 'date', { unique: false });
                        sleepStore.createIndex('quality', 'quality', { unique: false });
                        console.log('Created sleepEntries store');
                    }
                };
            });
        };

        const saveToStore = async (storeName, data) => {
            try {
                if (!db) {
                    console.error('Database not initialized');
                    throw new Error('Database not initialized');
                }
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.add(data);
                    request.onsuccess = () => {
                        console.log('Record saved successfully:', data);
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        console.error('Error saving record:', request.error);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Error in saveToStore:', error);
                throw error;
            }
        };

        const getAllFromStore = async (storeName) => {
            try {
                if (!db) {
                    console.error('Database not initialized');
                    return [];
                }
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => {
                        console.log(`Retrieved ${request.result.length} records from ${storeName}`);
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        console.error('Error retrieving records:', request.error);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Error in getAllFromStore:', error);
                return [];
            }
        };

        const showSection = (sectionName) => {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-calm-blue');
                btn.classList.add('text-gray-400');
            });
            
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('bg-calm-blue');
            document.querySelector(`[data-section="${sectionName}"]`).classList.remove('text-gray-400');
            
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'diary') {
                loadDiaryEntries();
            } else if (sectionName === 'sleep') {
                loadSleepHistory();
                updateSleepInsights();
            }
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        };

        const saveMoodEntry = async () => {
            const selectedMood = document.querySelector('.mood-btn.selected');
            if (!selectedMood) {
                showToast('Por favor, selecione seu humor');
                return;
            }

            const moodValue = parseInt(selectedMood.dataset.mood);
            const anxietyLevel = document.getElementById('anxietyLevel').value;
            const notes = document.getElementById('moodNotes').value;

            const moodEntry = {
                date: new Date().toISOString(),
                mood: moodValue,
                anxiety: parseInt(anxietyLevel),
                notes: notes,
                timestamp: Date.now()
            };

            try {
                await saveToStore('moodEntries', moodEntry);
                showToast('Humor registrado com sucesso!');
                
                document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected', 'bg-calm-lavender'));
                document.getElementById('anxietyLevel').value = 5;
                document.getElementById('moodNotes').value = '';
                
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar registro');
                console.error('Error saving mood entry:', error);
            }
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('mood-btn')) {
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.remove('selected', 'bg-calm-lavender');
                });
                e.target.classList.add('selected', 'bg-calm-lavender');
            }
        });

        let currentExercise = null;
        let audioContext = null;
        let audioEnabled = false;
        let synth = window.speechSynthesis;
        let speakingInstructions = false;
        
        // Vari√°veis para o controle do exerc√≠cio de respira√ß√£o
        let mainStartTime = null;
        let mainPreviousPhase = null;
        let mainCurrentPhase = null;
        let mainCurrentCycle = 0;
        let mainExerciseStartTime = null;
        let isBreathingExerciseActive = false;

        // Inicializa o contexto de √°udio
        const initAudioContext = () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        };

        // Toggle do guia de √°udio
        const toggleAudioGuide = () => {
            audioEnabled = !audioEnabled;
            const audioIcon = document.getElementById('audioIcon');
            const audioToggle = document.getElementById('audioToggle');
            
            if (audioEnabled) {
                audioIcon.textContent = 'üîä';
                audioToggle.classList.add('bg-calm-blue/20');
                initAudioContext();
                showToast('√Åudio guiado ativado');
            } else {
                audioIcon.textContent = 'üîà';
                audioToggle.classList.remove('bg-calm-blue/20');
                if (synth.speaking) {
                    synth.cancel();
                }
                showToast('√Åudio guiado desativado');
            }
        };

        // Fun√ß√£o para reproduzir tons de metr√¥nomo
        const playTone = (frequency, duration) => {
            if (!audioEnabled || !audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;

            gainNode.gain.setValueAtTime(0.6, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        };

        // Fun√ß√£o para falar instru√ß√µes
        const speakInstruction = (text) => {
            if (!audioEnabled || speakingInstructions) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.volume = 0.8;
            utterance.rate = 1;
            utterance.pitch = 1;

            utterance.onstart = () => {
                speakingInstructions = true;
            };

            utterance.onend = () => {
                speakingInstructions = false;
            };

            synth.speak(utterance);
        };

        const breathingExercises = {
            '478': {
                name: '4-7-8 Relaxamento',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo pelo nariz' },
                    { name: 'Segure', duration: 7, instruction: 'Mantenha o ar nos pulm√µes' },
                    { name: 'Expire', duration: 8, instruction: 'Solte o ar pela boca devagar' },
                    { name: 'Pause', duration: 1, instruction: 'Pequena pausa' }
                ],
                totalCycles: 4
            },
            'box': {
                name: 'Box Breathing',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo pelo nariz' },
                    { name: 'Segure', duration: 4, instruction: 'Mantenha o ar nos pulm√µes' },
                    { name: 'Expire', duration: 4, instruction: 'Solte o ar devagar' },
                    { name: 'Segure', duration: 4, instruction: 'Pulm√µes vazios, aguarde' }
                ],
                totalCycles: 5
            },
            'simple': {
                name: 'Respira√ß√£o Simples',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo e calmo' },
                    { name: 'Expire', duration: 6, instruction: 'Solte o ar devagar' }
                ],
                totalCycles: 6
            }
        };

        function clearAllTimers() {
            // Remover o subscriber do rel√≥gio mestre se estiver ativo
            if (isBreathingExerciseActive) {
                masterClock.unsubscribe(breathingClockCallback);
                isBreathingExerciseActive = false;
            }
        }

        const startBreathing = (exerciseType) => {
            clearAllTimers();
            
            currentExercise = breathingExercises[exerciseType];

            // Resetar vari√°veis de anima√ß√£o
            mainStartTime = null;
            mainPreviousPhase = null;
            mainCurrentPhase = null;
            mainCurrentCycle = 1;
            mainExerciseStartTime = null;
            
            document.getElementById('exerciseTitle').textContent = currentExercise.name;
            document.getElementById('breathingModal').classList.remove('hidden');
            
            startBreathingCountdown();
        };

        const startBreathingCountdown = () => {
            clearAllTimers();
            
            let countdown = 3;
            const timerElement = document.getElementById('timerText');
            const instructionElement = document.getElementById('instructionText');
            
            instructionElement.textContent = 'Prepare-se...';
            timerElement.textContent = countdown;
            
            if (audioEnabled) {
                speakInstruction('Prepare-se para come√ßar o exerc√≠cio de respira√ß√£o');
            }
            
            const countdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    timerElement.textContent = countdown;
                    if (audioEnabled) {
                        playTone(440, 0.1); // Nota L√° (A4) para contagem regressiva
                    }
                } else if (countdown === 0) {
                    timerElement.textContent = 'Vamos come√ßar!';
                    if (audioEnabled) {
                        playTone(880, 0.2); // Nota L√° uma oitava acima para in√≠cio
                        speakInstruction('Vamos come√ßar!');
                    }
                } else {
                    clearInterval(countdownTimer);
                    runBreathingPhase();
                }
            }, 1000);
        };

        const runBreathingPhase = () => {
            clearAllTimers();
            
            // Registrar o callback no rel√≥gio mestre
            masterClock.subscribe(breathingClockCallback);
            isBreathingExerciseActive = true;
            masterClock.start();
        };
        
        // Callback para o rel√≥gio mestre
        const breathingClockCallback = (elapsed) => {
            if (!mainExerciseStartTime) {
                mainExerciseStartTime = performance.now();
            }
            
            if (!mainStartTime) {
                mainStartTime = performance.now();
            }
            
            const timestamp = performance.now();
            const elapsedTime = timestamp - mainStartTime;
            const totalCycleDuration = currentExercise.phases.reduce((sum, phase) => sum + (phase.duration * 1000), 0);
            const timeInCycle = elapsedTime % totalCycleDuration;
            
            // Determinar a fase atual com base no tempo
            let accumulated = 0;
            let currentPhase = null;
            let timeRemainingInPhase = 0;
            
            for (let i = 0; i < currentExercise.phases.length; i++) {
                accumulated += currentExercise.phases[i].duration * 1000;
                if (timeInCycle < accumulated) {
                    currentPhase = currentExercise.phases[i];
                    timeRemainingInPhase = accumulated - timeInCycle;
                    break;
                }
            }
            
            // Atualizar UI com base na fase atual
            if (currentPhase) {
                updateMainBreathingUI(currentPhase, timeRemainingInPhase);
            }
        };

        // Loop principal de respira√ß√£o usando requestAnimationFrame
        function mainBreathingLoop(timestamp) {
            if (!mainExerciseStartTime) {
                mainExerciseStartTime = timestamp;
            }
            
            if (!mainStartTime) {
                mainStartTime = timestamp;
            }
            
            const elapsed = timestamp - mainStartTime;
            const totalCycleDuration = currentExercise.phases.reduce((sum, phase) => sum + (phase.duration * 1000), 0);
            const timeInCycle = elapsed % totalCycleDuration;
            
            // Determinar a fase atual com base no tempo
            let accumulated = 0;
            let currentPhase = null;
            let timeRemainingInPhase = 0;
            
            for (let i = 0; i < currentExercise.phases.length; i++) {
                accumulated += currentExercise.phases[i].duration * 1000;
                if (timeInCycle < accumulated) {
                    currentPhase = currentExercise.phases[i];
                    timeRemainingInPhase = accumulated - timeInCycle;
                    break;
                }
            }
            
            // Atualizar UI com base na fase atual
            if (currentPhase) {
                updateMainBreathingUI(currentPhase, timeRemainingInPhase);
            }
            
            // Continuar o loop
            mainAnimationFrameId = requestAnimationFrame(mainBreathingLoop);
        }

        // Atualizar interface do usu√°rio com base na fase atual
        function updateMainBreathingUI(phase, timeRemaining) {
            // Atualizar texto de instru√ß√£o
            document.getElementById('instructionText').textContent = phase.instruction;
            document.getElementById('breathingText').textContent = phase.name;
            
            // Calcular progresso da fase (0 a 1)
            const phaseDuration = phase.duration * 1000;
            const progress = 1 - (timeRemaining / phaseDuration);
            
            // Atualizar timer
            const secondsLeft = Math.ceil(timeRemaining / 1000);
            document.getElementById('timerText').textContent = secondsLeft;
            
            const circle = document.getElementById('breathingCircle');
            circle.className = 'w-32 h-32 mx-auto bg-gradient-to-br from-calm-mint to-calm-lavender rounded-full flex items-center justify-center text-calm-bg font-bold text-lg transition-transform duration-1000 shadow-lg';
            
            // Aplicar transforma√ß√µes visuais com base na fase
            circle.style.transition = 'transform 0.1s ease-out';
            
            switch(phase.name) {
                case 'Inspire':
                    // Escalar para cima durante inspira√ß√£o
                    const inspireScale = 1 + (progress * 0.3); // Escala de 1 a 1.3
                    circle.style.transform = `scale(${inspireScale})`;
                    circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
                    break;
                    
                case 'Expire':
                    // Escalar para baixo durante expira√ß√£o
                    const expireScale = 1.3 - (progress * 0.3); // Escala de 1.3 a 1
                    circle.style.transform = `scale(${expireScale})`;
                    circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
                    break;
                    
                case 'Segure':
                case 'Pause':
                    // Manter tamanho constante e pulsar suavemente
                    circle.style.transform = 'scale(1.15)';
                    circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
                    circle.classList.add('animate-pulse-gentle');
                    break;
            }
            
            // Sincronizar √°udio se necess√°rio (chamado apenas quando a fase muda)
            if (mainPreviousPhase !== phase.name) {
                if (audioEnabled) {
                    speakInstruction(phase.instruction);
                    
                    // Tons diferentes para cada fase
                    switch(phase.name) {
                        case 'Inspire':
                            playTone(523.25, 0.2); // D√≥ (C5) para inspira√ß√£o
                            break;
                        case 'Expire':
                            playTone(261.63, 0.2); // D√≥ (C4) para expira√ß√£o
                            break;
                        case 'Segure':
                            playTone(392.00, 0.2); // Sol (G4) para segurar
                            break;
                        case 'Pause':
                            playTone(329.63, 0.2); // Mi (E4) para pausa
                            break;
                    }
                }
                mainPreviousPhase = phase.name;
            }
        }

        const nextBreathingPhase = () => {
            // Esta fun√ß√£o n√£o √© mais necess√°ria com o novo sistema de tempo √∫nico
            // O loop principal j√° cuida da transi√ß√£o entre fases
            
            // Verificar se completamos todos os ciclos
            const elapsed = Date.now() - mainExerciseStartTime;
            const cycleDuration = currentExercise.phases.reduce((sum, phase) => sum + phase.duration, 0) * 1000;
            const currentCycle = Math.floor(elapsed / cycleDuration) + 1;
            
            if (currentCycle > currentExercise.totalCycles) {
                completeBreathingExercise();
                return;
            }
        };

        const completeBreathingExercise = async () => {
            clearAllTimers();
            
            const session = {
                date: new Date().toISOString(),
                exercise: currentExercise.name,
                duration: currentExercise.totalCycles * currentExercise.phases.reduce((sum, phase) => sum + phase.duration, 0),
                completed: true,
                timestamp: Date.now()
            };
            
            try {
                await saveToStore('breathingSessions', session);
            } catch (error) {
                console.error('Error saving breathing session:', error);
            }
            
            document.getElementById('instructionText').textContent = 'Exerc√≠cio conclu√≠do! üéâ';
            document.getElementById('timerText').textContent = '‚úì';
            document.getElementById('breathingText').textContent = 'Parab√©ns!';
            
            if (audioEnabled) {
                // Toca uma sequ√™ncia de notas alegre para indicar conclus√£o
                setTimeout(() => playTone(523.25, 0.15), 0);    // D√≥ (C5)
                setTimeout(() => playTone(659.25, 0.15), 200);  // Mi (E5)
                setTimeout(() => playTone(783.99, 0.15), 400);  // Sol (G5)
                setTimeout(() => playTone(1046.50, 0.3), 600);  // D√≥ (C6)
                
                speakInstruction('Parab√©ns! Voc√™ completou o exerc√≠cio de respira√ß√£o!');
            }
            
            setTimeout(() => {
                document.getElementById('breathingModal').classList.add('hidden');
                showToast('Exerc√≠cio de respira√ß√£o conclu√≠do!');
                updateDashboard();
            }, 3000);
        };

        const stopBreathing = () => {
            clearAllTimers();
            
            document.getElementById('breathingModal').classList.add('hidden');
            const circle = document.getElementById('breathingCircle');
            circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
            circle.style.transform = 'scale(1)';
        };

        const saveDiaryEntry = async () => {
            const title = document.getElementById('diaryTitle').value;
            const content = document.getElementById('diaryEntry').value;
            const tags = document.getElementById('diaryTags').value;
            
            if (!content.trim()) {
                showToast('Por favor, escreva algo no di√°rio');
                return;
            }

            const diaryEntry = {
                date: new Date().toISOString(),
                title: title || `Entrada de ${new Date().toLocaleDateString('pt-BR')}`,
                content: content,
                tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                timestamp: Date.now()
            };

            try {
                await saveToStore('diaryEntries', diaryEntry);
                showToast('Entrada do di√°rio salva!');
                
                document.getElementById('diaryTitle').value = '';
                document.getElementById('diaryEntry').value = '';
                document.getElementById('diaryTags').value = '';
                
                loadDiaryEntries();
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar entrada');
                console.error('Error saving diary entry:', error);
            }
        };

        const loadDiaryEntries = async () => {
            try {
                const entries = await getAllFromStore('diaryEntries');
                const container = document.getElementById('diaryEntries');
                
                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhuma entrada ainda. Comece escrevendo sobre seu dia!</p>';
                    return;
                }
                
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.map(entry => {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const preview = entry.content.length > 150 
                        ? entry.content.substring(0, 150) + '...' 
                        : entry.content;
                    
                    const tagsHtml = entry.tags.length > 0 
                        ? entry.tags.map(tag => `<span class="bg-calm-lavender/30 text-calm-lavender text-xs px-2 py-1 rounded-full">${tag}</span>`).join(' ')
                        : '';
                    
                    return `
                        <div class="bg-calm-bg p-4 rounded-lg border border-calm-sand/20">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-white">${entry.title}</h4>
                                <span class="text-xs text-gray-400">${date}</span>
                            </div>
                            <p class="text-gray-300 text-sm mb-3">${preview}</p>
                            ${tagsHtml ? `<div class="flex flex-wrap gap-2 mb-2">${tagsHtml}</div>` : ''}
                            <button onclick="viewDiaryEntry(${entry.id})" class="text-calm-blue text-sm hover:text-calm-mint transition-colors">
                                üìñ Ler completo
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading diary entries:', error);
            }
        };

        const viewDiaryEntry = async (entryId) => {
            try {
                const entries = await getAllFromStore('diaryEntries');
                const entry = entries.find(e => e.id === entryId);
                
                if (entry) {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const tagsHtml = entry.tags.length > 0 
                        ? entry.tags.map(tag => `<span class="bg-calm-lavender/30 text-calm-lavender text-xs px-2 py-1 rounded-full">${tag}</span>`).join(' ')
                        : '';
                    
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
                    modal.innerHTML = `
                        <div class="bg-calm-card p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-calm-blue/30">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-semibold text-calm-blue">${entry.title}</h3>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <p class="text-sm text-gray-400 mb-4">${date}</p>
                            ${tagsHtml ? `<div class="flex flex-wrap gap-2 mb-4">${tagsHtml}</div>` : ''}
                            <div class="text-gray-300 whitespace-pre-wrap">${entry.content}</div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Error viewing diary entry:', error);
            }
        };

        const updateDashboard = async () => {
            try {
                const [moodEntries, diaryEntries, breathingSessions, sleepEntries] = await Promise.all([
                    getAllFromStore('moodEntries'),
                    getAllFromStore('diaryEntries'),
                    getAllFromStore('breathingSessions'),
                    getAllFromStore('sleepEntries')
                ]);
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                // Update mood stats
                const monthlyMoodEntries = moodEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                });
                
                document.getElementById('monthlyRecords').textContent = monthlyMoodEntries.length;
                document.getElementById('exercisesCount').textContent = breathingSessions.length;
                
                updateMoodChart(moodEntries);
                updateRecentEntries(moodEntries, diaryEntries);
                
                // Update sleep statistics
                if (sleepEntries.length === 0) {
                    ['avgSleepHours', 'sleepQuality', 'sleepStreak'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = '-';
                    });
                    return;
                }
                
                // Average duration
                const avgDuration = sleepEntries.reduce((sum, entry) => 
                    sum + parseFloat(entry.duration), 0) / sleepEntries.length;
                document.getElementById('avgSleepHours').textContent = avgDuration.toFixed(1) + 'h';
                
                // Quality emoji
                const avgQuality = sleepEntries.reduce((sum, entry) => sum + entry.quality, 0) / sleepEntries.length;
                const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                document.getElementById('sleepQuality').textContent = qualityEmojis[Math.round(avgQuality) - 1];

                // Count sleep records in the current month
                const monthlyRecords = sleepEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                }).length;
                
                document.getElementById('sleepStreak').textContent = monthlyRecords;
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        };

        const updateMoodChart = (moodEntries) => {
            const chartContainer = document.getElementById('moodChart');
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                last7Days.push(date);
            }
            
            const chartData = last7Days.map(date => {
                const dayEntries = moodEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    entryDate.setHours(0, 0, 0, 0);
                    return entryDate.getTime() === date.getTime();
                });
                
                const avgMood = dayEntries.length > 0 
                    ? dayEntries.reduce((sum, entry) => sum + entry.mood, 0) / dayEntries.length 
                    : 0;
                
                return {
                    date: date.getDate(),
                    mood: avgMood,
                    hasData: dayEntries.length > 0
                };
            });
            
            chartContainer.innerHTML = chartData.map(day => {
                const height = day.hasData ? (day.mood / 5) * 100 : 10;
                const color = day.hasData ? getColorForMood(day.mood) : 'bg-gray-600';
                
                return `
                    <div class="flex flex-col items-center">
                        <div class="w-8 ${color} rounded-t" style="height: ${height}px; min-height: 10px;"></div>
                        <span class="text-xs text-gray-400 mt-2">${day.date}</span>
                    </div>
                `;
            }).join('');
        };

        const getColorForMood = (mood) => {
            if (mood <= 2) return 'bg-red-300';
            if (mood <= 3) return 'bg-calm-sand';
            if (mood <= 4) return 'bg-calm-mint';
            return 'bg-calm-green';
        };

        const getMoodEmoji = (mood) => {
            switch(mood) {
                case 1: return 'üò∞';
                case 2: return 'üòû';
                case 3: return 'üòê';
                case 4: return 'üòä';
                case 5: return 'üòÑ';
                default: return 'üòê';
            }
        };

        const updateRecentEntries = (moodEntries, diaryEntries) => {
            const container = document.getElementById('recentEntries');
            
            const allEntries = [
                ...moodEntries.map(entry => ({ ...entry, type: 'mood' })),
                ...diaryEntries.map(entry => ({ ...entry, type: 'diary' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if (allEntries.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum registro ainda. Comece registrando seu humor!</p>';
                return;
            }
            
            container.innerHTML = allEntries.map(entry => {
                const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                if (entry.type === 'mood') {
                    return `
                        <div class="flex items-center justify-between p-3 bg-calm-bg rounded-lg border border-calm-blue/20">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${getMoodEmoji(entry.mood)}</span>
                                <div>
                                    <p class="font-medium">Registro de humor</p>
                                    <p class="text-xs text-gray-400">Ansiedade: ${entry.anxiety}/10</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex items-center justify-between p-3 bg-calm-bg rounded-lg border border-calm-sand/20">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">‚úçÔ∏è</span>
                                <div>
                                    <p class="font-medium">${entry.title}</p>
                                    <p class="text-xs text-gray-400">${entry.content.substring(0, 50)}...</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                    `;
                }
            }).join('');
        };

        let swRegistration = null;
        let deferredPrompt;

        const registerServiceWorker = async () => {
            if ('serviceWorker' in navigator) {
                try {
                    swRegistration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    console.log('‚úÖ Service Worker registered successfully');

                    swRegistration.addEventListener('updatefound', () => {
                        const newWorker = swRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });

                    if ('sync' in window.ServiceWorkerRegistration.prototype) {
                        setupBackgroundSync();
                    }

                    if ('Notification' in window && 'PushManager' in window) {
                        setupPushNotifications();
                    }

                } catch (error) {
                    console.log('‚ùå Service Worker registration failed:', error);
                }
            }
        };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            const installBtn = document.getElementById('installBtn');
            installBtn.classList.remove('hidden');
            console.log('PWA install prompt available');
        });

        const promptInstall = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    showToast('App instalado com sucesso! üéâ');
                    document.getElementById('installBtn').classList.add('hidden');
                } else {
                    showToast('Instala√ß√£o cancelada');
                }

                deferredPrompt = null;
                return;
            }

            showToast('Instala√ß√£o n√£o dispon√≠vel neste contexto.');
            const info = document.createElement('div');
            info.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-calm-card text-gray-200 px-4 py-2 rounded shadow-lg z-50 border border-calm-blue/30';
            info.innerHTML = `
                <div class="text-sm">Para testar a instala√ß√£o: sirva o site via <strong>localhost</strong> (HTTPS) e abra no navegador. Em muitos navegadores, o prompt aparece automaticamente. No iOS, use "Adicionar √† Tela de In√≠cio" no menu de compartilhamento.</div>
                <div class="text-xs text-gray-400 mt-1">Fechar em 8s</div>
            `;
            document.body.appendChild(info);
            setTimeout(() => info.remove(), 8000);
        };

        const showUpdateNotification = () => {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'fixed top-0 left-0 right-0 bg-calm-blue text-white p-3 text-center z-50';
            updateBanner.innerHTML = `
                <p class="mb-2">Nova vers√£o dispon√≠vel!</p>
                <button onclick="applyUpdate()" class="bg-white text-calm-blue px-4 py-1 rounded text-sm mr-2">
                    Atualizar
                </button>
                <button onclick="this.parentElement.remove()" class="text-white text-sm">
                    Depois
                </button>
            `;
            document.body.appendChild(updateBanner);
        };

        const applyUpdate = async () => {
            if (swRegistration && swRegistration.waiting) {
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            }
        };

        const setupBackgroundSync = () => {
            navigator.serviceWorker.ready.then(registration => {
                console.log('üîÑ Background Sync ready');
            });
        };

        const setupPushNotifications = async () => {
            if (Notification.permission === 'default') {
                console.log('üîî Push notifications available');
            }
        };

        const requestNotificationPermission = async () => {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    showToast('Notifica√ß√µes ativadas! üîî');
                    scheduleWellnessReminders();
                } else {
                    showToast('Notifica√ß√µes negadas');
                }

                return permission;
            }
        };

        const scheduleWellnessReminders = () => {
            setInterval(() => {
                if (Notification.permission === 'granted') {
                    new Notification('Calm Mind - Lembrete', {
                        body: 'Que tal registrar como voc√™ est√° se sentindo hoje? üòä',
                        icon: '/icon-192.png',
                        tag: 'daily-mood-reminder'
                    });
                }
            }, 24 * 60 * 60 * 1000);
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('üí¨ Message from SW:', event.data);

                switch (event.data.type) {
                    case 'SYNC_COMPLETE':
                        showToast(`Dados sincronizados: ${event.data.data}`);
                        break;

                    case 'CACHE_UPDATED':
                        console.log('üì¶ Cache updated');
                        break;
                }
            });
        }

        // Sleep tracking state
        let currentSleepQuality = 0;

        function updateSleepDuration() {
            const sleepTime = document.getElementById('sleepTime').value;
            const wakeTime = document.getElementById('wakeTime').value;
            
            if (!sleepTime || !wakeTime) return;
            
            const sleepDate = new Date(sleepTime);
            const wakeDate = new Date(wakeTime);
            
            // If wake time is before sleep time, assume it's the next day
            let duration;
            if (wakeDate < sleepDate) {
                const wakeDateNextDay = new Date(wakeDate);
                wakeDateNextDay.setDate(wakeDateNextDay.getDate() + 1);
                duration = (wakeDateNextDay - sleepDate) / (1000 * 60 * 60);
            } else {
                duration = (wakeDate - sleepDate) / (1000 * 60 * 60);
            }
            
            return duration;
        }

        function setSleepQuality(quality) {
            currentSleepQuality = quality;
            document.querySelectorAll('.sleep-quality-btn').forEach(btn => {
                btn.classList.remove('bg-calm-blue/20', 'selected');
            });
            const selectedBtn = document.querySelector(`button[onclick="setSleepQuality(${quality})"]`);
            selectedBtn.classList.add('bg-calm-blue/20', 'selected');
            
            // Add haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        async function saveSleepEntry() {
            const sleepTime = document.getElementById('sleepTime').value;
            const wakeTime = document.getElementById('wakeTime').value;
            const notes = document.getElementById('sleepNotes').value;
            
            if (!sleepTime || !wakeTime) {
                showToast('Por favor, preencha os hor√°rios de dormir e acordar');
                return;
            }
            
            if (currentSleepQuality === 0) {
                showToast('Por favor, selecione a qualidade do sono');
                return;
            }
            
            const duration = updateSleepDuration();
            
            const sleepEntry = {
                date: new Date().toISOString(),
                sleepTime,
                wakeTime,
                duration,
                quality: currentSleepQuality,
                notes,
                timestamp: Date.now()
            };
            
            try {
                await saveToStore('sleepEntries', sleepEntry);
                showToast('Registro de sono salvo com sucesso!');
                
                document.getElementById('sleepTime').value = '';
                document.getElementById('wakeTime').value = '';
                document.getElementById('sleepNotes').value = '';
                currentSleepQuality = 0;
                document.querySelectorAll('.sleep-quality-btn').forEach(btn => {
                    btn.classList.remove('bg-calm-blue/20');
                });
                
                loadSleepHistory();
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar registro de sono');
                console.error('Error saving sleep entry:', error);
            }
        }

        async function loadSleepHistory() {
            try {
                const entries = await getAllFromStore('sleepEntries');
                const container = document.getElementById('sleepHistory');
                
                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum registro de sono ainda.</p>';
                    return;
                }
                
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.slice(0, 7).map(entry => {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                    
                    return `
                        <div class="bg-calm-bg p-4 rounded-xl flex items-center gap-4">
                            <div class="text-2xl">${qualityEmojis[entry.quality - 1]}</div>
                            <div class="flex-1">
                                <div class="font-semibold">${date}</div>
                                <div class="text-sm text-gray-400">
                                    ${entry.sleepTime} - ${entry.wakeTime} (${entry.duration.toFixed(1)}h)
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading sleep history:', error);
            }
        }

        // Get sleep records for the last N days
        async function getSleepRecords(days = 7) {
            try {
                if (!db) {
                    await initDB();
                }
                const entries = await getAllFromStore('sleepEntries');
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                return entries.filter(r => new Date(r.date) >= cutoffDate);
            } catch (error) {
                console.error('Error getting sleep records:', error);
                return [];
            }
        }

        // Update sleep insights
        async function updateSleepInsights() {
            try {
                console.log('Updating sleep insights...');
                const records = await getSleepRecords(7);
                console.log('Retrieved records:', records);
                
                if (records.length === 0) {
                    console.log('No records found, setting default values');
                    document.getElementById('avgSleepHours').textContent = '-';
                    document.getElementById('avgSleepHoursInsights').textContent = '-';
                    document.getElementById('sleepRegularity').textContent = '-';
                    document.getElementById('avgSleepQuality').textContent = '-';
                    return;
                }

                // Average hours
                console.log('Sleep records for average calculation:', records);
                const durations = records.map(r => parseFloat(r.duration));
                console.log('Durations:', durations);
                const totalDuration = durations.reduce((sum, duration) => sum + duration, 0);
                console.log('Total duration:', totalDuration);
                const avgHours = totalDuration / records.length;
                console.log('Average hours:', avgHours);
                document.getElementById('avgSleepHours').textContent = avgHours.toFixed(1) + 'h';
                document.getElementById('avgSleepHoursInsights').textContent = avgHours.toFixed(1) + 'h';

                // Average quality
                const avgQuality = records.reduce((sum, r) => sum + r.quality, 0) / records.length;
                console.log('Average quality:', avgQuality);
                const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                document.getElementById('avgSleepQuality').textContent = qualityEmojis[Math.round(avgQuality) - 1];

                // Regularity score
                const sleepTimes = records.map(r => {
                    const time = new Date(r.sleepTime);
                    return time.getHours() + time.getMinutes() / 60;
                });
                
                const avgSleepTime = sleepTimes.reduce((sum, t) => sum + t, 0) / sleepTimes.length;
                const variance = sleepTimes.reduce((sum, t) => sum + Math.pow(t - avgSleepTime, 2), 0) / sleepTimes.length;
                const stdDev = Math.sqrt(variance);
                
                const regularityScore = Math.max(0, Math.min(100, 100 - (stdDev * 20)));
                console.log('Regularity score:', regularityScore);
                document.getElementById('sleepRegularity').textContent = regularityScore.toFixed(0) + '%';
                
                console.log('Sleep insights updated successfully');
            } catch (error) {
                console.error('Error updating sleep insights:', error);
                // Show error state
                document.getElementById('avgSleepHours').textContent = 'Erro';
                document.getElementById('avgSleepHoursInsights').textContent = 'Erro';
                document.getElementById('sleepRegularity').textContent = 'Erro';
                document.getElementById('avgSleepQuality').textContent = 'Erro';
            }
        }

        // Load and display sleep history
        async function loadSleepHistory() {
            try {
                console.log('Loading sleep history...');
                const entries = await getAllFromStore('sleepEntries');
                console.log('Retrieved sleep entries:', entries);
                const container = document.getElementById('sleepHistory');
                
                if (entries.length === 0) {
                    console.log('No sleep entries found');
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-3">üåô</div>
                            <p class="text-gray-400">Nenhum registro de sono ainda.<br>Comece registrando sua primeira noite!</p>
                        </div>
                    `;
                    return;
                }
                
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.slice(0, 7).map(entry => {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const sleepTime = new Date(entry.sleepTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                    const wakeTime = new Date(entry.wakeTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                    const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                    
                    return `
                        <div class="bg-calm-bg p-4 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="text-2xl">${qualityEmojis[entry.quality - 1]}</div>
                                <div>
                                    <div class="font-medium">${date}</div>
                                    <div class="text-sm text-gray-400">${sleepTime} ‚Üí ${wakeTime}</div>
                                </div>
                            </div>
                            <div class="text-lg font-medium text-calm-blue">
                                ${parseFloat(entry.duration).toFixed(1)}h
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Sleep history loaded successfully');
            } catch (error) {
                console.error('Error loading sleep history:', error);
            }
        }

        // Schedule sleep reminders
        function scheduleSleepReminders() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    const sleepEnabled = document.getElementById('sleepReminder').checked;
                    const morningEnabled = document.getElementById('morningReminder').checked;
                    
                    localStorage.setItem('sleepReminderEnabled', sleepEnabled);
                    localStorage.setItem('morningReminderEnabled', morningEnabled);
                    
                    if (sleepEnabled || morningEnabled) {
                        showToast('Lembretes configurados! üîî');
                    }
                });
            }
        }

        // Initialize sleep tracking functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Quality button click handlers
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quality-btn').forEach(b => {
                        b.classList.remove('active', 'bg-calm-blue/20', 'scale-110', 'shadow-lg');
                    });
                    this.classList.add('active', 'bg-calm-blue/20', 'scale-110', 'shadow-lg');
                    document.getElementById('sleepQuality').value = this.dataset.quality;
                    
                    // Add haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                });
            });

            // Sleep form submission
            document.getElementById('sleepForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const sleepTime = new Date(document.getElementById('sleepTime').value);
                const wakeTime = new Date(document.getElementById('wakeTime').value);
                const quality = document.getElementById('sleepQuality').value;

                if (!quality) {
                    showToast('Por favor, selecione a qualidade do sono');
                    return;
                }

                // Calculate duration properly handling overnight sleep
                let duration;
                if (wakeTime < sleepTime) {
                    // If wake time is before sleep time, assume it's the next day
                    const wakeTimeNextDay = new Date(wakeTime);
                    wakeTimeNextDay.setDate(wakeTimeNextDay.getDate() + 1);
                    duration = (wakeTimeNextDay - sleepTime) / (1000 * 60 * 60); // hours
                } else {
                    duration = (wakeTime - sleepTime) / (1000 * 60 * 60); // hours
                }

                try {
                    const sleepEntry = {
                        date: new Date().toISOString(),
                        sleepTime: sleepTime.toISOString(),
                        wakeTime: wakeTime.toISOString(),
                        duration: duration.toFixed(2),
                        quality: parseInt(quality),
                        timestamp: Date.now()
                    };

                    try {
                        await saveToStore('sleepEntries', sleepEntry);
                        showToast('Registro de sono salvo com sucesso! üéâ');
                        
                        // Reset form
                        document.querySelectorAll('.quality-btn').forEach(btn => {
                            btn.classList.remove('active', 'bg-calm-blue/20', 'scale-110', 'shadow-lg');
                        });
                        document.getElementById('sleepQuality').value = '';
                        
                        // Update UI
                        console.log('Updating UI after saving sleep entry');
                        await loadSleepHistory();
                        await updateSleepInsights();
                        await updateDashboard();
                        console.log('UI updated successfully');
                    } catch (error) {
                        showToast('Erro ao salvar registro');
                        console.error('Error saving sleep entry:', error);
                    }
                } catch (error) {
                    showToast('Erro ao salvar registro');
                    console.error('Error creating sleep entry:', error);
                }
            });

            // Load saved reminder preferences
            document.getElementById('sleepReminder').checked = 
                localStorage.getItem('sleepReminderEnabled') === 'true';
            document.getElementById('morningReminder').checked = 
                localStorage.getItem('morningReminderEnabled') === 'true';

            // Reminder toggle handlers
            document.getElementById('sleepReminder').addEventListener('change', function() {
                localStorage.setItem('sleepReminderEnabled', this.checked);
                if (this.checked) scheduleSleepReminders();
            });

            document.getElementById('morningReminder').addEventListener('change', function() {
                localStorage.setItem('morningReminderEnabled', this.checked);
                if (this.checked) scheduleSleepReminders();
            });

            // Set default datetime values for sleep form
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            yesterday.setHours(22, 0);
            now.setHours(7, 0);
            
            if (document.getElementById('sleepTime')) {
                document.getElementById('sleepTime').value = yesterday.toISOString().slice(0, 16);
            }
            if (document.getElementById('wakeTime')) {
                document.getElementById('wakeTime').value = now.toISOString().slice(0, 16);
            }

            // Initial UI update if we're in the sleep section
            if (!document.getElementById('sleep-section').classList.contains('hidden')) {
                loadSleepHistory();
                updateSleepInsights();
            }
        });

        const initApp = async () => {
            try {
                await initDB();
                console.log('Database initialized');
                
                // Carrega frases favoritas
                loadFavoritePhrases();
                
                // Inicia rota√ß√£o de frases motivacionais
                startPhraseRotation();
                
                // Initialize sleep tracking
                await loadSleepHistory();
                await updateSleepInsights();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                showSection('dashboard');

                registerServiceWorker();
                
                try {
                    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                        const installBtn = document.getElementById('installBtn');
                        if (installBtn) {
                            installBtn.classList.remove('hidden');
                            installBtn.title = 'Teste: instala√ß√£o (localhost) - em produ√ß√£o o prompt aparece automaticamente quando dispon√≠vel';
                        }
                    }
                } catch (err) {
                    console.warn('Erro ao tentar mostrar bot√£o de instala√ß√£o em dev:', err);
                }
                
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                showSection('dashboard');
            }
        };

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>