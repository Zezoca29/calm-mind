<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calm Mind - Controle de Ansiedade</title>
    <meta name="description" content="App para controle e acompanhamento de ansiedade">
    <meta name="theme-color" content="#7c9cbf">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calm Mind">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'calm-blue': '#7c9cbf',
                        'calm-blue-dark': '#5a7a9e',
                        'calm-green': '#a8c5a8',
                        'calm-lavender': '#b8a9d4',
                        'calm-sand': '#e8dcc4',
                        'calm-mint': '#b8d8d8',
                        'calm-bg': '#2a3d4a',
                        'calm-card': '#3a5260'
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes breathe {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.2); 
                opacity: 1;
            }
        }
        
        @keyframes pulse-gentle {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05);
            }
        }
        
        @keyframes breathe-in {
            0% { transform: scale(1); }
            100% { transform: scale(1.3); }
        }
        
        @keyframes breathe-out {
            0% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .animate-breathe {
            animation: breathe 8s infinite;
        }
        
        .animate-breathe-in {
            animation: breathe-in 4s ease-in-out;
        }
        
        .animate-breathe-out {
            animation: breathe-out 6s ease-in-out;
        }
        
        .animate-pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-calm-bg text-white font-sans">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loading" class="fixed inset-0 bg-calm-bg flex items-center justify-center z-50">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-calm-blue border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <h2 class="text-xl font-semibold text-calm-blue">Calm Mind</h2>
                <p class="text-gray-400">Carregando...</p>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <header class="bg-calm-card p-4 shadow-lg">
                <h1 class="text-2xl font-bold text-center text-calm-blue">üå∏ Calm Mind</h1>
                <p class="text-center text-gray-400 text-sm mt-1">Seu espa√ßo de bem-estar mental</p>
                <div class="flex justify-center mt-3">
                    <button id="installBtn" onclick="promptInstall()" class="hidden bg-calm-sand text-calm-blue-dark px-3 py-1 rounded text-sm shadow">
                        ‚ú® Instalar App
                    </button>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="bg-calm-card border-t border-gray-700">
                <div class="flex justify-around py-2">
                    <button onclick="showSection('dashboard')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="dashboard">
                        <span class="text-xl mb-1">üìà</span>
                        <span class="text-xs">Dashboard</span>
                    </button>
                    <button onclick="showSection('mood')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="mood">
                        <span class="text-xl mb-1">üí≠</span>
                        <span class="text-xs">Humor</span>
                    </button>
                    <button onclick="showSection('breathing')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="breathing">
                        <span class="text-xl mb-1">üí®</span>
                        <span class="text-xs">Respira√ß√£o</span>
                    </button>
                    <button onclick="showSection('diary')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="diary">
                        <span class="text-xl mb-1">‚úçÔ∏è</span>
                        <span class="text-xs">Di√°rio</span>
                    </button>
                </div>
            </nav>

            <!-- Content Sections -->
            <main class="p-4 pb-20">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="section">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold mb-4 text-calm-blue">üìà Seu Progresso</h2>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-calm-card p-4 rounded-lg border border-calm-blue/20">
                                <h3 class="text-sm text-gray-400">Registros este m√™s</h3>
                                <p class="text-2xl font-bold text-calm-blue" id="monthlyRecords">0</p>
                            </div>
                            <div class="bg-calm-card p-4 rounded-lg border border-calm-green/20">
                                <h3 class="text-sm text-gray-400">Exerc√≠cios feitos</h3>
                                <p class="text-2xl font-bold text-calm-green" id="exercisesCount">0</p>
                            </div>
                        </div>

                        <!-- Recent Mood Chart -->
                        <div class="bg-calm-card p-4 rounded-lg border border-calm-lavender/20">
                            <h3 class="text-lg font-medium mb-3 text-calm-lavender">Humor dos √∫ltimos 7 dias</h3>
                            <div id="moodChart" class="h-32 flex items-end justify-around">
                                <!-- Chart will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Recent Entries -->
                    <div class="bg-calm-card p-4 rounded-lg border border-calm-mint/20">
                        <h3 class="text-lg font-medium mb-3 text-calm-mint">√öltimos registros</h3>
                        <div id="recentEntries" class="space-y-3">
                            <!-- Recent entries will be populated by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- Mood Section -->
                <section id="mood-section" class="section hidden">
                    <h2 class="text-xl font-semibold mb-4 text-calm-blue">üí≠ Como voc√™ est√° se sentindo?</h2>
                    
                    <div class="bg-calm-card p-6 rounded-lg mb-4 border border-calm-blue/20">
                        <div class="text-center mb-6">
                            <p class="text-gray-300 mb-4">Selecione seu humor atual:</p>
                            <div class="flex justify-around mb-6">
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="1" title="Muito mal">üò∞</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="2" title="Mal">üòû</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="3" title="Neutro">üòê</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="4" title="Bem">üòä</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="5" title="Muito bem">üòÑ</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">N√≠vel de ansiedade (1-10):</label>
                            <input type="range" id="anxietyLevel" min="1" max="10" value="5" class="w-full accent-calm-lavender">
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>Baixa</span>
                                <span>Moderada</span>
                                <span>Alta</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">O que voc√™ est√° sentindo?</label>
                            <textarea id="moodNotes" placeholder="Descreva suas emo√ß√µes, pensamentos ou o que aconteceu hoje..." class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none resize-none" rows="3"></textarea>
                        </div>

                        <button onclick="saveMoodEntry()" class="w-full bg-calm-blue hover:bg-calm-blue-dark text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            üíæ Salvar Registro
                        </button>
                    </div>
                </section>

                <!-- Breathing Section -->
                <section id="breathing-section" class="section hidden">
                    <h2 class="text-xl font-semibold mb-4 text-calm-blue">üí® Exerc√≠cios de Respira√ß√£o</h2>
                    
                    <div class="space-y-4">
                        <!-- Breathing Exercise 1 -->
                        <div class="bg-calm-card p-6 rounded-lg border border-calm-mint/20">
                            <h3 class="text-lg font-medium mb-2 text-calm-mint">4-7-8 (Relaxamento)</h3>
                            <p class="text-gray-400 mb-4">Inspire por 4, segure por 7, expire por 8 segundos</p>
                            <button onclick="startBreathing('478')" class="bg-calm-mint hover:bg-calm-mint/80 text-calm-bg px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>

                        <!-- Breathing Exercise 2 -->
                        <div class="bg-calm-card p-6 rounded-lg border border-calm-green/20">
                            <h3 class="text-lg font-medium mb-2 text-calm-green">Box Breathing (Foco)</h3>
                            <p class="text-gray-400 mb-4">4 tempos para cada fase: inspire, segure, expire, segure</p>
                            <button onclick="startBreathing('box')" class="bg-calm-green hover:bg-calm-green/80 text-calm-bg px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>

                        <!-- Breathing Exercise 3 -->
                        <div class="bg-calm-card p-6 rounded-lg border border-calm-lavender/20">
                            <h3 class="text-lg font-medium mb-2 text-calm-lavender">Respira√ß√£o Simples</h3>
                            <p class="text-gray-400 mb-4">Inspire por 4, expire por 6 segundos</p>
                            <button onclick="startBreathing('simple')" class="bg-calm-lavender hover:bg-calm-lavender/80 text-calm-bg px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Breathing Exercise Modal -->
                <div id="breathingModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50">
                    <div class="bg-calm-card p-8 rounded-lg max-w-sm w-full mx-4 text-center border-2 border-calm-blue/30">
                        <h3 id="exerciseTitle" class="text-xl font-semibold mb-4 text-calm-blue"></h3>
                        
                        <!-- Breathing Animation -->
                        <div class="relative mb-6">
                            <div id="breathingCircle" class="w-32 h-32 mx-auto bg-gradient-to-br from-calm-mint to-calm-lavender rounded-full flex items-center justify-center text-calm-bg font-bold text-lg shadow-lg">
                                <span id="breathingText">Prepare-se</span>
                            </div>
                        </div>

                        <div id="instructionText" class="text-lg mb-4 h-6 text-gray-300">Preparando...</div>
                        <div id="timerText" class="text-3xl font-bold mb-6 text-calm-blue">3</div>
                        
                        <div class="flex gap-4">
                            <button onclick="stopBreathing()" class="flex-1 bg-calm-lavender hover:bg-calm-lavender/80 text-calm-bg py-2 px-4 rounded-lg transition-colors">
                                ‚èπÔ∏è Parar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Diary Section -->
                <section id="diary-section" class="section hidden">
                    <h2 class="text-xl font-semibold mb-4 text-calm-blue">‚úçÔ∏è Di√°rio Emocional</h2>
                    
                    <!-- New Entry Form -->
                    <div class="bg-calm-card p-6 rounded-lg mb-6 border border-calm-sand/20">
                        <h3 class="text-lg font-medium mb-4 text-calm-sand">Nova entrada</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">T√≠tulo (opcional)</label>
                            <input type="text" id="diaryTitle" placeholder="Ex: Dia tranquilo em casa" class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Como foi seu dia?</label>
                            <textarea id="diaryEntry" placeholder="Escreva sobre seus pensamentos, sentimentos, o que aconteceu hoje..." class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none resize-none" rows="5"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Tags (separe por v√≠rgula)</label>
                            <input type="text" id="diaryTags" placeholder="trabalho, fam√≠lia, gratid√£o, paz" class="w-full p-3 bg-calm-bg rounded-lg border border-calm-blue/30 focus:border-calm-blue focus:outline-none">
                        </div>

                        <button onclick="saveDiaryEntry()" class="w-full bg-calm-blue hover:bg-calm-blue-dark text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            üíæ Salvar Entrada
                        </button>
                    </div>

                    <!-- Diary Entries -->
                    <div>
                        <h3 class="text-lg font-medium mb-4 text-calm-lavender">Suas entradas</h3>
                        <div id="diaryEntries" class="space-y-4">
                            <!-- Diary entries will be populated by JavaScript -->
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Success Toast -->
        <div id="toast" class="fixed top-4 right-4 bg-calm-green text-calm-bg px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform z-50">
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // IndexedDB setup
        let db;
        const DB_NAME = 'CalmMindDB';
        const DB_VERSION = 1;

        const initDB = async () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('moodEntries')) {
                        const moodStore = db.createObjectStore('moodEntries', { keyPath: 'id', autoIncrement: true });
                        moodStore.createIndex('date', 'date', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('diaryEntries')) {
                        const diaryStore = db.createObjectStore('diaryEntries', { keyPath: 'id', autoIncrement: true });
                        diaryStore.createIndex('date', 'date', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('breathingSessions')) {
                        const breathingStore = db.createObjectStore('breathingSessions', { keyPath: 'id', autoIncrement: true });
                        breathingStore.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        };

        const saveToStore = async (storeName, data) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            return store.add(data);
        };

        const getAllFromStore = async (storeName) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        const showSection = (sectionName) => {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-calm-blue');
                btn.classList.add('text-gray-400');
            });
            
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('bg-calm-blue');
            document.querySelector(`[data-section="${sectionName}"]`).classList.remove('text-gray-400');
            
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'diary') {
                loadDiaryEntries();
            }
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        };

        const saveMoodEntry = async () => {
            const selectedMood = document.querySelector('.mood-btn.selected');
            if (!selectedMood) {
                showToast('Por favor, selecione seu humor');
                return;
            }

            const moodValue = parseInt(selectedMood.dataset.mood);
            const anxietyLevel = document.getElementById('anxietyLevel').value;
            const notes = document.getElementById('moodNotes').value;

            const moodEntry = {
                date: new Date().toISOString(),
                mood: moodValue,
                anxiety: parseInt(anxietyLevel),
                notes: notes,
                timestamp: Date.now()
            };

            try {
                await saveToStore('moodEntries', moodEntry);
                showToast('Humor registrado com sucesso!');
                
                document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected', 'bg-calm-lavender'));
                document.getElementById('anxietyLevel').value = 5;
                document.getElementById('moodNotes').value = '';
                
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar registro');
                console.error('Error saving mood entry:', error);
            }
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('mood-btn')) {
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.remove('selected', 'bg-calm-lavender');
                });
                e.target.classList.add('selected', 'bg-calm-lavender');
            }
        });

        let breathingTimer = null;
        let breathingPhase = 0;
        let breathingCycle = 0;
        let currentExercise = null;

        const breathingExercises = {
            '478': {
                name: '4-7-8 Relaxamento',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo pelo nariz' },
                    { name: 'Segure', duration: 7, instruction: 'Mantenha o ar nos pulm√µes' },
                    { name: 'Expire', duration: 8, instruction: 'Solte o ar pela boca devagar' },
                    { name: 'Pause', duration: 1, instruction: 'Pequena pausa' }
                ],
                totalCycles: 4
            },
            'box': {
                name: 'Box Breathing',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo pelo nariz' },
                    { name: 'Segure', duration: 4, instruction: 'Mantenha o ar nos pulm√µes' },
                    { name: 'Expire', duration: 4, instruction: 'Solte o ar devagar' },
                    { name: 'Segure', duration: 4, instruction: 'Pulm√µes vazios, aguarde' }
                ],
                totalCycles: 5
            },
            'simple': {
                name: 'Respira√ß√£o Simples',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo e calmo' },
                    { name: 'Expire', duration: 6, instruction: 'Solte o ar devagar' }
                ],
                totalCycles: 6
            }
        };

        // Function to clear all timers to prevent conflicts
        function clearAllTimers() {
            if (breathingTimer) {
                clearInterval(breathingTimer);
                breathingTimer = null;
            }
        }

        const startBreathing = (exerciseType) => {
            // Clear any existing timers before starting
            clearAllTimers();
            
            currentExercise = breathingExercises[exerciseType];
            breathingPhase = 0;
            breathingCycle = 1;

            
            document.getElementById('exerciseTitle').textContent = currentExercise.name;
            document.getElementById('breathingModal').classList.remove('hidden');
            
            startBreathingCountdown();
        };

        const startBreathingCountdown = () => {
            // Clear any existing timers
            clearAllTimers();
            
            let countdown = 3;
            const timerElement = document.getElementById('timerText');
            const instructionElement = document.getElementById('instructionText');
            
            instructionElement.textContent = 'Prepare-se...';
            timerElement.textContent = countdown;
            
            const countdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    timerElement.textContent = countdown;
                } else if (countdown === 0) {
                    timerElement.textContent = 'Vamos come√ßar!';
                } else {
                    clearInterval(countdownTimer);
                    runBreathingPhase();
                }
            }, 1000);
        };

        const runBreathingPhase = () => {
            // Clear any existing timers before starting a new phase
            clearAllTimers();
            
            const phase = currentExercise.phases[breathingPhase];
            let timeLeft = phase.duration;
            
            document.getElementById('instructionText').textContent = phase.instruction;
            document.getElementById('timerText').textContent = timeLeft;
            document.getElementById('breathingText').textContent = phase.name;
            
            const circle = document.getElementById('breathingCircle');
            // Clear all animation classes first to prevent conflicts
            circle.className = 'w-32 h-32 mx-auto bg-gradient-to-br from-calm-mint to-calm-lavender rounded-full flex items-center justify-center text-calm-bg font-bold text-lg transition-transform duration-1000 shadow-lg';
            
            if (phase.name === 'Inspire') {
                circle.classList.add('animate-breathe-in');
            } else if (phase.name === 'Expire') {
                circle.classList.add('animate-breathe-out');
            } else {
                circle.classList.add('animate-pulse-gentle');
            }
            
            breathingTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timerText').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(breathingTimer);
                    breathingTimer = null;
                    nextBreathingPhase();
                }
            }, 1000);
        };

        const nextBreathingPhase = () => {
            // Clear any existing timers
            clearAllTimers();
            
            breathingPhase++;
            
            if (breathingPhase >= currentExercise.phases.length) {
                breathingPhase = 0;
                breathingCycle++;
                
                if (breathingCycle > currentExercise.totalCycles) {
                    completeBreathingExercise();
                    return;
                }
            }
            
            setTimeout(() => runBreathingPhase(), 500);
        };

        const completeBreathingExercise = async () => {
            // Clear all timers when completing
            clearAllTimers();
            
            const session = {
                date: new Date().toISOString(),
                exercise: currentExercise.name,
                duration: currentExercise.totalCycles * currentExercise.phases.reduce((sum, phase) => sum + phase.duration, 0),
                completed: true,
                timestamp: Date.now()
            };
            
            try {
                await saveToStore('breathingSessions', session);
            } catch (error) {
                console.error('Error saving breathing session:', error);
            }
            
            document.getElementById('instructionText').textContent = 'Exerc√≠cio conclu√≠do! üéâ';
            document.getElementById('timerText').textContent = '‚úì';
            document.getElementById('breathingText').textContent = 'Parab√©ns!';
            
            setTimeout(() => {
                document.getElementById('breathingModal').classList.add('hidden');
                showToast('Exerc√≠cio de respira√ß√£o conclu√≠do!');
                updateDashboard();
            }, 3000);
        };

        const stopBreathing = () => {
            // Clear all timers when stopping
            clearAllTimers();
            
            document.getElementById('breathingModal').classList.add('hidden');
            // Clear animation classes to prevent conflicts
            const circle = document.getElementById('breathingCircle');
            circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
        };

        const saveDiaryEntry = async () => {
            const title = document.getElementById('diaryTitle').value;
            const content = document.getElementById('diaryEntry').value;
            const tags = document.getElementById('diaryTags').value;
            
            if (!content.trim()) {
                showToast('Por favor, escreva algo no di√°rio');
                return;
            }

            const diaryEntry = {
                date: new Date().toISOString(),
                title: title || `Entrada de ${new Date().toLocaleDateString('pt-BR')}`,
                content: content,
                tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                timestamp: Date.now()
            };

            try {
                await saveToStore('diaryEntries', diaryEntry);
                showToast('Entrada do di√°rio salva!');
                
                document.getElementById('diaryTitle').value = '';
                document.getElementById('diaryEntry').value = '';
                document.getElementById('diaryTags').value = '';
                
                loadDiaryEntries();
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar entrada');
                console.error('Error saving diary entry:', error);
            }
        };

        const loadDiaryEntries = async () => {
            try {
                const entries = await getAllFromStore('diaryEntries');
                const container = document.getElementById('diaryEntries');
                
                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-8">Nenhuma entrada ainda. Comece escrevendo sobre seu dia!</p>';
                    return;
                }
                
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.map(entry => {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const preview = entry.content.length > 150 
                        ? entry.content.substring(0, 150) + '...' 
                        : entry.content;
                    
                    const tagsHtml = entry.tags.length > 0 
                        ? entry.tags.map(tag => `<span class="bg-calm-lavender/30 text-calm-lavender text-xs px-2 py-1 rounded-full">${tag}</span>`).join(' ')
                        : '';
                    
                    return `
                        <div class="bg-calm-bg p-4 rounded-lg border border-calm-sand/20">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-white">${entry.title}</h4>
                                <span class="text-xs text-gray-400">${date}</span>
                            </div>
                            <p class="text-gray-300 text-sm mb-3">${preview}</p>
                            ${tagsHtml ? `<div class="flex flex-wrap gap-2 mb-2">${tagsHtml}</div>` : ''}
                            <button onclick="viewDiaryEntry(${entry.id})" class="text-calm-blue text-sm hover:text-calm-mint transition-colors">
                                üìñ Ler completo
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading diary entries:', error);
            }
        };

        const viewDiaryEntry = async (entryId) => {
            try {
                const entries = await getAllFromStore('diaryEntries');
                const entry = entries.find(e => e.id === entryId);
                
                if (entry) {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const tagsHtml = entry.tags.length > 0 
                        ? entry.tags.map(tag => `<span class="bg-calm-lavender/30 text-calm-lavender text-xs px-2 py-1 rounded-full">${tag}</span>`).join(' ')
                        : '';
                    
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
                    modal.innerHTML = `
                        <div class="bg-calm-card p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-calm-blue/30">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-semibold text-calm-blue">${entry.title}</h3>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                            </div>
                            <p class="text-sm text-gray-400 mb-4">${date}</p>
                            ${tagsHtml ? `<div class="flex flex-wrap gap-2 mb-4">${tagsHtml}</div>` : ''}
                            <div class="text-gray-300 whitespace-pre-wrap">${entry.content}</div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Error viewing diary entry:', error);
            }
        };

        const updateDashboard = async () => {
            try {
                const [moodEntries, diaryEntries, breathingSessions] = await Promise.all([
                    getAllFromStore('moodEntries'),
                    getAllFromStore('diaryEntries'),
                    getAllFromStore('breathingSessions')
                ]);
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyMoodEntries = moodEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                });
                
                document.getElementById('monthlyRecords').textContent = monthlyMoodEntries.length;
                document.getElementById('exercisesCount').textContent = breathingSessions.length;
                
                updateMoodChart(moodEntries);
                updateRecentEntries(moodEntries, diaryEntries);
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        };

        const updateMoodChart = (moodEntries) => {
            const chartContainer = document.getElementById('moodChart');
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                last7Days.push(date);
            }
            
            const chartData = last7Days.map(date => {
                const dayEntries = moodEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    entryDate.setHours(0, 0, 0, 0);
                    return entryDate.getTime() === date.getTime();
                });
                
                const avgMood = dayEntries.length > 0 
                    ? dayEntries.reduce((sum, entry) => sum + entry.mood, 0) / dayEntries.length 
                    : 0;
                
                return {
                    date: date.getDate(),
                    mood: avgMood,
                    hasData: dayEntries.length > 0
                };
            });
            
            chartContainer.innerHTML = chartData.map(day => {
                const height = day.hasData ? (day.mood / 5) * 100 : 10;
                const color = day.hasData ? getColorForMood(day.mood) : 'bg-gray-600';
                
                return `
                    <div class="flex flex-col items-center">
                        <div class="w-8 ${color} rounded-t" style="height: ${height}px; min-height: 10px;"></div>
                        <span class="text-xs text-gray-400 mt-2">${day.date}</span>
                    </div>
                `;
            }).join('');
        };

        const getColorForMood = (mood) => {
            if (mood <= 2) return 'bg-red-300';
            if (mood <= 3) return 'bg-calm-sand';
            if (mood <= 4) return 'bg-calm-mint';
            return 'bg-calm-green';
        };

        const getMoodEmoji = (mood) => {
            switch(mood) {
                case 1: return 'üò∞';
                case 2: return 'üòû';
                case 3: return 'üòê';
                case 4: return 'üòä';
                case 5: return 'üòÑ';
                default: return 'üòê';
            }
        };

        const updateRecentEntries = (moodEntries, diaryEntries) => {
            const container = document.getElementById('recentEntries');
            
            const allEntries = [
                ...moodEntries.map(entry => ({ ...entry, type: 'mood' })),
                ...diaryEntries.map(entry => ({ ...entry, type: 'diary' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if (allEntries.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhum registro ainda. Comece registrando seu humor!</p>';
                return;
            }
            
            container.innerHTML = allEntries.map(entry => {
                const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                if (entry.type === 'mood') {
                    return `
                        <div class="flex items-center justify-between p-3 bg-calm-bg rounded-lg border border-calm-blue/20">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${getMoodEmoji(entry.mood)}</span>
                                <div>
                                    <p class="font-medium">Registro de humor</p>
                                    <p class="text-xs text-gray-400">Ansiedade: ${entry.anxiety}/10</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex items-center justify-between p-3 bg-calm-bg rounded-lg border border-calm-sand/20">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">‚úçÔ∏è</span>
                                <div>
                                    <p class="font-medium">${entry.title}</p>
                                    <p class="text-xs text-gray-400">${entry.content.substring(0, 50)}...</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${date}</span>
                        </div>
                    `;
                }
            }).join('');
        };

        let swRegistration = null;
        let deferredPrompt;

        const registerServiceWorker = async () => {
            if ('serviceWorker' in navigator) {
                try {
                    swRegistration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    console.log('‚úÖ Service Worker registered successfully');

                    swRegistration.addEventListener('updatefound', () => {
                        const newWorker = swRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });

                    if ('sync' in window.ServiceWorkerRegistration.prototype) {
                        setupBackgroundSync();
                    }

                    if ('Notification' in window && 'PushManager' in window) {
                        setupPushNotifications();
                    }

                } catch (error) {
                    console.log('‚ùå Service Worker registration failed:', error);
                }
            }
        };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            const installBtn = document.getElementById('installBtn');
            installBtn.classList.remove('hidden');
            console.log('PWA install prompt available');
        });

        const promptInstall = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    showToast('App instalado com sucesso! üéâ');
                    document.getElementById('installBtn').classList.add('hidden');
                } else {
                    showToast('Instala√ß√£o cancelada');
                }

                deferredPrompt = null;
                return;
            }

            showToast('Instala√ß√£o n√£o dispon√≠vel neste contexto.');
            const info = document.createElement('div');
            info.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-calm-card text-gray-200 px-4 py-2 rounded shadow-lg z-50 border border-calm-blue/30';
            info.innerHTML = `
                <div class="text-sm">Para testar a instala√ß√£o: sirva o site via <strong>localhost</strong> (HTTPS) e abra no navegador. Em muitos navegadores, o prompt aparece automaticamente. No iOS, use "Adicionar √† Tela de In√≠cio" no menu de compartilhamento.</div>
                <div class="text-xs text-gray-400 mt-1">Fechar em 8s</div>
            `;
            document.body.appendChild(info);
            setTimeout(() => info.remove(), 8000);
        };

        const showUpdateNotification = () => {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'fixed top-0 left-0 right-0 bg-calm-blue text-white p-3 text-center z-50';
            updateBanner.innerHTML = `
                <p class="mb-2">Nova vers√£o dispon√≠vel!</p>
                <button onclick="applyUpdate()" class="bg-white text-calm-blue px-4 py-1 rounded text-sm mr-2">
                    Atualizar
                </button>
                <button onclick="this.parentElement.remove()" class="text-white text-sm">
                    Depois
                </button>
            `;
            document.body.appendChild(updateBanner);
        };

        const applyUpdate = async () => {
            if (swRegistration && swRegistration.waiting) {
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            }
        };

        const setupBackgroundSync = () => {
            navigator.serviceWorker.ready.then(registration => {
                console.log('üîÑ Background Sync ready');
            });
        };

        const setupPushNotifications = async () => {
            if (Notification.permission === 'default') {
                console.log('üîî Push notifications available');
            }
        };

        const requestNotificationPermission = async () => {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    showToast('Notifica√ß√µes ativadas! üîî');
                    scheduleWellnessReminders();
                } else {
                    showToast('Notifica√ß√µes negadas');
                }

                return permission;
            }
        };

        const scheduleWellnessReminders = () => {
            setInterval(() => {
                if (Notification.permission === 'granted') {
                    new Notification('Calm Mind - Lembrete', {
                        body: 'Que tal registrar como voc√™ est√° se sentindo hoje? üòä',
                        icon: '/icon-192.png',
                        tag: 'daily-mood-reminder'
                    });
                }
            }, 24 * 60 * 60 * 1000);
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('üí¨ Message from SW:', event.data);

                switch (event.data.type) {
                    case 'SYNC_COMPLETE':
                        showToast(`Dados sincronizados: ${event.data.data}`);
                        break;

                    case 'CACHE_UPDATED':
                        console.log('üì¶ Cache updated');
                        break;
                }
            });
        }

        const initApp = async () => {
            try {
                await initDB();
                console.log('Database initialized');
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                showSection('dashboard');

                registerServiceWorker();
                
                try {
                    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                        const installBtn = document.getElementById('installBtn');
                        if (installBtn) {
                            installBtn.classList.remove('hidden');
                            installBtn.title = 'Teste: instala√ß√£o (localhost) - em produ√ß√£o o prompt aparece automaticamente quando dispon√≠vel';
                        }
                    }
                } catch (err) {
                    console.warn('Erro ao tentar mostrar bot√£o de instala√ß√£o em dev:', err);
                }
                
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                showSection('dashboard');
            }
        };

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>