<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calm Mind - Controle de Ansiedade</title>
    <meta name="description" content="App para controle e acompanhamento de ansiedade">
    <meta name="theme-color" content="#0073c4">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calm Mind">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- üî• ADICIONAR ANTES DO </head> -->
    
    <!-- Supabase Client Library -->
    <!-- (j√° adicionado acima) -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Framer Motion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/framer-motion/11.0.3/framer-motion.min.js"></script>

    <!-- Babel Standalone para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>


    <!-- Ocean Mind Integration -->
   <!-- Carregar Ocean Mind Component -->
    <script type="text/babel" src="js/oceanmind.jsx"></script>

<!-- Script de Integra√ß√£o -->
<script type="text/babel">
    let oceanMindRoot = null;

    function openOceanMind() {
        const container = document.getElementById('ocean-mind-root');
        if (!container) {
            console.error('Container ocean-mind-root n√£o encontrado');
            return;
        }
        
        // Esconder app principal
        const mainApp = document.getElementById('main-app');
        if (mainApp) mainApp.style.display = 'none';
        
        // Criar root do React se ainda n√£o existir
        if (!oceanMindRoot) {
            oceanMindRoot = ReactDOM.createRoot(container);
        }
        
        // Renderizar diretamente o componente inline
        oceanMindRoot.render(<OceanoEmocionalInline />);
    }

    function closeOceanMind() {
        const mainApp = document.getElementById('main-app');
        if (mainApp) mainApp.style.display = 'block';
        
        const container = document.getElementById('ocean-mind-root');
        if (oceanMindRoot) {
            oceanMindRoot.unmount();
            oceanMindRoot = null;
        }
        if (container) container.innerHTML = '';
    }
    
    // COMPONENTE INLINE (copie todo o c√≥digo do artifact aqui)
    function OceanoEmocionalInline() {
        const { useState, useEffect, useCallback } = React;
        
        const Icon = ({ children, size = 18, className = '' }) => (
            <span className={className} style={{ fontSize: size }}>{children}</span>
        );

        const Sparkles = (props) => <Icon {...props}>‚ú®</Icon>;
        const Moon = (props) => <Icon {...props}>üåô</Icon>;
        const Wind = (props) => <Icon {...props}>üí®</Icon>;
        const Heart = (props) => <Icon {...props}>üíô</Icon>;
        const BookOpen = (props) => <Icon {...props}>üìñ</Icon>;
        const Settings = (props) => <Icon {...props}>‚öôÔ∏è</Icon>;
        const X = (props) => <Icon {...props}>‚úï</Icon>;
        const Send = (props) => <Icon {...props}>üì®</Icon>;
        const Home = (props) => <Icon {...props}>üè†</Icon>;

        const emotionColors = {
            calm: { from: '#6DD5FA', to: '#2980B9', glow: 'rgba(109, 213, 250, 0.3)' },
            anxious: { from: '#FFB347', to: '#FF8C42', glow: 'rgba(255, 179, 71, 0.35)' },
            sleep: { from: '#B19CD9', to: '#6A5ACD', glow: 'rgba(177, 156, 217, 0.25)' },
            happy: { from: '#FFD93D', to: '#FFBE0B', glow: 'rgba(255, 217, 61, 0.3)' },
            sad: { from: '#B0C4DE', to: '#778899', glow: 'rgba(176, 196, 222, 0.25)' },
            neutral: { from: '#E8F5E9', to: '#A5D6A7', glow: 'rgba(232, 245, 233, 0.3)' }
        };

        const emotionAnimations = {
            calm: { scale: [1, 1.03, 1], duration: 6, glow: '35px' },
            anxious: { scale: [1, 1.08, 1], duration: 2.5, glow: '55px' },
            sleep: { scale: [1, 1.01, 1], duration: 10, glow: '20px' },
            happy: { scale: [1, 1.05, 1], duration: 4, glow: '40px' },
            sad: { scale: [1, 1.02, 1], duration: 7, glow: '25px' },
            neutral: { scale: [1, 1.02, 1], duration: 5, glow: '30px' }
        };

        const gradients = {
            dawn: 'linear-gradient(135deg, #FFB6A3 0%, #FFDA9E 100%)',
            morning: 'linear-gradient(135deg, #A8D8FF 0%, #E0F4FF 100%)',
            afternoon: 'linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%)',
            evening: 'linear-gradient(135deg, #FFB88C 0%, #D98FBA 100%)',
            night: 'linear-gradient(135deg, #1E2A47 0%, #4A5F7F 100%)'
        };

        const exercises = {
            'breathing-478': {
                id: 'breathing-478',
                name: 'Respira√ß√£o 4-7-8',
                duration: 120,
                script: [
                    'Vamos come√ßar. Sente-se confortavelmente e relaxe os ombros.',
                    'Inspire profundamente pelo nariz... 2... 3... 4...',
                    'Agora segure o ar... 2... 3... 4... 5... 6... 7...',
                    'E solte lentamente pela boca... 2... 3... 4... 5... 6... 7... 8...',
                    'Muito bem. Vamos continuar...',
                    '√ìtimo trabalho. Perceba como seu corpo est√° mais calmo agora.'
                ]
            },
            'meditation': {
                id: 'meditation',
                name: 'Medita√ß√£o Guiada',
                duration: 180,
                script: [
                    'Feche os olhos. Imagine uma praia vazia ao amanhecer.',
                    'Sinta a areia morna sob seus p√©s.',
                    'Ou√ßa as ondas quebrando suavemente na areia.',
                    'O vento toca seu rosto com delicadeza.',
                    'Respire o ar salgado do mar.',
                    'Voc√™ est√° seguro. Voc√™ est√° em paz.',
                    'Aos poucos, traga sua consci√™ncia de volta.',
                    'Abra os olhos lentamente.'
                ]
            },
            'grounding': {
                id: 'grounding',
                name: 'T√©cnica 5-4-3-2-1',
                duration: 240,
                script: [
                    'Voc√™ est√° seguro. Vamos fazer um exerc√≠cio para te trazer de volta ao aqui e agora.',
                    'Olhe ao seu redor e identifique 5 coisas que voc√™ V√ä.',
                    'Agora, 4 coisas que voc√™ pode TOCAR.',
                    '3 coisas que voc√™ OUVE.',
                    '2 coisas que voc√™ pode CHEIRAR ou gosta do cheiro.',
                    'E 1 coisa que voc√™ pode PROVAR agora, ou lembra do gosto.',
                    'Respire fundo. Voc√™ fez muito bem. A crise est√° passando.'
                ]
            },
            'deep-sleep': {
                id: 'deep-sleep',
                name: 'Sono Profundo',
                duration: 480,
                script: [
                    'Deite-se confortavelmente. Ajuste o travesseiro. Solte o corpo.',
                    'Vamos relaxar cada parte do seu corpo, uma de cada vez.',
                    'Comece pelos dedos dos p√©s. Sinta-os pesados, relaxados.',
                    'Agora as pernas. Elas est√£o ficando pesadas, afundando no colch√£o.',
                    'Seu abd√¥men sobe e desce suavemente com a respira√ß√£o.',
                    'Os ombros caem, soltos. N√£o h√° tens√£o.',
                    'Seu rosto relaxa. A testa, as sobrancelhas, a mand√≠bula.',
                    'Voc√™ est√° pronto para dormir. N√£o precisa fazer nada. Apenas deixe acontecer.',
                    'Boa noite. Durma bem.'
                ]
            },
            'journal': {
                id: 'journal',
                name: 'Di√°rio Guiado',
                duration: 420,
                script: [
                    'Como voc√™ est√° se sentindo agora, neste momento?',
                    'O que aconteceu hoje que te marcou? Foi bom ou dif√≠cil?',
                    'Do que voc√™ est√° com medo? Pode colocar em palavras?',
                    'Pelo que voc√™ √© grato hoje, mesmo que seja algo pequeno?',
                    'O que voc√™ precisa ouvir agora para se sentir melhor?'
                ]
            }
        };

        const OceanBackground = ({ timeOfDay }) => (
            <div className="fixed inset-0 -z-10">
                <div className="absolute inset-0 transition-all duration-[3000ms] ease-in-out" style={{ background: gradients[timeOfDay] }} />
                <div className="absolute inset-0 bg-black/15" />
                <svg className="absolute inset-0 w-full h-full opacity-10" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="wave1" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="rgba(255,255,255,0.2)" />
                            <stop offset="100%" stopColor="rgba(255,255,255,0)" />
                        </linearGradient>
                    </defs>
                    <path d="M0,100 Q250,80 500,100 T1000,100 T1500,100 L1500,300 L0,300 Z" fill="url(#wave1)">
                        <animate attributeName="d" dur="90s" repeatCount="indefinite" values="M0,100 Q250,80 500,100 T1000,100 T1500,100 L1500,300 L0,300 Z;M0,100 Q250,120 500,100 T1000,100 T1500,100 L1500,300 L0,300 Z;M0,100 Q250,80 500,100 T1000,100 T1500,100 L1500,300 L0,300 Z" />
                    </path>
                </svg>
            </div>
        );

        const EmotionalSphere = ({ emotion, onTap }) => {
            const colors = emotionColors[emotion];
            const animation = emotionAnimations[emotion];
            return (
                <div
                    className="absolute top-[30%] left-1/2 cursor-pointer"
                    style={{
                        width: 150, height: 150, marginLeft: -75, marginTop: -75,
                        borderRadius: '50%',
                        background: `radial-gradient(circle at 30% 30%, ${colors.from}, ${colors.to})`,
                        boxShadow: `0 0 ${animation.glow} ${colors.glow}`,
                        animation: `breathe-${emotion} ${animation.duration}s ease-in-out infinite`,
                    }}
                    onClick={onTap}
                >
                    <style>{`@keyframes breathe-${emotion} { 0%, 100% { transform: scale(1); } 50% { transform: scale(${animation.scale[1]}); } }`}</style>
                </div>
            );
        };

        const AnimatedText = ({ text }) => {
            const words = text.split(' ');
            return (
                <div className="text-white/75 text-lg font-light leading-loose">
                    {words.map((word, i) => (
                        <span key={i} className="inline-block mr-1 opacity-0" style={{ animation: `fadeInWord 0.4s ease-out ${i * 0.12}s forwards` }}>
                            {word}
                        </span>
                    ))}
                    <style>{`@keyframes fadeInWord { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }`}</style>
                </div>
            );
        };

        const GlassPanel = ({ message, primaryAction, secondaryActions, onInputSubmit }) => {
            const [inputText, setInputText] = useState('');
            const handleSubmit = () => {
                if (inputText.trim()) {
                    onInputSubmit(inputText);
                    setInputText('');
                }
            };
            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white/10 backdrop-blur-xl rounded-t-[40px] border-t border-white/20 shadow-2xl p-8" style={{ height: '38vh', minHeight: 300 }}>
                    <AnimatedText text={message} />
                    {primaryAction && (
                        <button onClick={primaryAction.onClick} className="mt-8 px-8 py-4 bg-white/30 hover:bg-white/40 backdrop-blur-md rounded-full text-white text-base font-medium transition-all border border-white/40 shadow-lg inline-flex items-center gap-3">
                            <primaryAction.icon size={20} />
                            {primaryAction.label}
                        </button>
                    )}
                    {secondaryActions.length > 0 && (
                        <div className="flex gap-3 mt-4">
                            {secondaryActions.map((action, i) => (
                                <button key={i} onClick={action.onClick} className="px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full text-white/70 text-sm font-light transition-all border border-white/20">
                                    <action.icon size={16} className="inline mr-2" />
                                    {action.label}
                                </button>
                            ))}
                        </div>
                    )}
                    <div className="mt-6 flex gap-2">
                        <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSubmit()} placeholder="Digite como voc√™ est√° se sentindo..." className="flex-1 px-5 py-3 bg-white/5 backdrop-blur-sm border border-white/15 rounded-full text-white/80 placeholder-white/40 focus:outline-none focus:border-white/30 transition-all text-sm font-light" />
                        <button onClick={handleSubmit} className="w-12 h-12 flex items-center justify-center bg-white/15 hover:bg-white/25 rounded-full transition-all border border-white/20">
                            <Send size={18} className="text-white/70" />
                        </button>
                    </div>
                </div>
            );
        };

        const RadialMenu = ({ onClose, onSelectExercise }) => {
            const buttons = [
                { icon: Wind, label: 'Respirar', action: () => onSelectExercise('breathing-478') },
                { icon: Sparkles, label: 'Meditar', action: () => onSelectExercise('meditation') },
                { icon: Moon, label: 'Dormir', action: () => onSelectExercise('deep-sleep') },
                { icon: BookOpen, label: 'Di√°rio', action: () => onSelectExercise('journal') },
                { icon: Heart, label: 'Grounding', action: () => onSelectExercise('grounding') },
                { icon: Settings, label: 'Config', action: onClose }
            ];
            const angles = [0, 60, 120, 180, 240, 300];
            const radius = 100;
            return (
                <div className="fixed inset-0 z-40 flex items-center justify-center" onClick={onClose}>
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-md" />
                    <div className="relative" onClick={(e) => e.stopPropagation()}>
                        {buttons.map((btn, i) => {
                            const angle = (angles[i] * Math.PI) / 180;
                            const x = Math.cos(angle) * radius;
                            const y = Math.sin(angle) * radius;
                            return (
                                <button key={i} onClick={btn.action} className="absolute w-16 h-16 -ml-8 -mt-8 flex flex-col items-center justify-center gap-1 bg-white/95 backdrop-blur-md rounded-full shadow-xl hover:scale-110 transition-transform" style={{ transform: `translate(${x}px, ${y}px)`, animation: `fadeInScale 0.3s ease-out ${i * 0.05}s both` }}>
                                    <btn.icon size={22} className="text-slate-700" />
                                    <span className="text-[9px] font-semibold text-slate-700">{btn.label}</span>
                                </button>
                            );
                        })}
                    </div>
                    <style>{`@keyframes fadeInScale { from { opacity: 0; transform: translate(0, 0) scale(0); } to { opacity: 1; scale: 1; } }`}</style>
                </div>
            );
        };

        const ExerciseModal = ({ exercise, onClose }) => {
            const [currentStep, setCurrentStep] = useState(0);
            const [progress, setProgress] = useState(0);
            useEffect(() => {
                const stepDuration = (exercise.duration / exercise.script.length) * 1000;
                const progressInterval = setInterval(() => setProgress(p => (p >= 100 ? 100 : p + (100 / exercise.duration))), 1000);
                const stepInterval = setInterval(() => setCurrentStep(s => (s >= exercise.script.length - 1 ? s : s + 1)), stepDuration);
                return () => { clearInterval(progressInterval); clearInterval(stepInterval); };
            }, [exercise]);
            return (
                <div className="fixed inset-0 z-50 bg-gradient-to-b from-slate-900 to-slate-800">
                    <button onClick={onClose} className="absolute top-6 right-6 w-10 h-10 flex items-center justify-center text-white/40 hover:text-white/70 transition-colors z-10">
                        <X size={24} />
                    </button>
                    <div className="flex flex-col items-center justify-center h-full px-8">
                        <div className="w-28 h-28 rounded-full bg-gradient-to-br from-blue-400 to-purple-600 shadow-2xl" style={{ animation: 'breatheSphere 5s ease-in-out infinite' }} />
                        <h2 key={currentStep} className="mt-16 text-2xl text-center text-white/90 font-light max-w-lg leading-loose" style={{ animation: 'fadeInText 0.8s ease-out' }}>
                            {exercise.script[currentStep]}
                        </h2>
                        <div className="absolute bottom-12 left-8 right-8">
                            <div className="h-1 bg-white/15 rounded-full overflow-hidden">
                                <div className="h-full bg-white/70 rounded-full transition-all duration-500" style={{ width: `${progress}%` }} />
                            </div>
                            <p className="text-center text-white/50 text-sm mt-3 font-light">{Math.floor(progress)}% conclu√≠do</p>
                        </div>
                    </div>
                    <style>{`@keyframes breatheSphere { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } } @keyframes fadeInText { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }`}</style>
                </div>
            );
        };

        const [emotion, setEmotion] = useState('neutral');
        const [timeOfDay, setTimeOfDay] = useState('morning');
        const [showMenu, setShowMenu] = useState(false);
        const [currentExercise, setCurrentExercise] = useState(null);
        const [assistantMessage, setAssistantMessage] = useState('');

        useEffect(() => {
            const updateTimeOfDay = () => {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 8) setTimeOfDay('dawn');
                else if (hour >= 8 && hour < 12) setTimeOfDay('morning');
                else if (hour >= 12 && hour < 17) setTimeOfDay('afternoon');
                else if (hour >= 17 && hour < 20) setTimeOfDay('evening');
                else setTimeOfDay('night');
            };
            updateTimeOfDay();
            const interval = setInterval(updateTimeOfDay, 60000);
            return () => clearInterval(interval);
        }, []);

        useEffect(() => {
            const hour = new Date().getHours();
            let greeting = '';
            if (hour >= 5 && hour < 12) greeting = 'Bom dia. Como voc√™ est√° se sentindo hoje?';
            else if (hour >= 12 && hour < 18) greeting = 'Boa tarde. Vejo que voc√™ voltou. Como foi o seu dia at√© agora?';
            else if (hour >= 18 && hour < 22) greeting = 'Boa noite. Est√° tudo bem?';
            else greeting = 'Oi. Parece que o sono n√£o vem f√°cil hoje, n√©?';
            setAssistantMessage(greeting);
        }, []);

        const handleReturnHome = () => {
            setCurrentExercise(null);
            setShowMenu(false);
            setEmotion('neutral');
            setAssistantMessage('Ol√°. Estou aqui. Como voc√™ est√° agora?');
        };

        const interpretMessage = useCallback((text) => {
            const lower = text.toLowerCase();
            const keywords = {
                anxiety: ['ansioso', 'nervoso', 'agitado', 'inquieto', 'ansiedade'],
                sleep: ['dormir', 'ins√¥nia', 'cansado', 'sono', 'n√£o durmo'],
                calm: ['calma', 'paz', 'relaxar', 'tranquilo'],
                panic: ['p√¢nico', 'desespero', 'medo intenso', 'crise'],
                sad: ['triste', 'sozinho', 'vazio', 'deprimido'],
                happy: ['feliz', 'bem', 'melhor', 'alegre']
            };
            if (keywords.anxiety.some(k => lower.includes(k))) {
                setEmotion('anxious');
                setAssistantMessage('Sinto que voc√™ est√° ansioso. Vamos respirar juntos? S√≥ 2 minutos do 4-7-8.');
            } else if (keywords.sleep.some(k => lower.includes(k))) {
                setEmotion('sleep');
                setAssistantMessage('Percebi que voc√™ est√° com dificuldade para dormir. Vamos tentar uma medita√ß√£o para sono profundo?');
            } else if (keywords.panic.some(k => lower.includes(k))) {
                setEmotion('anxious');
                setAssistantMessage('Voc√™ est√° seguro. Vamos fazer a t√©cnica 5-4-3-2-1 para te trazer de volta ao presente.');
            } else if (keywords.calm.some(k => lower.includes(k))) {
                setEmotion('calm');
                setAssistantMessage('Que tal uma medita√ß√£o r√°pida de 3 minutos para acalmar a mente?');
            } else if (keywords.sad.some(k => lower.includes(k))) {
                setEmotion('sad');
                setAssistantMessage('Est√° dif√≠cil hoje, n√©? Tudo bem ter dias assim. Quer escrever um pouco no di√°rio?');
            } else if (keywords.happy.some(k => lower.includes(k))) {
                setEmotion('happy');
                setAssistantMessage('Que bom saber que voc√™ est√° bem! Isso √© maravilhoso üíô');
            } else {
                setAssistantMessage('Estou aqui para voc√™. Como posso te ajudar agora?');
            }
        }, []);

        let primaryAction = null;
        let secondaryActions = [];
        if (emotion === 'anxious') {
            primaryAction = { icon: Wind, label: 'Respirar agora', onClick: () => setCurrentExercise('breathing-478') };
            secondaryActions = [{ icon: Heart, label: 'Grounding', onClick: () => setCurrentExercise('grounding') }];
        } else if (emotion === 'sleep') {
            primaryAction = { icon: Moon, label: 'Come√ßar medita√ß√£o', onClick: () => setCurrentExercise('deep-sleep') };
            secondaryActions = [{ icon: Sparkles, label: 'Meditar', onClick: () => setCurrentExercise('meditation') }];
        } else {
            secondaryActions = [
                { icon: Wind, label: 'Respirar', onClick: () => setCurrentExercise('breathing-478') },
                { icon: Sparkles, label: 'Meditar', onClick: () => setCurrentExercise('meditation') },
                { icon: Moon, label: 'Dormir', onClick: () => setCurrentExercise('deep-sleep') }
            ];
        }

        return (
            <div className="relative w-full h-screen overflow-hidden">
                <OceanBackground timeOfDay={timeOfDay} />
                <button onClick={handleReturnHome} onKeyDown={(e) => e.key === 'Enter' && handleReturnHome()} tabIndex={0} className="fixed top-6 left-6 w-12 h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full transition-all border border-white/20 z-30 opacity-40 hover:opacity-100" aria-label="Retornar ao in√≠cio">
                    <Home size={20} className="text-white" />
                </button>
                <EmotionalSphere emotion={emotion} onTap={() => setShowMenu(true)} />
                <GlassPanel message={assistantMessage} primaryAction={primaryAction} secondaryActions={secondaryActions} onInputSubmit={interpretMessage} />
                {showMenu && <RadialMenu onClose={() => setShowMenu(false)} onSelectExercise={(type) => { setShowMenu(false); setCurrentExercise(type); }} />}
                {currentExercise && <ExerciseModal exercise={exercises[currentExercise]} onClose={() => setCurrentExercise(null)} />}
            </div>
        );
    }
    
    window.openOceanMind = openOceanMind;
    window.closeOceanMind = closeOceanMind;
</script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-50': '#f0f7ff',
                        'primary-100': '#e0f0ff',
                        'primary-200': '#b9e0ff',
                        'primary-300': '#7cc5ff',
                        'primary-400': '#36a9ff',
                        'primary-500': '#0891e6',
                        'primary-600': '#0073c4',
                        'primary-700': '#005a9e',
                        'primary-800': '#004d83',
                        'primary-900': '#00406d',
                        'secondary-50': '#f0fdf4',
                        'secondary-100': '#dcfce7',
                        'secondary-200': '#bbf7d0',
                        'secondary-300': '#86efac',
                        'secondary-400': '#4ade80',
                        'secondary-500': '#22c55e',
                        'secondary-600': '#16a34a',
                        'secondary-700': '#15803d',
                        'accent-lavender': '#e9d5ff',
                        'accent-lavender-dark': '#c084fc',
                        'accent-peach': '#fed7aa',
                        'accent-mint': '#ccfbf1',
                        'accent-rose': '#fce7f3',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Enhanced Color Palette - Softer, More Therapeutic */
        :root {
            /* Primary Colors - Calming Blues */
            --primary-50: #f0f7ff;
            --primary-100: #e0f0ff;
            --primary-200: #b9e0ff;
            --primary-300: #7cc5ff;
            --primary-400: #36a9ff;
            --primary-500: #0891e6;
            --primary-600: #0073c4;
            --primary-700: #005a9e;
            --primary-800: #004d83;
            --primary-900: #00406d;
            
            /* Secondary Colors - Healing Greens */
            --secondary-50: #f0fdf4;
            --secondary-100: #dcfce7;
            --secondary-200: #bbf7d0;
            --secondary-300: #86efac;
            --secondary-400: #4ade80;
            --secondary-500: #22c55e;
            --secondary-600: #16a34a;
            --secondary-700: #15803d;
            
            /* Accent Colors - Warm & Inviting */
            --accent-lavender: #e9d5ff;
            --accent-lavender-dark: #c084fc;
            --accent-peach: #fed7aa;
            --accent-mint: #ccfbf1;
            --accent-rose: #fce7f3;
            
            /* Neutrals - Sophisticated Grays */
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
            
            /* Backgrounds */
            --bg-primary: #ffffff;
            --bg-secondary: #fafbfc;
            --bg-dark: #1a1f2e;
            --bg-card: #ffffff;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Blur */
            --blur-sm: 8px;
            --blur-md: 16px;
            --blur-lg: 24px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: var(--bg-primary);
            color: var(--gray-900);
            line-height: 1.6;
        }
        
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }
        
        /* Gradient Backgrounds */
        .gradient-hero {
            background: linear-gradient(135deg, 
                rgba(8, 145, 230, 0.03) 0%, 
                rgba(192, 132, 252, 0.05) 50%,
                rgba(34, 197, 94, 0.03) 100%);
        }
        
        .gradient-section {
            background: linear-gradient(180deg, 
                var(--bg-primary) 0%, 
                var(--primary-50) 100%);
        }
        
        .gradient-cta {
            background: linear-gradient(135deg, 
                var(--primary-500) 0%, 
                var(--primary-600) 100%);
        }
        
        .gradient-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(255, 255, 255, 0.8) 100%);
            backdrop-filter: blur(var(--blur-md));
        }
        
        /* Custom Components */
        .btn-primary {
            background: var(--primary-600);
            color: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 1.125rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(8, 145, 230, 0.3);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary:hover {
            background: var(--primary-700);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(8, 145, 230, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-600);
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 1.125rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--primary-600);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary:hover {
            background: var(--primary-50);
            transform: translateY(-2px);
        }
        
        .card-feature {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-md);
        }
        
        .card-feature:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-2xl);
            border-color: var(--primary-300);
        }
        
        .card-testimonial {
            background: var(--bg-card);
            border-radius: 1.5rem;
            padding: 2rem;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }
        
        .card-testimonial:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-number {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-600), var(--accent-lavender-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Inter', sans-serif;
        }
        
        /* Navigation */
        nav {
            backdrop-filter: blur(var(--blur-md));
            background: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid var(--gray-200);
        }
        
        /* Modal Styles */
        .modal-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.6);
        }
        
        .modal-content {
            background: white;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-2xl);
        }
        
        .input-field {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.75rem;
            font-family: inherit;
            transition: all 0.3s ease;
            font-size: 1rem;
            color: var(--gray-900);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(8, 145, 230, 0.1);
        }
        
        .input-field::placeholder {
            color: var(--gray-500);
        }
        @keyframes breathe {
            0%, 100% { 
                transform: scale(1); 
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.2); 
                opacity: 1;
            }
        }
        
        @keyframes pulse-gentle {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05);
            }
        }
        
        @keyframes breathe-in {
            0% { transform: scale(1); }
            100% { transform: scale(1.3); }
        }
        
        @keyframes breathe-out {
            0% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Anima√ß√£o para frases motivacionais */
        @keyframes fadeInOut {
            0% { 
                opacity: 0; 
                transform: translateY(10px);
            }
            10%, 90% { 
                opacity: 1; 
                transform: translateY(0);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-10px);
            }
        }
        
        .animate-breathe {
            animation: breathe 8s infinite;
        }
        
        .animate-breathe-in {
            animation: breathe-in 4s ease-in-out;
        }
        
        .animate-breathe-out {
            animation: breathe-out 6s ease-in-out;
        }
        
        .animate-pulse-gentle {
            animation: pulse-gentle 2s infinite;
        }
        
        .animate-fade-in-out {
            animation: fadeInOut 9s ease-in-out;
        }
        
        /* Additional animations from landing page */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(8, 145, 230, 0.3);
            }
            50% { 
                box-shadow: 0 0 40px rgba(8, 145, 230, 0.5);
            }
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.8s ease-out forwards;
        }
        
        .animate-pulse-glow {
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        /* Scale classes for SOS breathing */
        .scale-100 {
            transform: scale(1);
        }
        
        .scale-150 {
            transform: scale(1.5);
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Efeito de favorito */
        .favorite-icon {
            transition: all 0.3s ease;
        }
        
        .favorite-icon.active {
            color: #fbbf24;
            transform: scale(1.2);
        }

        /* Sleep Quality Button Effects */
        .sleep-quality-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .sleep-quality-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(124, 156, 191, 0.6) 0%, transparent 70%);
            opacity: 0;
            transform: scale(2);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .sleep-quality-btn:active {
            transform: scale(0.95);
        }

        .sleep-quality-btn:active::after {
            opacity: 1;
            transform: scale(1);
        }

        .sleep-quality-btn.selected {
            transform: scale(1.1);
            background: rgba(124, 156, 191, 0.2);
            box-shadow: 0 0 15px rgba(124, 156, 191, 0.3);
        }

        /* Anima√ß√µes para modais */
        @keyframes fadeInZoom {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-in {
            animation: fadeInZoom 0.3s ease-out;
        }

        /* Efeito de sincroniza√ß√£o */
        @keyframes spin-slow {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .animate-sync {
            animation: spin-slow 1.5s linear infinite;
        }
        /* Anima√ß√µes existentes mantidas */
    </style>
</head>

<body class="bg-white text-gray-900 font-sans" style="background: var(--bg-primary); color: var(--gray-900);">
    <!-- Modal de Confirma√ß√£o de Logout -->
<div id="logoutModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl space-y-6 animate-in fade-in zoom-in duration-300">
    <div class="text-center">
      <div class="text-5xl mb-4">üëã</div>
      <h2 class="text-2xl font-bold text-gray-800">Tem certeza?</h2>
      <p class="text-gray-600 mt-2">Voc√™ ser√° desconectado de sua conta</p>
    </div>
    
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
      <p class="text-sm text-gray-700">
        <span class="font-semibold">üíæ Dica:</span> Seus dados est√£o salvos com seguran√ßa na nuvem.
      </p>
    </div>
    
    <div class="flex gap-3">
      <button onclick="closeLogoutModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-4 rounded-lg transition-all duration-200">
        ‚Üê Cancelar
      </button>
      <button onclick="confirmLogout()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg transition-all duration-200">
        Sair üö™
      </button>
    </div>
  </div>
</div>

    <!-- Modal SOS -->
<div id="sosModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl space-y-6">
    <h2 class="text-2xl font-bold text-red-600 text-center">Modo SOS</h2>

    <!-- Respira√ß√£o Guiada -->
    <div id="breathingSection" class="space-y-4 text-center">
      <p class="text-gray-700">Respire com o c√≠rculo:</p>
      <div id="breathingCircle" class="mx-auto w-24 h-24 rounded-full bg-red-200 my-6 flex items-center justify-center"></div>
      <p id="breathingInstruction" class="text-lg font-semibold text-gray-800">Inspire...</p>
    </div>

    <!-- Contatos -->
    <div class="border-t pt-4">
      <h3 class="text-lg font-bold text-gray-800 mb-2">Contatos de Emerg√™ncia</h3>
      <ul class="space-y-2 text-center">
        <li><a href="tel:188" class="block bg-red-500 text-white py-2 rounded-lg">üìû CVV - 188</a></li>
        <li><a href="tel:192" class="block bg-orange-500 text-white py-2 rounded-lg">üöë SAMU - 192</a></li>
      </ul>
      <div id="customContacts" class="mt-4"></div>
      <button onclick="addContact()" class="mt-2 w-full bg-gray-200 py-2 rounded-lg">‚ûï Adicionar Contato</button>
    </div>
<body class="bg-gray-50 text-white font-sans">
    <!-- T√©cnica de Ancoragem -->
    <div class="border-t pt-4 text-center">
      <button onclick="startGrounding()" class="bg-blue-500 text-white py-2 px-4 rounded-lg">üßò T√©cnica 5-4-3-2-1</button>
    </div>

    <button onclick="closeSOS()" class="w-full mt-4 py-2 bg-gray-300 rounded-lg">Fechar</button>
  </div>
</div>

        <!-- Loading Screen -->
        <div id="loading" class="fixed inset-0 flex items-center justify-center z-50" style="background: var(--bg-primary);">
            <div class="text-center">
                <div class="w-16 h-16 border-4 rounded-full animate-spin mx-auto mb-4" style="border-color: var(--primary-600); border-top-color: transparent;"></div>
                <h2 class="text-xl font-semibold" style="color: var(--primary-600);">Calm Mind</h2>
                <p style="color: var(--gray-500);">Carregando...</p>
            </div>
        </div>

        <!-- Ocean Mind Container -->
    <div id="ocean-mind-root"></div>

    <!-- Main App -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <header class="bg-white p-4 shadow-lg">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-center text-primary-600">üå∏ Calm Mind</h1>
                    <div class="flex gap-3 items-center">
                        <!-- Bot√£o de Sincroniza√ß√£o Manual -->
                        <button id="syncBtn" onclick="manualSync()" 
                            class="group relative flex items-center gap-2 hover:shadow-lg hover:scale-105 font-semibold py-2 px-4 rounded-full text-sm transition-all duration-200 shadow-md text-white" style="background: linear-gradient(135deg, #86efac 0%, #4ade80 100%);"
                            title="Sincronizar dados com a nuvem">
                            <span id="syncIcon" class="text-lg">‚òÅÔ∏è</span>
                            <span class="hidden sm:inline">Sincronizar</span>
                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-gray-900 text-white text-xs py-1 px-2 rounded whitespace-nowrap z-40">Sincronizar com nuvem</div>
                        </button>
                        
                        <!-- Bot√£o de Logout com Confirma√ß√£o -->
                        <button onclick="openLogoutModal()" 
                            class="group relative flex items-center gap-2 bg-red-500 hover:bg-red-600 hover:shadow-lg hover:scale-105 text-white font-semibold py-2 px-4 rounded-full text-sm transition-all duration-200 shadow-md"
                            title="Sair da conta">
                            <span class="text-lg">üö™</span>
                            <span class="hidden sm:inline">Sair</span>
                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block bg-gray-900 text-white text-xs py-1 px-2 rounded whitespace-nowrap z-40">Fazer logout</div>
                        </button>
                        
                        <!-- Bot√£o de Comunidade -->
                        <button onclick="openCommunityModal()" class="hidden sm:flex items-center gap-2 bg-blue-500 hover:bg-blue-600 hover:shadow-lg hover:scale-105 text-white font-semibold py-2 px-4 rounded-full animate-pulse shadow-md z-50 text-sm transition-all duration-200" title="Conectar com comunidade">
                            üë• <span class="hidden md:inline">Comunidade</span>
                        </button>
                        
                        <!-- Bot√£o SOS -->
                        <button onclick="activateSOS()" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 hover:shadow-lg hover:scale-105 text-white font-bold py-2 px-4 rounded-full animate-pulse shadow-md z-50 text-sm transition-all duration-200" title="Ativar modo de emerg√™ncia SOS">
                            üÜò <span class="hidden md:inline">SOS</span>
                        </button>
                        
                        <!-- Bot√£o Ocean Mind -->
                        <button onclick="openOceanMind()" 
                            class="flex items-center gap-2 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 text-white font-semibold py-2 px-4 rounded-full animate-pulse shadow-md z-50 text-sm transition-all duration-200" 
                            title="Abrir Ocean Mind - Experi√™ncia Imersiva">
                            üåä <span class="hidden md:inline">Ocean Mind</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- üÜï NOVO: Barra de Status de Sincroniza√ß√£o -->
            <div id="syncStatus" class="bg-white border-b border-gray-200 px-4 py-2 text-sm flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span id="syncIndicator" class="text-lg">‚ö™</span>
                    <span id="syncText" class="text-gray-600">Verificando conex√£o...</span>
                </div>
                <span id="lastSyncTime" class="text-xs text-gray-500">-</span>
            </div>

            <!-- Navigation -->
            <nav class="bg-white border-t border-gray-200">
                <div class="flex justify-around py-2">
                    <button onclick="showSection('dashboard')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="dashboard">
                        <span class="text-xl mb-1">üìà</span>
                        <span class="text-xs">Dashboard</span>
                    </button>
                    <button onclick="showSection('mood')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="mood">
                        <span class="text-xl mb-1">üí≠</span>
                        <span class="text-xs">Humor</span>
                    </button>
                    <button onclick="showSection('breathing')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="breathing">
                        <span class="text-xl mb-1">üí®</span>
                        <span class="text-xs">Respira√ß√£o</span>
                    </button>
                    <button onclick="showSection('sleep')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="sleep">
                        <span class="text-xl mb-1">üåô</span>
                        <span class="text-xs">Sono</span>
                    </button>
                    <button onclick="showSection('diary')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors" data-section="diary">
                        <span class="text-xl mb-1">‚úçÔ∏è</span>
                        <span class="text-xs">Di√°rio</span>
                    </button>
                </div>
            </nav>

            <!-- Content Sections -->
            <main class="p-4 pb-20">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="section">
                    <!-- Sleep Stats Card -->
                    <div class="mb-6 bg-white p-6 rounded-2xl shadow-lg flex items-center gap-6">
                        <div class="bg-gray-50 p-4 rounded-xl flex-1 text-center">
                            <span class="text-2xl block mb-1">üåô</span>
                            <span id="avgSleepHours" class="text-xl font-bold block">0h</span>
                            <span class="text-sm text-gray-600">M√©dia de Sono</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl flex-1 text-center">
                            <span class="text-2xl block mb-1">üò¥</span>
                            <span id="sleepQuality" class="text-xl font-bold block">-</span>
                            <span class="text-sm text-gray-600">Qualidade</span>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl flex-1 text-center">
                            <span class="text-2xl block mb-1">üìä</span>
                            <span id="sleepStreak" class="text-xl font-bold block">0</span>
                            <span class="text-sm text-gray-600">Registros</span>
                        </div>
                    </div>

                    <!-- COMPONENTE DE FRASES MOTIVACIONAIS -->
                    <div class="mb-6 bg-gradient-to-br from-white to-gray-50 p-6 rounded-2xl border border-accent-lavender/20 shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-purple-300/10 rounded-full blur-3xl"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-cyan-300/10 rounded-full blur-2xl"></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-medium text-accent-lavender-dark">üí´ Mensagem do dia</h3>
                                <button 
                                    onclick="toggleFavoritePhrase()" 
                                    class="favorite-icon text-xl transition-all hover:scale-110"
                                    id="favoriteBtn"
                                    title="Salvar como favorita">
                                    ‚≠ê
                                </button>
                            </div>
                            
                            <div class="min-h-[80px] flex items-center justify-center">
                                <p id="motivationalPhrase" class="text-lg text-center text-gray-700 leading-relaxed animate-fade-in-out">
                                    Carregando mensagem inspiradora...
                                </p>
                            </div>
                            
                            <div class="mt-4 flex items-center justify-between text-xs text-gray-600">
                                <span id="phraseTimer">Pr√≥xima em 9s</span>
                                <button 
                                    onclick="nextPhrase()" 
                                    class="text-cyan-500 hover:text-secondary-600 transition-colors">
                                    Pr√≥xima ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- NOVA SE√á√ÉO: Frases Favoritas -->
                    <div id="favoritesSection" class="mb-6 hidden">
                        <div class="bg-white p-4 rounded-lg border border-accent-peach/20">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-medium text-amber-700">‚≠ê Suas frases favoritas</h3>
                                <button onclick="toggleFavoritesView()" class="text-xs text-gray-600 hover:text-white">
                                    Ocultar
                                </button>
                            </div>
                            <div id="favoritesList" class="space-y-2">
                                <!-- Favoritas ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-xl font-semibold mb-4 text-primary-600">üìà Seu Progresso</h2>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-white p-4 rounded-lg border border-primary-300/20">
                                <h3 class="text-sm text-gray-600">Registros este m√™s</h3>
                                <p class="text-2xl font-bold text-primary-600" id="monthlyRecords">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-secondary-300/20">
                                <h3 class="text-sm text-gray-600">Exerc√≠cios feitos</h3>
                                <p class="text-2xl font-bold text-secondary-600" id="exercisesCount">0</p>
                            </div>
                        </div>

                        <!-- Recent Mood Chart -->
                        <div class="bg-white p-4 rounded-lg border border-accent-lavender/20">
                            <h3 class="text-lg font-medium mb-3 text-accent-lavender-dark">Humor dos √∫ltimos 7 dias</h3>
                            <div id="moodChart" class="h-32 flex items-end justify-around">
                                <!-- Chart will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Recent Entries -->
                    <div class="bg-white p-4 rounded-lg border border-accent-mint/20">
                        <h3 class="text-lg font-medium mb-3 text-cyan-500">√öltimos registros</h3>
                        <div id="recentEntries" class="space-y-3">
                            <!-- Recent entries will be populated by JavaScript -->
                        </div>
                    </div>
                </section>

                <!-- Mood Section -->
                <section id="mood-section" class="section hidden">
                    <h2 class="text-xl font-semibold mb-4 text-primary-600">üí≠ Como voc√™ est√° se sentindo?</h2>
                    
                    <div class="bg-white p-6 rounded-lg mb-4 border border-primary-300/20">
                        <div class="text-center mb-6">
                            <p class="text-gray-300 mb-4">Selecione seu humor atual:</p>
                            <div class="flex justify-around mb-6">
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="1" title="Muito mal">üò∞</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="2" title="Mal">üòû</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="3" title="Neutro">üòê</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="4" title="Bem">üòä</button>
                                <button class="mood-btn text-4xl p-3 rounded-full transition-transform hover:scale-110" data-mood="5" title="Muito bem">üòÑ</button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">N√≠vel de ansiedade (1-10):</label>
                            <input type="range" id="anxietyLevel" min="1" max="10" value="5" class="w-full accent-purple-300">
                            <div class="flex justify-between text-xs text-gray-600 mt-1">
                                <span>Baixa</span>
                                <span>Moderada</span>
                                <span>Alta</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">O que voc√™ est√° sentindo?</label>
                            <textarea id="moodNotes" placeholder="Descreva suas emo√ß√µes, pensamentos ou o que aconteceu hoje..." class="w-full p-3 bg-gray-50 rounded-lg border border-primary-300/30 focus:border-primary-300 focus:outline-none resize-none" rows="3"></textarea>
                        </div>

                        <button onclick="saveMoodEntry()" class="w-full bg-primary-600 hover:bg-primary-600-dark text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            üíæ Salvar Registro
                        </button>
                    </div>
                </section>

                <!-- Breathing Section -->
                <section id="breathing-section" class="section hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-primary-600">üí® Exerc√≠cios de Respira√ß√£o</h2>
                        <button onclick="toggleAudioGuide()" id="audioToggle" class="flex items-center gap-2 bg-white px-3 py-2 rounded-lg border border-primary-300/30 transition-colors hover:bg-primary-600/20" title="Ativar/desativar √°udio guiado">
                            <span id="audioIcon">üîä</span>
                            <span class="text-xs">√Åudio</span>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Breathing Exercise 1 -->
                        <div class="bg-white p-6 rounded-lg border border-accent-mint/20">
                            <h3 class="text-lg font-medium mb-2 text-cyan-500">4-7-8 (Relaxamento)</h3>
                            <p class="text-gray-600 mb-4">Inspire por 4, segure por 7, expire por 8 segundos</p>
                            <button onclick="startBreathing('478')" class="bg-cyan-300 hover:bg-cyan-300/80 text-gray-900 px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>

                        <!-- Breathing Exercise 2 -->
                        <div class="bg-white p-6 rounded-lg border border-secondary-300/20">
                            <h3 class="text-lg font-medium mb-2 text-secondary-600">Box Breathing (Foco)</h3>
                            <p class="text-gray-600 mb-4">4 tempos para cada fase: inspire, segure, expire, segure</p>
                            <button onclick="startBreathing('box')" class="bg-secondary-500 hover:bg-secondary-500/80 text-gray-900 px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>

                        <!-- Breathing Exercise 3 -->
                        <div class="bg-white p-6 rounded-lg border border-accent-lavender/20">
                            <h3 class="text-lg font-medium mb-2 text-accent-lavender-dark">Respira√ß√£o Simples</h3>
                            <p class="text-gray-600 mb-4">Inspire por 4, expire por 6 segundos</p>
                            <button onclick="startBreathing('simple')" class="bg-purple-300 hover:bg-purple-300/80 text-gray-900 px-4 py-2 rounded-lg transition-colors">
                                ‚ñ∂Ô∏è Iniciar
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Breathing Exercise Modal -->
                <div id="breathingModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg max-w-sm w-full mx-4 text-center border-2 border-primary-300/30">
                        <h3 id="exerciseTitle" class="text-xl font-semibold mb-4 text-primary-600"></h3>
                        
                        <!-- Breathing Animation -->
                        <div class="relative mb-6">
                            <div id="breathingCircle" class="w-32 h-32 mx-auto bg-gradient-to-br from-cyan-300 to-purple-300 rounded-full flex items-center justify-center text-gray-900 font-bold text-lg shadow-lg">
                                <span id="breathingText">Prepare-se</span>
                            </div>
                        </div>

                        <div id="instructionText" class="text-lg mb-4 h-6 text-gray-300">Preparando...</div>
                        <div id="timerText" class="text-3xl font-bold mb-6 text-primary-600">3</div>
                        
                        <div class="flex gap-4">
                            <button onclick="stopBreathing()" class="flex-1 bg-purple-300 hover:bg-purple-300/80 text-gray-900 py-2 px-4 rounded-lg transition-colors">
                                ‚èπÔ∏è Parar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sleep Section -->
                <section id="sleep-section" class="section hidden">
                    <!-- Registro de Sono -->
                    <div class="mb-6 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üåô</span> Registro do Sono
                        </h2>
                        <form id="sleepForm" class="space-y-4">
                            <div class="form-group">
                                <label class="block text-gray-600 text-sm font-medium mb-2">Hora que dormiu</label>
                                <input type="datetime-local" id="sleepTime" required 
                                    class="w-full bg-gray-50 p-3 rounded-lg border border-primary-300/20 focus:border-primary-300/50 transition-colors">
                            </div>
                            <div class="form-group">
                                <label class="block text-gray-600 text-sm font-medium mb-2">Hora que acordou</label>
                                <input type="datetime-local" id="wakeTime" required
                                    class="w-full bg-gray-50 p-3 rounded-lg border border-primary-300/20 focus:border-primary-300/50 transition-colors">
                            </div>
                            <div class="form-group">
                                <label class="block text-gray-600 text-sm font-medium mb-2">Qualidade do sono</label>
                                <div class="grid grid-cols-5 gap-3">
                                    <button type="button" class="quality-btn bg-gray-50 p-4 rounded-xl text-2xl hover:bg-primary-600/10 transition-all" data-quality="1">üò´</button>
                                    <button type="button" class="quality-btn bg-gray-50 p-4 rounded-xl text-2xl hover:bg-primary-600/10 transition-all" data-quality="2">üòï</button>
                                    <button type="button" class="quality-btn bg-gray-50 p-4 rounded-xl text-2xl hover:bg-primary-600/10 transition-all" data-quality="3">üòê</button>
                                    <button type="button" class="quality-btn bg-gray-50 p-4 rounded-xl text-2xl hover:bg-primary-600/10 transition-all" data-quality="4">üòä</button>
                                    <button type="button" class="quality-btn bg-gray-50 p-4 rounded-xl text-2xl hover:bg-primary-600/10 transition-all" data-quality="5">üò¥</button>
                                </div>
                                <input type="hidden" id="sleepQuality" required>
                            </div>
                            <button type="submit" class="w-full bg-primary-600 text-white py-4 rounded-xl font-medium hover:bg-primary-600/90 transition-colors">
                                Salvar Registro
                            </button>
                        </form>
                    </div>

                    <!-- Insights -->
                    <div class="mb-6 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üìä</span> Insights Semanais
                        </h2>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-gray-50 p-4 rounded-xl text-center">
                                <div class="text-sm text-gray-600 mb-2">M√©dia de Horas</div>
                                <div class="text-2xl font-bold text-primary-600" id="avgSleepHoursInsights">-</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl text-center">
                                <div class="text-sm text-gray-600 mb-2">Regularidade</div>
                                <div class="text-2xl font-bold text-primary-600" id="sleepRegularity">-</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl text-center">
                                <div class="text-sm text-gray-600 mb-2">Qualidade</div>
                                <div class="text-2xl font-bold text-primary-600" id="avgSleepQuality">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Notifica√ß√µes -->
                    <div class="mb-6 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üîî</span> Lembretes
                        </h2>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl">
                                <div>
                                    <div class="font-medium">Hora de Dormir</div>
                                    <div class="text-sm text-gray-600">22:00 todos os dias</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="sleepReminder" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl">
                                <div>
                                    <div class="font-medium">Como foi seu sono?</div>
                                    <div class="text-sm text-gray-600">8:00 todos os dias</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="morningReminder" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Hist√≥rico -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
                            <span class="text-2xl">üìÖ</span> Hist√≥rico
                        </h2>
                        <div id="sleepHistory" class="space-y-3">
                            <!-- Sleep history entries will be inserted here -->
                        </div>
                    </div>
                </section>

                <!-- Diary Section -->
                <section id="diary-section" class="section hidden">
                    <h2 class="text-xl font-semibold mb-4 text-primary-600">‚úçÔ∏è Di√°rio Emocional</h2>
                    
                    <!-- New Entry Form -->
                    <div class="bg-white p-6 rounded-lg mb-6 border border-accent-peach/20">
                        <h3 class="text-lg font-medium mb-4 text-amber-700">Nova entrada</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">T√≠tulo (opcional)</label>
                            <input type="text" id="diaryTitle" placeholder="Ex: Dia tranquilo em casa" class="w-full p-3 bg-gray-50 rounded-lg border border-primary-300/30 focus:border-primary-300 focus:outline-none">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Como foi seu dia?</label>
                            <textarea id="diaryEntry" placeholder="Escreva sobre seus pensamentos, sentimentos, o que aconteceu hoje..." class="w-full p-3 bg-gray-50 rounded-lg border border-primary-300/30 focus:border-primary-300 focus:outline-none resize-none" rows="5"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Tags (separe por v√≠rgula)</label>
                            <input type="text" id="diaryTags" placeholder="trabalho, fam√≠lia, gratid√£o, paz" class="w-full p-3 bg-gray-50 rounded-lg border border-primary-300/30 focus:border-primary-300 focus:outline-none">
                        </div>

                        <button onclick="saveDiaryEntry()" class="w-full bg-primary-600 hover:bg-primary-600-dark text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            üíæ Salvar Entrada
                        </button>
                    </div>

                    <!-- Diary Entries -->
                    <div>
                        <h3 class="text-lg font-medium mb-4 text-accent-lavender-dark">Suas entradas</h3>
                        <div id="diaryEntries" class="space-y-4">
                            <!-- Diary entries will be populated by JavaScript -->
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Success Toast -->
        <div id="toast" class="fixed top-4 right-4 bg-secondary-500 text-gray-900 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform z-50">
            <span id="toastMessage"></span>
        </div>

        <!-- üî• ADICIONAR ANTES DO </body> -->
        
        <!-- Sistema de Sincroniza√ß√£o com Supabase -->
        <script src="/js/supabase-sync.js"></script>
        
        <!-- Melhorias de UI para Sincroniza√ß√£o -->
        <script src="/js/sync-ui-enhancements.js"></script>
        
        <!-- Sistema Inteligente de Recomenda√ß√µes -->
        <script src="/js/smart-recommendations.js"></script>
        
        <!-- Componentes de UI Inteligentes -->
        <script src="/js/smart-ui-components.js"></script>

        <script>
            const entries = [];
            let entryCount = 0;

            // Fun√ß√£o para exibir um alerta personalizado
            function createEntry(entryContent, date = new Date().toLocaleDateString('pt-BR')) {
                const container = document.createElement('div');
                container.classList.add('entry-container');

                const entryText = document.createElement('div');
                entryText.classList.add('entry-text');
                entryText.textContent = entryContent;

                const entryDate = document.createElement('div');
                entryDate.classList.add('entry-date');
                entryDate.textContent = date;

                container.appendChild(entryText);
                container.appendChild(entryDate);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('entry-button', 'entry-button-delete');
                deleteButton.textContent = 'X';

                const editButton = document.createElement('button');
                editButton.classList.add('entry-button', 'entry-button-edit');
                editButton.textContent = 'Editar';

                container.appendChild(deleteButton);
                container.appendChild(editButton);

                deleteButton.addEventListener('click', () => {
                    entries = entries.filter((_, index) => index !== entryCount);
                    container.remove();
                });

                editButton.addEventListener('click', () => {
                    const newText = prompt('Editar entrada:', entryText.textContent);
                    if (newText) {
                        entryText.textContent = newText;
                        entries[entryCount] = newText;
                    }
                });

                entries.push(entryContent);
                entryCount++;

                document.getElementById('entriesContainer').appendChild(container);
            }

            function loadEntries() {
                const storedEntries = localStorage.getItem('entries');
                if (storedEntries) {
                    const parsedEntries = JSON.parse(storedEntries);
                    parsedEntries.forEach(createEntry);
                }
            }

            function saveEntries() {
                localStorage.setItem('entries', JSON.stringify(entries));
            }

            function addEntry() {
                const input = document.getElementById('entryInput');
                const entryContent = input.value.trim();
                if (entryContent) {
                    createEntry(entryContent);
                    input.value = '';
                    saveEntries();
                } else {
                    showToast('Digite algo antes de adicionar uma nova entrada.');
                }
            }

            function createEntry(entryContent, date = new Date().toLocaleDateString('pt-BR')) {
                const entryDiv = document.createElement('div');
                entryDiv.classList.add('border-2', 'border-primary-300/30', 'rounded-lg', 'p-4', 'mb-4');

                const contentParagraph = document.createElement('p');
                contentParagraph.textContent = entryContent;
                entryDiv.appendChild(contentParagraph);

                const dateSpan = document.createElement('span');
                dateSpan.classList.add('text-primary-600', 'text-sm');
                dateSpan.textContent = date;
                entryDiv.appendChild(dateSpan);

                document.getElementById('entries').appendChild(entryDiv);
                entries.push(entryContent);
                entryCount++;

                const entriesCountDiv = document.getElementById('entriesCount');
                entriesCountDiv.textContent = entryCount;

                // Atualizar localStorage ap√≥s a adi√ß√£o de uma nova entrada
                updateLocalStorage();

                showToast('Di√°rio registrado!');
            }

            function updateLocalStorage() {
                localStorage.setItem('entries', JSON.stringify(entries));
            }

            function loadEntries() {
                const storedEntries = JSON.parse(localStorage.getItem('entries'));
                if (storedEntries) {
                    entries.push(...storedEntries);
                    entries.forEach(entryContent => {
                        createEntry(entryContent);
                    });
                    entryCount = entries.length;

                    const entriesCountDiv = document.getElementById('entriesCount');
                    entriesCountDiv.textContent = entryCount;
                }
            }

            document.addEventListener('DOMContentLoaded', loadEntries);

            function submitDiary() {
                const diaryInput = document.getElementById('diaryInput').value;

                if (diaryInput.trim() !== '') {
                    createEntry(diaryInput);
                    document.getElementById('diaryInput').value = ''; // Limpa a caixa de texto
                } else {
                    alert('Por favor, preencha a caixa de texto.');
                }
            }

            // Only add event listeners if elements exist
            if (document.getElementById('submitDiaryButton')) {
                document.getElementById('submitDiaryButton').addEventListener('click', submitDiary);
            }

            if (document.getElementById('diaryInput')) {
                document.getElementById('diaryInput').addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        submitDiary();
                    }
                });
            }
        </script>

        <!-- Community Modal -->
        <div id="communityModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white border-b border-primary-300/30 p-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-primary-600">Comunidade & Recursos</h2>
                    <button onclick="closeCommunityModal()" class="text-gray-600 hover:text-white text-2xl">‚úï</button>
                </div>

                <!-- Modal Content -->
                <div class="p-6 space-y-6">
                    <!-- Community Links Section -->
                    <div>
                        <h3 class="text-xl font-bold text-primary-600 mb-4">Conecte-se Conosco</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                            <!-- Telegram -->
                            <a href="https://t.me/your-channel" target="_blank" 
                               class="flex items-center gap-4 bg-[#0088cc] p-4 rounded-lg hover:opacity-90 transition-opacity">
                                <svg class="w-8 h-8" fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 0 0-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06-.01.13-.02.2z"/>
                                </svg>
                                <div class="text-white">
                                    <h3 class="font-bold">Telegram</h3>
                                    <p class="text-sm opacity-90">Receba atualiza√ß√µes</p>
                                </div>
                            </a>

                            <!-- Blog -->
                            <a href="https://blog.calm-mind.com" target="_blank" 
                               class="flex items-center gap-4 bg-cyan-300 p-4 rounded-lg hover:opacity-90 transition-opacity">
                                <span class="text-3xl">‚úçÔ∏è</span>
                                <div class="text-gray-900">
                                    <h3 class="font-bold">Blog</h3>
                                    <p class="text-sm opacity-90">Artigos e dicas</p>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Psychologist Search Section -->
                    <div class="border-t border-primary-300/30 pt-6">
                        <h3 class="text-xl font-bold text-primary-600 mb-4">Encontre um Psic√≥logo</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <!-- Search Input -->
                            <div class="md:col-span-2">
                                <input type="text" id="psychologistSearch" 
                                       placeholder="Buscar por nome, especialidade ou cidade..." 
                                       class="w-full p-3 bg-gray-50 rounded-lg border border-primary-300/30 focus:border-primary-300 focus:outline-none text-white">
                            </div>
                            
                            <!-- Filter Select -->
                            <select id="psychologistFilter" 
                                    class="p-3 bg-gray-50 rounded-lg border border-primary-300/30 focus:border-primary-300 focus:outline-none text-blue">
                                <option value="all">Todos</option>
                                <option value="anxiety">Ansiedade</option>
                                <option value="depression">Depress√£o</option>
                                <option value="online">Atendimento Online</option>
                            </select>
                        </div>

                        <!-- Results Container -->
                        <div id="psychologistResults" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="sticky bottom-0 bg-white border-t border-primary-300/30 p-6">
                    <button onclick="closeCommunityModal()" class="w-full bg-primary-600 hover:bg-primary-600/80 text-white py-2 rounded-lg transition-colors">
                        Fechar
                    </button>
                </div>
            </div>
        </div>

    <script>
        // ==========================================
        // SISTEMA DE MOMENTOS DE REFLEX√ÉO INTELIGENTES
        // ==========================================
        
        const reflectionMoments = {
            wakeUp: {
                time: { hour: 5, minute: 30 },
                title: "‚òÄÔ∏è Bom dia!",
                message: "Como voc√™ dormiu? Que tal registrar sua noite de sono?",
                action: "Registrar Sono",
                section: "sleep",
                condition: async () => {
                    // Verifica se j√° registrou sono hoje
                    const entries = await getAllFromStore('sleepEntries');
                    const today = new Date().toDateString();
                    return !entries.some(e => new Date(e.date).toDateString() === today);
                }
            },
            midMorning: {
                time: { hour: 7, minute: 30 },
                title: "üå± Momento de Check-in",
                message: "J√° passou algumas horas do seu dia. Como est√° se sentindo?",
                action: "Registrar Humor",
                section: "mood",
                condition: async () => {
                    const entries = await getAllFromStore('moodEntries');
                    const today = new Date().toDateString();
                    const morningEntries = entries.filter(e => {
                        const entryDate = new Date(e.date);
                        return entryDate.toDateString() === today && entryDate.getHours() < 12;
                    });
                    return morningEntries.length === 0;
                }
            },
            midDay: {
                time: { hour: 10, minute: 0 },
                title: "üåä Pausa para Respirar",
                message: "Que tal uma pausa? Um exerc√≠cio de respira√ß√£o pode renovar sua energia.",
                action: "Fazer Exerc√≠cio",
                section: "breathing",
                condition: async () => {
                    const sessions = await getAllFromStore('breathingSessions');
                    const today = new Date().toDateString();
                    const todaySessions = sessions.filter(s => 
                        new Date(s.date).toDateString() === today
                    );
                    return todaySessions.length === 0;
                }
            },
            afternoon: {
                time: { hour: 15, minute: 0 },
                title: "üå§Ô∏è Energia da Tarde",
                message: "Como est√° sua energia? Registre como se sente agora.",
                action: "Registrar Humor",
                section: "mood",
                condition: async () => {
                    const entries = await getAllFromStore('moodEntries');
                    const today = new Date().toDateString();
                    const afternoonEntries = entries.filter(e => {
                        const entryDate = new Date(e.date);
                        return entryDate.toDateString() === today && entryDate.getHours() >= 12 && entryDate.getHours() < 18;
                    });
                    return afternoonEntries.length === 0;
                }
            },
            evening: {
                time: { hour: 18, minute: 0 },
                title: "üåÖ Momento de Transi√ß√£o",
                message: "O dia est√° chegando ao fim. Que tal fazer um exerc√≠cio de respira√ß√£o?",
                action: "Fazer Exerc√≠cio",
                section: "breathing",
                condition: async () => {
                    const sessions = await getAllFromStore('breathingSessions');
                    const today = new Date().toDateString();
                    const count = sessions.filter(s => 
                        new Date(s.date).toDateString() === today
                    ).length;
                    return count < 2;
                }
            },
            night: {
                time: { hour: 21, minute: 0 },
                title: "üåô Fim de Dia",
                message: "Como foi seu dia? Escrever sobre ele pode trazer clareza e paz.",
                action: "Escrever no Di√°rio",
                section: "diary",
                condition: async () => {
                    const entries = await getAllFromStore('diaryEntries');
                    const today = new Date().toDateString();
                    return !entries.some(e => new Date(e.date).toDateString() === today);
                }
            },
            lateNight: {
                time: { hour: 23, minute: 30 },
                title: "‚ú® Hora de Descansar",
                message: "Est√° quase na hora de dormir. Que tal um √∫ltimo check-in antes de descansar?",
                action: "Check-in Final",
                section: "mood",
                condition: async () => {
                    const entries = await getAllFromStore('moodEntries');
                    const today = new Date().toDateString();
                    const nightEntries = entries.filter(e => {
                        const entryDate = new Date(e.date);
                        return entryDate.toDateString() === today && entryDate.getHours() >= 21;
                    });
                    return nightEntries.length === 0;
                }
            }
        };

        let reflectionCheckInterval = null;
        let lastReflectionShown = null;

        // Verificar se √© hora de mostrar reflex√£o
        async function checkReflectionMoments() {
            try {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                
                // Verificar se est√° dentro do per√≠odo de 5:30 at√© 00:00
                const currentTimeInMinutes = currentHour * 60 + currentMinute;
                const startTime = 5 * 60 + 30; // 5:30
                
                const isWithinTimeWindow = currentTimeInMinutes >= startTime;
                
                if (!isWithinTimeWindow) {
                    console.log(`Reflex√£o fora do hor√°rio. Hor√°rio de exibi√ß√£o: 5:30 - 00:00. Agora: ${currentHour}:${currentMinute.toString().padStart(2, '0')}`);
                    return;
                }
                
                // Verificar se √© o primeiro login do dia
                const today = new Date().toDateString();
                const lastLoginKey = 'last_reflection_login_day';
                const lastLoginDay = localStorage.getItem(lastLoginKey);
                
                // Se j√° fez reflex√£o hoje, n√£o mostrar novamente
                if (lastLoginDay === today) {
                    console.log('Reflex√£o j√° foi exibida hoje');
                    return;
                }
                
                // Marcar que o login foi feito hoje
                localStorage.setItem(lastLoginKey, today);

                // Verificar cada momento de reflex√£o com base no hor√°rio atual
                for (const [key, moment] of Object.entries(reflectionMoments)) {
                    // Calcular qual per√≠odo o usu√°rio est√°
                    const currentMinutesTotal = currentHour * 60 + currentMinute;
                    const momentMinutesTotal = moment.time.hour * 60 + moment.time.minute;
                    
                    // Encontrar o per√≠odo atual (dentro de 2 horas ap√≥s cada hor√°rio marcado)
                    const timeDiff = currentMinutesTotal - momentMinutesTotal;
                    
                    // Se o usu√°rio entrar dentro de 2 horas ap√≥s o per√≠odo marcado, usar aquele per√≠odo
                    if (timeDiff >= 0 && timeDiff < 120) {
                        // Verificar condi√ß√£o espec√≠fica
                        console.log(`Verificando condi√ß√£o para reflex√£o: ${key}`);
                        const shouldShow = await moment.condition();
                        
                        if (shouldShow) {
                            console.log(`Mostrando reflex√£o: ${key}`);
                            showReflectionModal(key, moment);
                            return;
                        } else {
                            console.log(`Condi√ß√£o n√£o atendida para reflex√£o: ${key}`);
                            return;
                        }
                    }
                }
                
                // Se nenhum per√≠odo espec√≠fico se aplica, usar o mais pr√≥ximo anterior
                let closestMoment = null;
                let closestKey = null;
                let closestDiff = -Infinity;
                
                for (const [key, moment] of Object.entries(reflectionMoments)) {
                    const momentMinutesTotal = moment.time.hour * 60 + moment.time.minute;
                    const timeDiff = currentMinutesTotal - momentMinutesTotal;
                    
                    if (timeDiff >= 0 && timeDiff > closestDiff) {
                        closestDiff = timeDiff;
                        closestMoment = moment;
                        closestKey = key;
                    }
                }
                
                if (closestMoment && closestKey) {
                    console.log(`Reflex√£o mais pr√≥xima: ${closestKey}`);
                    const shouldShow = await closestMoment.condition();
                    
                    if (shouldShow) {
                        console.log(`Mostrando reflex√£o pr√≥xima: ${closestKey}`);
                        showReflectionModal(closestKey, closestMoment);
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro em checkReflectionMoments:', error);
            }
        }

        // Mostrar modal de reflex√£o
        function showReflectionModal(key, moment) {
            try {
                // Remover modal anterior se existir
                const existingModal = document.getElementById('reflectionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Criar modal
                const modal = document.createElement('div');
                modal.id = 'reflectionModal';
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
                modal.style.animation = 'fadeInZoom 0.3s ease-out';
                
                modal.innerHTML = `
                    <div class="bg-gradient-to-br from-white to-primary-50 rounded-3xl p-8 max-w-md w-full shadow-2xl" style="animation: fadeInZoom 0.3s ease-out;">
                        <!-- Anima√ß√£o de entrada com part√≠culas -->
                        <div class="absolute inset-0 overflow-hidden rounded-3xl pointer-events-none">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-primary-200 rounded-full blur-3xl opacity-30 animate-pulse"></div>
                            <div class="absolute bottom-0 left-0 w-24 h-24 bg-secondary-200 rounded-full blur-2xl opacity-30 animate-pulse" style="animation-delay: 0.5s;"></div>
                        </div>
                        
                        <div class="relative z-10">
                            <!-- √çcone e T√≠tulo -->
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4 animate-float">${moment.title.split(' ')[0]}</div>
                                <h2 class="text-2xl font-bold text-primary-700 mb-2">${moment.title.substring(3)}</h2>
                                <p class="text-gray-700 text-lg leading-relaxed">${moment.message}</p>
                            </div>

                            <!-- Insight Personalizado -->
                            <div id="reflectionInsight" class="bg-white/50 backdrop-blur-sm border border-primary-200 rounded-xl p-4 mb-6 text-center">
                                <p class="text-sm text-gray-600">Carregando seu insight...</p>
                            </div>

                            <!-- Bot√µes de A√ß√£o -->
                            <div class="space-y-3">
                                <button 
                                    onclick="acceptReflection('${moment.section}')" 
                                    class="w-full bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-xl">
                                    ${moment.action} ‚Üí
                                </button>
                                
                                <button 
                                    onclick="dismissReflection()" 
                                    class="w-full bg-white/50 hover:bg-white/80 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-300 border border-gray-200">
                                    N√£o agora
                                </button>
                            </div>

                            <!-- Progresso do dia -->
                            <div class="mt-6 pt-6 border-t border-primary-200">
                                <div class="flex items-center justify-between text-xs text-gray-600">
                                    <span>Seu progresso hoje</span>
                                    <span id="dailyProgress">Carregando...</span>
                                </div>
                                <div class="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div id="progressBar" class="h-full bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Carregar insight personalizado e progresso
                try {
                    loadReflectionInsight(key);
                    loadDailyProgress();
                } catch (err) {
                    console.warn('Erro ao carregar detalhes do modal:', err);
                }
                
                console.log('‚úÖ Modal exibido:', key);
                
                // Anima√ß√£o de entrada do progresso
                setTimeout(() => {
                    try {
                        const progressBar = document.getElementById('progressBar');
                        if (progressBar && progressBar.dataset.progress) {
                            progressBar.style.width = progressBar.dataset.progress + '%';
                        }
                    } catch (err) {
                        console.warn('Erro ao animar progresso:', err);
                    }
                }, 300);
            } catch (error) {
                console.error('‚ùå Erro ao exibir modal de reflex√£o:', error);
            }
        }

        // Carregar insight personalizado baseado em dados do usu√°rio
        async function loadReflectionInsight(momentKey) {
            const insightElement = document.getElementById('reflectionInsight');
            if (!insightElement) return;

            try {
                const insights = {
                    wakeUp: await getWakeUpInsight(),
                    midMorning: await getMidMorningInsight(),
                    midDay: await getMidDayInsight(),
                    afternoon: await getAfternoonInsight(),
                    evening: await getEveningInsight(),
                    night: await getNightInsight(),
                    lateNight: await getLateNightInsight()
                };

                const insight = insights[momentKey] || "Continue cuidando de voc√™. Cada pequeno passo importa.";
                
                insightElement.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üí°</span>
                        <p class="text-sm text-gray-700 text-left">${insight}</p>
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Erro ao carregar insight:', error);
                insightElement.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üí°</span>
                        <p class="text-sm text-gray-700 text-left">Continue cuidando de voc√™. Cada pequeno passo importa.</p>
                    </div>
                `;
            }
        }

        // Insights personalizados por per√≠odo
        async function getWakeUpInsight() {
            try {
                const entries = await getAllFromStore('sleepEntries');
                if (entries.length > 0) {
                    const avgQuality = entries.reduce((sum, e) => sum + (e.quality || 0), 0) / entries.length;
                    if (avgQuality < 3) {
                        return "Sua qualidade de sono pode melhorar. Registrar ajuda a identificar padr√µes!";
                    } else if (avgQuality >= 4) {
                        return `Voc√™ tem dormido bem! M√©dia: ${avgQuality.toFixed(1)}/5 ‚≠ê`;
                    }
                }
            } catch (err) {
                console.warn('Erro ao buscar wake up insight:', err);
            }
            return "Registrar seu sono ajuda a entender seus padr√µes de descanso.";
        }

        async function getMorningInsight() {
            try {
                const entries = await getAllFromStore('sleepEntries');
                if (entries.length > 0) {
                    const avgQuality = entries.reduce((sum, e) => sum + (e.quality || 0), 0) / entries.length;
                    if (avgQuality < 3) {
                        return "Sua qualidade de sono pode melhorar. Registrar ajuda a identificar padr√µes!";
                    } else if (avgQuality >= 4) {
                        return `Voc√™ tem dormido bem! M√©dia: ${avgQuality.toFixed(1)}/5 ‚≠ê`;
                    }
                }
            } catch (err) {
                console.warn('Erro ao buscar morning insight:', err);
            }
            return "Registrar seu sono ajuda a entender seus padr√µes de descanso.";
        }

        async function getMidMorningInsight() {
            try {
                const entries = await getAllFromStore('moodEntries');
                const recentEntries = entries.filter(e => {
                    const daysDiff = (Date.now() - new Date(e.date)) / (1000 * 60 * 60 * 24);
                    return daysDiff <= 7;
                });
                
                if (recentEntries.length >= 3) {
                    const avgMood = recentEntries.reduce((sum, e) => sum + (e.mood || 0), 0) / recentEntries.length;
                    if (avgMood >= 4) {
                        return `Voc√™ est√° mantendo um humor positivo! üåü`;
                    } else if (avgMood < 3) {
                        return "Est√° sendo uma semana dif√≠cil? Registrar pode ajudar.";
                    }
                }
            } catch (err) {
                console.warn('Erro ao buscar midMorning insight:', err);
            }
            return "Como come√ßou sua manh√£? Registrar ajuda a reconhecer padr√µes.";
        }

        async function getMidDayInsight() {
            try {
                const sessions = await getAllFromStore('breathingSessions');
                const today = sessions.filter(s => 
                    new Date(s.date).toDateString() === new Date().toDateString()
                );
                if (today.length === 0) {
                    return "Exerc√≠cios de respira√ß√£o reduzem ansiedade em 2 minutos!";
                } else {
                    return "Voc√™ j√° fez um exerc√≠cio hoje! Que tal mais um? üåü";
                }
            } catch (err) {
                console.warn('Erro ao buscar midDay insight:', err);
            }
            return "Uma pausa para respirar pode renovar sua energia.";
        }

        async function getAfternoonInsight() {
            try {
                const sessions = await getAllFromStore('breathingSessions');
                const thisWeek = sessions.filter(s => {
                    const daysDiff = (Date.now() - new Date(s.date)) / (1000 * 60 * 60 * 24);
                    return daysDiff <= 7;
                });
                
                if (thisWeek.length >= 3) {
                    return `Voc√™ j√° fez ${thisWeek.length} exerc√≠cios esta semana! üåü`;
                } else if (thisWeek.length === 0) {
                    return "Exerc√≠cios de respira√ß√£o reduzem ansiedade!";
                }
                return "Uma pausa para respirar pode renovar sua energia.";
            } catch (err) {
                console.warn('Erro ao buscar afternoon insight:', err);
            }
            return "Uma pausa para respirar pode renovar sua energia.";
        }

        async function getEveningInsight() {
            try {
                const sessions = await getAllFromStore('breathingSessions');
                const today = sessions.filter(s => 
                    new Date(s.date).toDateString() === new Date().toDateString()
                );
                if (today.length < 2) {
                    return "O dia est√° chegando ao fim. Um exerc√≠cio de respira√ß√£o ajuda.";
                } else {
                    return "Voc√™ j√° fez 2 exerc√≠cios hoje! Que dedica√ß√£o! üíö";
                }
            } catch (err) {
                console.warn('Erro ao buscar evening insight:', err);
            }
            return "O dia est√° chegando ao fim. Cuide-se bem.";
        }

        async function getNightInsight() {
            try {
                const entries = await getAllFromStore('diaryEntries');
                const thisMonth = entries.filter(e => {
                    const entryDate = new Date(e.date);
                    const now = new Date();
                    return entryDate.getMonth() === now.getMonth() && entryDate.getFullYear() === now.getFullYear();
                });
                
                if (thisMonth.length >= 5) {
                    return `Voc√™ tem sido consistente! ${thisMonth.length} entradas. Continue! üìù`;
                }
            } catch (err) {
                console.warn('Erro ao buscar night insight:', err);
            }
            return "Escrever sobre seu dia ajuda a processar emo√ß√µes.";
        }

        async function getLateNightInsight() {
            try {
                const moodEntries = await getAllFromStore('moodEntries');
                const today = moodEntries.filter(e => {
                    return new Date(e.date).toDateString() === new Date().toDateString();
                });
                
                if (today.length === 0) {
                    return "Antes de dormir, um check-in r√°pido ajuda.";
                } else if (today.length >= 2) {
                    return "Voc√™ est√° cuidando bem de si! üíö Durma bem!";
                }
            } catch (err) {
                console.warn('Erro ao buscar late night insight:', err);
            }
            return "Um registro antes de dormir encerra o dia com consci√™ncia.";
        }

        // Carregar progresso di√°rio
        async function loadDailyProgress() {
            const progressElement = document.getElementById('dailyProgress');
            const progressBar = document.getElementById('progressBar');
            if (!progressElement || !progressBar) {
                console.warn('Elementos de progresso n√£o encontrados');
                return;
            }

            try {
                const today = new Date().toDateString();
                
                // Se getAllFromStore n√£o existir, usar valores padr√£o
                if (typeof getAllFromStore === 'undefined') {
                    console.warn('getAllFromStore n√£o dispon√≠vel');
                    progressElement.textContent = `0/4 atividades`;
                    progressBar.style.width = '0%';
                    return;
                }
                
                // Verificar completude de cada categoria
                const checks = await Promise.all([
                    getAllFromStore('moodEntries').then(entries => 
                        entries.some(e => new Date(e.date).toDateString() === today)
                    ).catch(err => {
                        console.warn('Erro ao buscar moodEntries:', err);
                        return false;
                    }),
                    getAllFromStore('sleepEntries').then(entries => 
                        entries.some(e => new Date(e.date).toDateString() === today)
                    ).catch(err => {
                        console.warn('Erro ao buscar sleepEntries:', err);
                        return false;
                    }),
                    getAllFromStore('breathingSessions').then(sessions => 
                        sessions.some(s => new Date(s.date).toDateString() === today)
                    ).catch(err => {
                        console.warn('Erro ao buscar breathingSessions:', err);
                        return false;
                    }),
                    getAllFromStore('diaryEntries').then(entries => 
                        entries.some(e => new Date(e.date).toDateString() === today)
                    ).catch(err => {
                        console.warn('Erro ao buscar diaryEntries:', err);
                        return false;
                    })
                ]);

                const completed = checks.filter(Boolean).length;
                const progress = (completed / 4) * 100;

                progressElement.textContent = `${completed}/4 atividades`;
                progressBar.dataset.progress = progress;
                progressBar.style.width = progress + '%';
                
                console.log('‚úÖ Progresso carregado:', completed, '/', 4);
            } catch (error) {
                console.error('‚ùå Erro ao carregar progresso:', error);
                // Fallback
                document.getElementById('dailyProgress').textContent = `0/4 atividades`;
            }
        }

        // Aceitar reflex√£o e ir para se√ß√£o
        function acceptReflection(section) {
            try {
                console.log('‚úÖ acceptReflection chamado com se√ß√£o:', section);
                dismissReflection();
                
                // Feedback positivo
                setTimeout(() => {
                    try {
                        console.log('Navegando para:', section);
                        if (typeof showSection === 'function') {
                            showSection(section);
                        }
                        if (typeof showToast === 'function') {
                            showToast('√ìtima escolha! Vamos l√°! üíö');
                        }
                    } catch (err) {
                        console.warn('Erro ao navegar:', err);
                    }
                }, 300);
            } catch (error) {
                console.error('‚ùå Erro em acceptReflection:', error);
            }
        }

        // Adiar reflex√£o
        function snoozeReflection(key) {
            console.log('‚úÖ snoozeReflection chamado para:', key);
            dismissReflection();
            
            // Agendar lembrete para 1 hora depois
            const snoozeTime = Date.now() + (60 * 60 * 1000);
            localStorage.setItem(`reflection_snooze_${key}`, snoozeTime.toString());
            
            console.log('Reflex√£o adiada para 1 hora');
            showToast('Ok! Vou te lembrar em 1 hora üòä');
        }

        // Dispensar reflex√£o
        function dismissReflection() {
            try {
                const modal = document.getElementById('reflectionModal');
                if (modal) {
                    modal.style.animation = 'fadeInZoom 0.3s ease-out reverse';
                    setTimeout(() => {
                        try {
                            if (modal && modal.parentElement) {
                                modal.remove();
                            }
                        } catch (err) {
                            console.warn('Erro ao remover modal:', err);
                        }
                    }, 300);
                }
            } catch (error) {
                console.warn('Erro em dismissReflection:', error);
            }
        }

        // Iniciar verifica√ß√£o peri√≥dica de momentos de reflex√£o
        function startReflectionSystem() {
            // Verificar imediatamente ao iniciar (primeiro login)
            setTimeout(() => {
                try {
                    checkReflectionMoments().catch(err => {
                        console.warn('‚ö†Ô∏è Erro ao verificar reflex√£o:', err);
                    });
                } catch (err) {
                    console.warn('‚ö†Ô∏è Erro ao iniciar reflex√£o:', err);
                }
            }, 500);
        }

        // Parar sistema de reflex√£o
        function stopReflectionSystem() {
            // Sistema n√£o usa mais interval, apenas verifica no login
        }

        // ==========================================
        // SISTEMA DE FRASES MOTIVACIONAIS
        // ==========================================
        
        const motivationalPhrases = {
            morning: [
                { emoji: 'üåø', text: 'Respire fundo. Voc√™ n√£o precisa resolver tudo agora.' },
                { emoji: '‚òÄÔ∏è', text: 'Hoje √© um bom dia para tentar com calma.' },
                { emoji: 'üåª', text: 'Voc√™ est√° fazendo o melhor que pode ‚Äî e isso √© o suficiente.' },
                { emoji: 'üåû', text: 'A calma cresce quando voc√™ a cultiva todos os dias.' },
                { emoji: '‚òï', text: 'A pausa tamb√©m faz parte do caminho.' },
                { emoji: 'üåÖ', text: 'Mesmo os pequenos avan√ßos merecem reconhecimento.' }
            ],
            afternoon: [
                { emoji: 'üåä', text: 'A mar√© da vida sobe e desce, mas sempre volta a se acalmar.' },
                { emoji: 'üå§Ô∏è', text: 'Tudo bem n√£o estar bem o tempo todo.' },
                { emoji: 'üåº', text: 'Um passo de cada vez tamb√©m √© progresso.' },
                { emoji: 'üçÉ', text: 'Nada precisa ser perfeito, apenas verdadeiro.' },
                { emoji: 'üíß', text: 'Permita-se sentir. Emo√ß√µes tamb√©m passam.' },
                { emoji: 'üå∫', text: 'Voc√™ j√° superou dias dif√≠ceis antes. Vai conseguir de novo.' }
            ],
            evening: [
                { emoji: 'üåô', text: 'Descanse. Amanh√£ voc√™ recome√ßa com mais leveza.' },
                { emoji: 'üåæ', text: 'N√£o apresse o seu tempo. A cura tamb√©m tem o pr√≥prio ritmo.' },
                { emoji: 'üå∏', text: 'Voc√™ √© mais forte do que pensa e mais amado do que imagina.' },
                { emoji: 'üïäÔ∏è', text: 'A ansiedade n√£o define quem voc√™ √©.' },
                { emoji: 'üåô', text: 'Feche os olhos e lembre-se: o agora √© seguro.' },
                { emoji: 'üåª', text: 'Voc√™ n√£o est√° sozinho. Est√° aprendendo a se cuidar.' },
                { emoji: 'üí´', text: 'Sua mente precisa de descanso tanto quanto seu corpo.' },
                { emoji: 'üå∑', text: 'H√° beleza at√© mesmo nos dias em que voc√™ apenas tenta.' }
            ]
        };

        // Estado do componente de frases
        let currentPhraseIndex = 0;
        let currentPeriod = 'morning';
        let phraseRotationInterval = null;
        let phraseTimerInterval = null;
        let timeLeft = 9;
        let currentPhrase = null;
        let favoritePhrases = [];

        // Determina o per√≠odo do dia
        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 18) return 'afternoon';
            return 'evening';
        }

        // Carrega frases favoritas do localStorage
        function loadFavoritePhrases() {
            const stored = localStorage.getItem('calmMindFavorites');
            favoritePhrases = stored ? JSON.parse(stored) : [];
            updateFavoritesDisplay();
        }

        // Salva frases favoritas no localStorage
        function saveFavoritePhrases() {
            localStorage.setItem('calmMindFavorites', JSON.stringify(favoritePhrases));
        }

        // Verifica se a frase atual est√° nos favoritos
        function isCurrentPhraseFavorite() {
            if (!currentPhrase) return false;
            return favoritePhrases.some(fav => fav.text === currentPhrase.text);
        }

        // Toggle favorito da frase atual
        function toggleFavoritePhrase() {
            if (!currentPhrase) return;

            const isFavorite = isCurrentPhraseFavorite();
            const favoriteBtn = document.getElementById('favoriteBtn');

            if (isFavorite) {
                // Remove dos favoritos
                favoritePhrases = favoritePhrases.filter(fav => fav.text !== currentPhrase.text);
                favoriteBtn.classList.remove('active');
                showToast('Frase removida dos favoritos');
            } else {
                // Adiciona aos favoritos
                favoritePhrases.push({...currentPhrase, savedAt: new Date().toISOString()});
                favoriteBtn.classList.add('active');
                showToast('Frase salva nos favoritos! ‚≠ê');
            }

            saveFavoritePhrases();
            updateFavoritesDisplay();
        }

        // Atualiza a exibi√ß√£o de favoritos
        function updateFavoritesDisplay() {
            const favoritesSection = document.getElementById('favoritesSection');
            const favoritesList = document.getElementById('favoritesList');

            if (favoritePhrases.length === 0) {
                favoritesSection.classList.add('hidden');
                return;
            }

            favoritesSection.classList.remove('hidden');
            favoritesList.innerHTML = favoritePhrases.map((phrase, index) => `
                <div class="bg-gray-50 p-3 rounded-lg flex items-start gap-3 border border-accent-peach/10">
                    <span class="text-xl">${phrase.emoji}</span>
                    <div class="flex-1">
                        <p class="text-sm text-gray-300">${phrase.text}</p>
                    </div>
                    <button 
                        onclick="removeFavorite(${index})" 
                        class="text-gray-600 hover:text-red-400 transition-colors text-sm"
                        title="Remover">
                        √ó
                    </button>
                </div>
            `).join('');
        }

        // Remove um favorito
        function removeFavorite(index) {
            favoritePhrases.splice(index, 1);
            saveFavoritePhrases();
            updateFavoritesDisplay();
            updateFavoriteButtonState();
            showToast('Frase removida dos favoritos');
        }

        // Toggle visualiza√ß√£o de favoritos
        function toggleFavoritesView() {
            const favoritesSection = document.getElementById('favoritesSection');
            favoritesSection.classList.toggle('hidden');
        }

        // Atualiza o estado do bot√£o de favorito
        function updateFavoriteButtonState() {
            const favoriteBtn = document.getElementById('favoriteBtn');
            if (isCurrentPhraseFavorite()) {
                favoriteBtn.classList.add('active');
            } else {
                favoriteBtn.classList.remove('active');
            }
        }

        // Exibe uma frase motivacional
        function displayMotivationalPhrase() {
            currentPeriod = getTimeOfDay();
            const phrases = motivationalPhrases[currentPeriod];
            currentPhrase = phrases[currentPhraseIndex];

            const phraseElement = document.getElementById('motivationalPhrase');
            
            // Remove anima√ß√£o para resetar
            phraseElement.classList.remove('animate-fade-in-out');
            
            // Aguarda um frame para aplicar a nova anima√ß√£o
            setTimeout(() => {
                phraseElement.innerHTML = `${currentPhrase.emoji} ${currentPhrase.text}`;
                phraseElement.classList.add('animate-fade-in-out');
                updateFavoriteButtonState();
            }, 50);

            // Avan√ßa para pr√≥xima frase
            currentPhraseIndex = (currentPhraseIndex + 1) % phrases.length;
        }

        // Avan√ßa para pr√≥xima frase manualmente
        function nextPhrase() {
            clearInterval(phraseRotationInterval);
            clearInterval(phraseTimerInterval);
            timeLeft = 9;
            displayMotivationalPhrase();
            startPhraseRotation();
        }

        // Timer visual da pr√≥xima frase
        function updatePhraseTimer() {
            const timerElement = document.getElementById('phraseTimer');
            timerElement.textContent = `Pr√≥xima em ${timeLeft}s`;
            timeLeft--;
            
            if (timeLeft < 0) {
                timeLeft = 9;
            }
        }

        // Inicia a rota√ß√£o autom√°tica de frases
        function startPhraseRotation() {
            // Limpa intervalos existentes
            if (phraseRotationInterval) clearInterval(phraseRotationInterval);
            if (phraseTimerInterval) clearInterval(phraseTimerInterval);

            // Exibe a primeira frase
            displayMotivationalPhrase();

            // Timer visual
            timeLeft = 9;
            phraseTimerInterval = setInterval(updatePhraseTimer, 1000);

            // Rota√ß√£o de frases a cada 9 segundos
            phraseRotationInterval = setInterval(() => {
                displayMotivationalPhrase();
                timeLeft = 9;
            }, 9000);
        }

        // ==========================================
        // FIM DO SISTEMA DE FRASES MOTIVACIONAIS
        // ==========================================

        // ==========================================
        // SISTEMA DE REL√ìGIO MESTRE PARA EXERC√çCIOS DE RESPIRA√á√ÉO
        // ==========================================
        
        // Rel√≥gio mestre para coordenar todos os exerc√≠cios de respira√ß√£o
        class MasterClock {
            constructor() {
                this.animationFrameId = null;
                this.subscribers = new Set();
                this.isRunning = false;
                this.startTime = null;
            }
            
            // Adicionar um subscriber (exerc√≠cio de respira√ß√£o)
            subscribe(callback) {
                this.subscribers.add(callback);
            }
            
            // Remover um subscriber
            unsubscribe(callback) {
                this.subscribers.delete(callback);
            }
            
            // Iniciar o rel√≥gio mestre
            start() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.startTime = performance.now();
                this.tick();
            }
            
            // Parar o rel√≥gio mestre
            stop() {
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.isRunning = false;
                this.startTime = null;
            }
            
            // Loop principal usando requestAnimationFrame
            tick = (timestamp) => {
                if (!this.startTime) {
                    this.startTime = timestamp;
                }
                
                const elapsed = timestamp - this.startTime;
                
                // Notificar todos os subscribers
                this.subscribers.forEach(callback => {
                    try {
                        callback(elapsed, timestamp);
                    } catch (error) {
                        console.error('Error in master clock subscriber:', error);
                    }
                });
                
                // Continuar o loop
                this.animationFrameId = requestAnimationFrame(this.tick);
            }
        }
        
        // Inst√¢ncia global do rel√≥gio mestre
        const masterClock = new MasterClock();
        
        // ==========================================
        // FIM DO SISTEMA DE REL√ìGIO MESTRE
        // ==========================================

        // ==========================================
        // SISTEMA DE COMUNIDADE
        // ==========================================
        
        // Mock data para psic√≥logos (em produ√ß√£o, isso viria de uma API)
        const psychologists = [
            {
                name: "Dra. Ana Silva",
                specialty: "Ansiedade, Depress√£o",
                city: "S√£o Paulo",
                online: true,
                crp: "06/12345",
                rating: 4.8,
                image: "https://placeholder.com/150"
            },
            {
                name: "Dr. Carlos Santos",
                specialty: "Ansiedade, TOC",
                city: "Rio de Janeiro",
                online: true,
                crp: "05/54321",
                rating: 4.9,
                image: "https://placeholder.com/150"
            },
            // Adicione mais psic√≥logos aqui
        ];

        function openCommunityModal() {
            const modal = document.getElementById('communityModal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            initializePsychologistSearch();
        }

        function closeCommunityModal() {
            const modal = document.getElementById('communityModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        function initializePsychologistSearch() {
            const searchInput = document.getElementById('psychologistSearch');
            const filterSelect = document.getElementById('psychologistFilter');

            // Limpa resultados anteriores
            displayPsychologistResults(psychologists);

            // Event listeners para busca e filtro
            searchInput.addEventListener('input', updatePsychologistResults);
            filterSelect.addEventListener('change', updatePsychologistResults);
        }

        function updatePsychologistResults() {
            const searchTerm = document.getElementById('psychologistSearch').value.toLowerCase();
            const filter = document.getElementById('psychologistFilter').value;

            let filteredResults = psychologists.filter(psych => {
                const matchesSearch = 
                    psych.name.toLowerCase().includes(searchTerm) ||
                    psych.specialty.toLowerCase().includes(searchTerm) ||
                    psych.city.toLowerCase().includes(searchTerm);

                const matchesFilter = 
                    filter === 'all' ||
                    (filter === 'online' && psych.online) ||
                    psych.specialty.toLowerCase().includes(filter);

                return matchesSearch && matchesFilter;
            });

            displayPsychologistResults(filteredResults);
        }

        function displayPsychologistResults(results) {
            const container = document.getElementById('psychologistResults');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-600 py-4">
                        Nenhum resultado encontrado
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map(psych => `
                <div class="bg-white p-4 rounded-lg border border-primary-300/20 hover:border-primary-300/50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <h4 class="font-bold text-primary-600">${psych.name}</h4>
                            <p class="text-sm text-gray-600">${psych.specialty}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs bg-gray-50 px-2 py-1 rounded">CRP: ${psych.crp}</span>
                                ${psych.online ? '<span class="text-xs bg-secondary-500/20 text-secondary-600 px-2 py-1 rounded">Online</span>' : ''}
                                <span class="text-xs text-yellow-400">‚òÖ ${psych.rating}</span>
                            </div>
                        </div>
                        <button onclick="contactPsychologist('${psych.name}')" 
                                class="bg-primary-600 hover:bg-primary-600-dark text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            Contatar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function contactPsychologist(name) {
            // Aqui voc√™ implementaria a l√≥gica de contato
            showToast(`Solicita√ß√£o de contato enviada para ${name}`);
        }

        // ==========================================
        // FIM DO SISTEMA DE COMUNIDADE
        // ==========================================

        // ==========================================
        // SISTEMA SOS PARA CRISES DE ANSIEDADE
        // ==========================================

        // Vari√°veis para o controle do loop de anima√ß√£o
        let sosAnimationFrameId = null;
        let sosStartTime = null;
        let sosPreviousPhase = null;

        // Fases da respira√ß√£o SOS
        const sosBreathingPhases = [
          { name: 'Inspire', duration: 4000, text: 'Inspire (4s)...' },
          { name: 'Segure', duration: 7000, text: 'Segure (7s)...' },
          { name: 'Expire', duration: 8000, text: 'Expire (8s)...' }
        ];

        function activateSOS() {
          document.getElementById('sosModal').classList.remove('hidden');
          if (navigator.vibrate) navigator.vibrate(200);
          startSOSBreathing();
        }

        function closeSOS() {
          document.getElementById('sosModal').classList.add('hidden');
          stopSOSBreathing();
        }

        // Iniciar respira√ß√£o SOS com um √∫nico loop de tempo
        function startSOSBreathing() {
          // Cancelar qualquer anima√ß√£o em andamento
          if (sosAnimationFrameId) {
            cancelAnimationFrame(sosAnimationFrameId);
          }
          
          // Resetar vari√°veis
          sosStartTime = null;
          sosPreviousPhase = null;
          
          // Iniciar o loop de anima√ß√£o
          sosAnimationFrameId = requestAnimationFrame(sosBreathingLoop);
        }

        // Parar respira√ß√£o SOS e limpar todos os recursos
        function stopSOSBreathing() {
          if (sosAnimationFrameId) {
            cancelAnimationFrame(sosAnimationFrameId);
            sosAnimationFrameId = null;
          }
          sosStartTime = null;
          sosPreviousPhase = null;
        }

        // Loop principal de respira√ß√£o SOS usando requestAnimationFrame
        function sosBreathingLoop(timestamp) {
          if (!sosStartTime) {
            sosStartTime = timestamp;
          }
          
          const elapsed = timestamp - sosStartTime;
          const totalCycleDuration = sosBreathingPhases.reduce((sum, phase) => sum + phase.duration, 0);
          const timeInCycle = elapsed % totalCycleDuration;
          
          // Determinar a fase atual com base no tempo
          let accumulated = 0;
          let currentPhase = null;
          let timeRemainingInPhase = 0;
          
          for (let i = 0; i < sosBreathingPhases.length; i++) {
            accumulated += sosBreathingPhases[i].duration;
            if (timeInCycle < accumulated) {
              currentPhase = sosBreathingPhases[i];
              timeRemainingInPhase = accumulated - timeInCycle;
              break;
            }
          }
          
          // Atualizar UI com base na fase atual
          updateSOSUI(currentPhase, timeRemainingInPhase);
          
          // Continuar o loop
          sosAnimationFrameId = requestAnimationFrame(sosBreathingLoop);
        }

        // Atualizar interface do usu√°rio com base na fase atual
        function updateSOSUI(phase, timeRemaining) {
          const instruction = document.getElementById('breathingInstruction');
          const circle = document.getElementById('breathingCircle');
          
          if (!instruction || !circle) return;
          
          // Atualizar texto de instru√ß√£o
          instruction.textContent = phase.text;
          
          // Calcular progresso da fase (0 a 1)
          const phaseDuration = phase.duration;
          const progress = 1 - (timeRemaining / phaseDuration);
          
          // Atualizar timer no c√≠rculo
          const secondsLeft = Math.ceil(timeRemaining / 1000);
          if (!circle.querySelector('#sosTimer')) {
            circle.innerHTML = '<div id="sosTimer" class="text-gray-900 font-bold text-2xl flex items-center justify-center w-full h-full"></div>';
          }
          document.getElementById('sosTimer').textContent = secondsLeft;
          
          // Aplicar transforma√ß√µes visuais com base na fase
          circle.style.transition = 'transform 0.1s ease-out';
          
          switch(phase.name) {
            case 'Inspire':
              // Escalar para cima durante inspira√ß√£o
              const inspireScale = 1 + (progress * 0.5); // Escala de 1 a 1.5
              circle.style.transform = `scale(${inspireScale})`;
              circle.className = 'mx-auto w-24 h-24 rounded-full bg-red-200 my-6 flex items-center justify-center';
              break;
              
            case 'Segure':
              // Manter tamanho constante e pulsar suavemente
              circle.style.transform = 'scale(1.5)';
              circle.className = 'mx-auto w-24 h-24 rounded-full bg-red-200 animate-pulse my-6 flex items-center justify-center';
              break;
              
            case 'Expire':
              // Escalar para baixo durante expira√ß√£o
              const expireScale = 1.5 - (progress * 0.5); // Escala de 1.5 a 1
              circle.style.transform = `scale(${expireScale})`;
              circle.className = 'mx-auto w-24 h-24 rounded-full bg-red-200 my-6 flex items-center justify-center';
              break;
          }
          
          // Sincronizar √°udio se necess√°rio (chamado apenas quando a fase muda)
          if (sosPreviousPhase !== phase.name) {
            sosSpeakInstruction(phase.name);
            sosPreviousPhase = phase.name;
          }
        }

        // Fun√ß√£o para falar instru√ß√µes de forma s√≠ncrona
        function sosSpeakInstruction(text) {
          // Esta fun√ß√£o pode ser expandida para incluir √°udio se necess√°rio
          // Por enquanto, estamos apenas sincronizando a UI
          console.log('SOS Phase:', text);
        }

// T√©cnica de Ancoragem 5-4-3-2-1
function startGrounding() {
  // Close the SOS modal first
  closeSOS();
  
  // Create a new modal for the grounding technique
  const groundingModal = document.createElement('div');
  groundingModal.id = 'groundingModal';
  groundingModal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50';
  
  // Steps for the 5-4-3-2-1 technique
  const groundingSteps = [
    { title: 'T√©cnica 5-4-3-2-1', instruction: 'Nome 5 coisas que voc√™ pode ver', count: 5 },
    { title: 'T√©cnica 4-3-2-1', instruction: 'Nome 4 coisas que voc√™ pode tocar', count: 4 },
    { title: 'T√©cnica 3-2-1', instruction: 'Nome 3 coisas que voc√™ pode ouvir', count: 3 },
    { title: 'T√©cnica 2-1', instruction: 'Nome 2 coisas que voc√™ pode cheirar', count: 2 },
    { title: 'T√©cnica Final', instruction: 'Nome 1 coisa que voc√™ pode saborear', count: 1 }
  ];
  
  let currentStep = 0;
  
  function updateGroundingStep() {
    const step = groundingSteps[currentStep];
    let dotsHtml = '';
    for (let i = 0; i < 5; i++) {
      if (i < step.count) {
        dotsHtml += `<span class="w-3 h-3 bg-blue-500 rounded-full inline-block mr-1"></span>`;
      } else {
        dotsHtml += `<span class="w-3 h-3 bg-gray-300 rounded-full inline-block mr-1"></span>`;
      }
    }
    
    groundingModal.innerHTML = `
      <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-2xl font-bold text-blue-600 text-center mb-4">${step.title}</h2>
        <p class="text-gray-700 text-center mb-6">${step.instruction}</p>
        <div class="flex justify-center space-x-2 mb-6">
          ${dotsHtml}
        </div>
        <div class="flex justify-between">
          <button onclick="closeGrounding()" class="py-2 px-4 bg-gray-300 rounded-lg">Fechar</button>
          <button onclick="nextGroundingStep()" class="py-2 px-4 bg-blue-500 text-white rounded-lg">
            ${currentStep < groundingSteps.length - 1 ? 'Pr√≥ximo' : 'Concluir'}
          </button>
        </div>
      </div>
    `;
  }
  
  window.nextGroundingStep = function() {
    if (currentStep < groundingSteps.length - 1) {
      currentStep++;
      updateGroundingStep();
    } else {
      // This is the last step, show completion message
      groundingModal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl text-center">
          <h2 class="text-2xl font-bold text-blue-600 mb-4">T√©cnica Conclu√≠da!</h2>
          <p class="text-gray-700 mb-6">Parab√©ns! Voc√™ completou a t√©cnica de ancoragem 5-4-3-2-1.</p>
          <button onclick="closeGrounding()" class="py-2 px-4 bg-blue-500 text-white rounded-lg">Fechar</button>
        </div>
      `;
    }
  };
  
  window.closeGrounding = function() {
    document.body.removeChild(groundingModal);
  };
  
  document.body.appendChild(groundingModal);
  updateGroundingStep();
}

function closeGrounding() {
  const groundingModal = document.getElementById('groundingModal');
  if (groundingModal) {
    groundingModal.remove();
  }
  // Remove the global functions
  delete window.nextGroundingStep;
  delete window.closeGrounding;
}

// Clean up duplicate/incorrect code
// The following functions were duplicated or incorrect, so we're removing them
// function openSOS() { ... }
// function closeSOS() { ... } (duplicate)

// Contatos personalizados
function addContact() {
  const name = prompt('Nome do contato:');
  const phone = prompt('N√∫mero (com DDD):');
  if (!name || !phone) return;

  const contacts = JSON.parse(localStorage.getItem('sosContacts') || '[]');
  contacts.push({ name, phone });
  localStorage.setItem('sosContacts', JSON.stringify(contacts));
  renderContacts();
}

function renderContacts() {
  const div = document.getElementById('customContacts');
  const contacts = JSON.parse(localStorage.getItem('sosContacts') || '[]');
  div.innerHTML = contacts.map(c =>
    `<a href="tel:${c.phone}" class="block bg-green-500 text-white py-2 rounded-lg mt-2">${c.name}</a>`
  ).join('');
}

// Render contacts when the page loads
document.addEventListener('DOMContentLoaded', function() {
  renderContacts();
});

        // ==========================================
        // FIM DO SISTEMA SOS
        // ==========================================

        // IndexedDB setup
        let db;
        const DB_NAME = 'CalmMindDB';
        const DB_VERSION = 2;

        const initDB = async () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('Failed to open database:', request.error);
                    reject(request.error);
                };
                request.onsuccess = () => {
                    db = request.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    console.log('Database upgrade needed');
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('moodEntries')) {
                        const moodStore = db.createObjectStore('moodEntries', { keyPath: 'id', autoIncrement: true });
                        moodStore.createIndex('date', 'date', { unique: false });
                        console.log('Created moodEntries store');
                    }
                    
                    if (!db.objectStoreNames.contains('diaryEntries')) {
                        const diaryStore = db.createObjectStore('diaryEntries', { keyPath: 'id', autoIncrement: true });
                        diaryStore.createIndex('date', 'date', { unique: false });
                        console.log('Created diaryEntries store');
                    }
                    
                    if (!db.objectStoreNames.contains('breathingSessions')) {
                        const breathingStore = db.createObjectStore('breathingSessions', { keyPath: 'id', autoIncrement: true });
                        breathingStore.createIndex('date', 'date', { unique: false });
                        console.log('Created breathingSessions store');
                    }
                    
                    if (!db.objectStoreNames.contains('sleepEntries')) {
                        const sleepStore = db.createObjectStore('sleepEntries', { keyPath: 'id', autoIncrement: true });
                        sleepStore.createIndex('date', 'date', { unique: false });
                        sleepStore.createIndex('quality', 'quality', { unique: false });
                        console.log('Created sleepEntries store');
                    }
                };
            });
        };

        const saveToStore = async (storeName, data) => {
            try {
                if (!db) {
                    console.error('Database not initialized');
                    throw new Error('Database not initialized');
                }
                
                // üÜï Adicionar flag de sincroniza√ß√£o
                data.synced = false; // Marca como n√£o sincronizado
                data.syncedAt = null;
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.add(data);
                    request.onsuccess = () => {
                        console.log('Record saved successfully:', data);
                        
                        // üÜï Agendar sincroniza√ß√£o com debounce (evita sincroniza√ß√µes muito frequentes)
                        if (navigator.onLine && typeof scheduleDebouncedSync === 'function') {
                            scheduleDebouncedSync();
                        }
                        
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        console.error('Error saving record:', request.error);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Error in saveToStore:', error);
                throw error;
            }
        };

        const getAllFromStore = async (storeName) => {
            try {
                if (!db) {
                    console.error('Database not initialized');
                    return [];
                }
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => {
                        console.log(`Retrieved ${request.result.length} records from ${storeName}`);
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        console.error('Error retrieving records:', request.error);
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Error in getAllFromStore:', error);
                return [];
            }
        };

        const showSection = (sectionName) => {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-primary-600');
                btn.classList.add('text-gray-600');
            });
            
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('bg-primary-600');
            document.querySelector(`[data-section="${sectionName}"]`).classList.remove('text-gray-600');
            
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'diary') {
                loadDiaryEntries();
            } else if (sectionName === 'sleep') {
                loadSleepHistory();
                updateSleepInsights();
            }
        };

        const showToast = (message) => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        };

        const saveMoodEntry = async () => {
            const selectedMood = document.querySelector('.mood-btn.selected');
            if (!selectedMood) {
                showToast('Por favor, selecione seu humor');
                return;
            }

            const moodValue = parseInt(selectedMood.dataset.mood);
            const anxietyLevel = document.getElementById('anxietyLevel').value;
            const notes = document.getElementById('moodNotes').value;

            const moodEntry = {
                date: new Date().toISOString(),
                mood: moodValue,
                anxiety: parseInt(anxietyLevel),
                notes: notes,
                timestamp: Date.now()
            };

            try {
                await saveToStore('moodEntries', moodEntry);
                showToast('Humor registrado com sucesso!');
                
                document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected', 'bg-purple-300'));
                document.getElementById('anxietyLevel').value = 5;
                document.getElementById('moodNotes').value = '';
                
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar registro');
                console.error('Error saving mood entry:', error);
            }
        };

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('mood-btn')) {
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.remove('selected', 'bg-purple-300');
                });
                e.target.classList.add('selected', 'bg-purple-300');
            }
        });

        let currentExercise = null;
        let audioContext = null;
        let audioEnabled = false;
        let synth = window.speechSynthesis;
        let speakingInstructions = false;
        
        // Vari√°veis para o controle do exerc√≠cio de respira√ß√£o
        let mainStartTime = null;
        let mainPreviousPhase = null;
        let mainCurrentPhase = null;
        let mainCurrentCycle = 0;
        let mainExerciseStartTime = null;
        let isBreathingExerciseActive = false;

        // Inicializa o contexto de √°udio
        const initAudioContext = () => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        };

        // Toggle do guia de √°udio
        const toggleAudioGuide = () => {
            audioEnabled = !audioEnabled;
            const audioIcon = document.getElementById('audioIcon');
            const audioToggle = document.getElementById('audioToggle');
            
            if (audioEnabled) {
                audioIcon.textContent = 'üîä';
                audioToggle.classList.add('bg-primary-600/20');
                initAudioContext();
                showToast('√Åudio guiado ativado');
            } else {
                audioIcon.textContent = 'üîà';
                audioToggle.classList.remove('bg-primary-600/20');
                if (synth.speaking) {
                    synth.cancel();
                }
                showToast('√Åudio guiado desativado');
            }
        };

        // Fun√ß√£o para reproduzir tons de metr√¥nomo
        const playTone = (frequency, duration) => {
            if (!audioEnabled || !audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;

            gainNode.gain.setValueAtTime(0.6, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        };

        // Fun√ß√£o para falar instru√ß√µes
        const speakInstruction = (text) => {
            if (!audioEnabled || speakingInstructions) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.volume = 0.8;
            utterance.rate = 1;
            utterance.pitch = 1;

            utterance.onstart = () => {
                speakingInstructions = true;
            };

            utterance.onend = () => {
                speakingInstructions = false;
            };

            synth.speak(utterance);
        };

        const breathingExercises = {
            '478': {
                name: '4-7-8 Relaxamento',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo pelo nariz' },
                    { name: 'Segure', duration: 7, instruction: 'Mantenha o ar nos pulm√µes' },
                    { name: 'Expire', duration: 8, instruction: 'Solte o ar pela boca devagar' },
                    { name: 'Pause', duration: 1, instruction: 'Pequena pausa' }
                ],
                totalCycles: 4
            },
            'box': {
                name: 'Box Breathing',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo pelo nariz' },
                    { name: 'Segure', duration: 4, instruction: 'Mantenha o ar nos pulm√µes' },
                    { name: 'Expire', duration: 4, instruction: 'Solte o ar devagar' },
                    { name: 'Segure', duration: 4, instruction: 'Pulm√µes vazios, aguarde' }
                ],
                totalCycles: 5
            },
            'simple': {
                name: 'Respira√ß√£o Simples',
                phases: [
                    { name: 'Inspire', duration: 4, instruction: 'Respire fundo e calmo' },
                    { name: 'Expire', duration: 6, instruction: 'Solte o ar devagar' }
                ],
                totalCycles: 6
            }
        };

        function clearAllTimers() {
            // Remover o subscriber do rel√≥gio mestre se estiver ativo
            if (isBreathingExerciseActive) {
                masterClock.unsubscribe(breathingClockCallback);
                isBreathingExerciseActive = false;
            }
        }

        const startBreathing = (exerciseType) => {
            clearAllTimers();
            
            currentExercise = breathingExercises[exerciseType];

            // Resetar vari√°veis de anima√ß√£o
            mainStartTime = null;
            mainPreviousPhase = null;
            mainCurrentPhase = null;
            mainCurrentCycle = 1;
            mainExerciseStartTime = null;
            
            document.getElementById('exerciseTitle').textContent = currentExercise.name;
            document.getElementById('breathingModal').classList.remove('hidden');
            
            startBreathingCountdown();
        };

        const startBreathingCountdown = () => {
            clearAllTimers();
            
            let countdown = 3;
            const timerElement = document.getElementById('timerText');
            const instructionElement = document.getElementById('instructionText');
            
            instructionElement.textContent = 'Prepare-se...';
            timerElement.textContent = countdown;
            
            if (audioEnabled) {
                speakInstruction('Prepare-se para come√ßar o exerc√≠cio de respira√ß√£o');
            }
            
            const countdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    timerElement.textContent = countdown;
                    if (audioEnabled) {
                        playTone(440, 0.1); // Nota L√° (A4) para contagem regressiva
                    }
                } else if (countdown === 0) {
                    timerElement.textContent = 'Vamos come√ßar!';
                    if (audioEnabled) {
                        playTone(880, 0.2); // Nota L√° uma oitava acima para in√≠cio
                        speakInstruction('Vamos come√ßar!');
                    }
                } else {
                    clearInterval(countdownTimer);
                    runBreathingPhase();
                }
            }, 1000);
        };

        const runBreathingPhase = () => {
            clearAllTimers();
            
            // Registrar o callback no rel√≥gio mestre
            masterClock.subscribe(breathingClockCallback);
            isBreathingExerciseActive = true;
            masterClock.start();
        };
        
        // Callback para o rel√≥gio mestre
        const breathingClockCallback = (elapsed) => {
            if (!mainExerciseStartTime) {
                mainExerciseStartTime = performance.now();
            }
            
            if (!mainStartTime) {
                mainStartTime = performance.now();
            }
            
            const timestamp = performance.now();
            const elapsedTime = timestamp - mainStartTime;
            const totalCycleDuration = currentExercise.phases.reduce((sum, phase) => sum + (phase.duration * 1000), 0);
            const timeInCycle = elapsedTime % totalCycleDuration;
            
            // Determinar a fase atual com base no tempo
            let accumulated = 0;
            let currentPhase = null;
            let timeRemainingInPhase = 0;
            
            for (let i = 0; i < currentExercise.phases.length; i++) {
                accumulated += currentExercise.phases[i].duration * 1000;
                if (timeInCycle < accumulated) {
                    currentPhase = currentExercise.phases[i];
                    timeRemainingInPhase = accumulated - timeInCycle;
                    break;
                }
            }
            
            // Atualizar UI com base na fase atual
            if (currentPhase) {
                updateMainBreathingUI(currentPhase, timeRemainingInPhase);
            }
        };

        // Loop principal de respira√ß√£o usando requestAnimationFrame
        function mainBreathingLoop(timestamp) {
            if (!mainExerciseStartTime) {
                mainExerciseStartTime = timestamp;
            }
            
            if (!mainStartTime) {
                mainStartTime = timestamp;
            }
            
            const elapsed = timestamp - mainStartTime;
            const totalCycleDuration = currentExercise.phases.reduce((sum, phase) => sum + (phase.duration * 1000), 0);
            const timeInCycle = elapsed % totalCycleDuration;
            
            // Determinar a fase atual com base no tempo
            let accumulated = 0;
            let currentPhase = null;
            let timeRemainingInPhase = 0;
            
            for (let i = 0; i < currentExercise.phases.length; i++) {
                accumulated += currentExercise.phases[i].duration * 1000;
                if (timeInCycle < accumulated) {
                    currentPhase = currentExercise.phases[i];
                    timeRemainingInPhase = accumulated - timeInCycle;
                    break;
                }
            }
            
            // Atualizar UI com base na fase atual
            if (currentPhase) {
                updateMainBreathingUI(currentPhase, timeRemainingInPhase);
            }
            
            // Continuar o loop
            mainAnimationFrameId = requestAnimationFrame(mainBreathingLoop);
        }

        // Atualizar interface do usu√°rio com base na fase atual
        function updateMainBreathingUI(phase, timeRemaining) {
            // Atualizar texto de instru√ß√£o
            document.getElementById('instructionText').textContent = phase.instruction;
            document.getElementById('breathingText').textContent = phase.name;
            
            // Calcular progresso da fase (0 a 1)
            const phaseDuration = phase.duration * 1000;
            const progress = 1 - (timeRemaining / phaseDuration);
            
            // Atualizar timer
            const secondsLeft = Math.ceil(timeRemaining / 1000);
            document.getElementById('timerText').textContent = secondsLeft;
            
            const circle = document.getElementById('breathingCircle');
            circle.className = 'w-32 h-32 mx-auto bg-gradient-to-br from-cyan-300 to-purple-300 rounded-full flex items-center justify-center text-gray-900 font-bold text-lg transition-transform duration-1000 shadow-lg';
            
            // Aplicar transforma√ß√µes visuais com base na fase
            circle.style.transition = 'transform 0.1s ease-out';
            
            switch(phase.name) {
                case 'Inspire':
                    // Escalar para cima durante inspira√ß√£o
                    const inspireScale = 1 + (progress * 0.3); // Escala de 1 a 1.3
                    circle.style.transform = `scale(${inspireScale})`;
                    circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
                    break;
                    
                case 'Expire':
                    // Escalar para baixo durante expira√ß√£o
                    const expireScale = 1.3 - (progress * 0.3); // Escala de 1.3 a 1
                    circle.style.transform = `scale(${expireScale})`;
                    circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
                    break;
                    
                case 'Segure':
                case 'Pause':
                    // Manter tamanho constante e pulsar suavemente
                    circle.style.transform = 'scale(1.15)';
                    circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
                    circle.classList.add('animate-pulse-gentle');
                    break;
            }
            
            // Sincronizar √°udio se necess√°rio (chamado apenas quando a fase muda)
            if (mainPreviousPhase !== phase.name) {
                if (audioEnabled) {
                    speakInstruction(phase.instruction);
                    
                    // Tons diferentes para cada fase
                    switch(phase.name) {
                        case 'Inspire':
                            playTone(523.25, 0.2); // D√≥ (C5) para inspira√ß√£o
                            break;
                        case 'Expire':
                            playTone(261.63, 0.2); // D√≥ (C4) para expira√ß√£o
                            break;
                        case 'Segure':
                            playTone(392.00, 0.2); // Sol (G4) para segurar
                            break;
                        case 'Pause':
                            playTone(329.63, 0.2); // Mi (E4) para pausa
                            break;
                    }
                }
                mainPreviousPhase = phase.name;
            }
        }

        const nextBreathingPhase = () => {
            // Esta fun√ß√£o n√£o √© mais necess√°ria com o novo sistema de tempo √∫nico
            // O loop principal j√° cuida da transi√ß√£o entre fases
            
            // Verificar se completamos todos os ciclos
            const elapsed = Date.now() - mainExerciseStartTime;
            const cycleDuration = currentExercise.phases.reduce((sum, phase) => sum + phase.duration, 0) * 1000;
            const currentCycle = Math.floor(elapsed / cycleDuration) + 1;
            
            if (currentCycle > currentExercise.totalCycles) {
                completeBreathingExercise();
                return;
            }
        };

        const completeBreathingExercise = async () => {
            clearAllTimers();
            
            const session = {
                date: new Date().toISOString(),
                exercise: currentExercise.name,
                duration: currentExercise.totalCycles * currentExercise.phases.reduce((sum, phase) => sum + phase.duration, 0),
                completed: true,
                timestamp: Date.now()
            };
            
            try {
                await saveToStore('breathingSessions', session);
            } catch (error) {
                console.error('Error saving breathing session:', error);
            }
            
            document.getElementById('instructionText').textContent = 'Exerc√≠cio conclu√≠do! üéâ';
            document.getElementById('timerText').textContent = '‚úì';
            document.getElementById('breathingText').textContent = 'Parab√©ns!';
            
            if (audioEnabled) {
                // Toca uma sequ√™ncia de notas alegre para indicar conclus√£o
                setTimeout(() => playTone(523.25, 0.15), 0);    // D√≥ (C5)
                setTimeout(() => playTone(659.25, 0.15), 200);  // Mi (E5)
                setTimeout(() => playTone(783.99, 0.15), 400);  // Sol (G5)
                setTimeout(() => playTone(1046.50, 0.3), 600);  // D√≥ (C6)
                
                speakInstruction('Parab√©ns! Voc√™ completou o exerc√≠cio de respira√ß√£o!');
            }
            
            setTimeout(() => {
                document.getElementById('breathingModal').classList.add('hidden');
                showToast('Exerc√≠cio de respira√ß√£o conclu√≠do!');
                updateDashboard();
            }, 3000);
        };

        const stopBreathing = () => {
            clearAllTimers();
            
            document.getElementById('breathingModal').classList.add('hidden');
            const circle = document.getElementById('breathingCircle');
            circle.classList.remove('animate-breathe-in', 'animate-breathe-out', 'animate-pulse-gentle');
            circle.style.transform = 'scale(1)';
        };

        const saveDiaryEntry = async () => {
            const title = document.getElementById('diaryTitle').value;
            const content = document.getElementById('diaryEntry').value;
            const tags = document.getElementById('diaryTags').value;
            
            if (!content.trim()) {
                showToast('Por favor, escreva algo no di√°rio');
                return;
            }

            const diaryEntry = {
                date: new Date().toISOString(),
                title: title || `Entrada de ${new Date().toLocaleDateString('pt-BR')}`,
                content: content,
                tags: tags ? tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                timestamp: Date.now()
            };

            try {
                await saveToStore('diaryEntries', diaryEntry);
                showToast('Entrada do di√°rio salva!');
                
                document.getElementById('diaryTitle').value = '';
                document.getElementById('diaryEntry').value = '';
                document.getElementById('diaryTags').value = '';
                
                loadDiaryEntries();
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar entrada');
                console.error('Error saving diary entry:', error);
            }
        };

        const loadDiaryEntries = async () => {
            try {
                const entries = await getAllFromStore('diaryEntries');
                const container = document.getElementById('diaryEntries');
                
                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-gray-600 text-center py-8">Nenhuma entrada ainda. Comece escrevendo sobre seu dia!</p>';
                    return;
                }
                
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.map(entry => {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const preview = entry.content.length > 150 
                        ? entry.content.substring(0, 150) + '...' 
                        : entry.content;
                    
                    const tagsHtml = entry.tags.length > 0 
                        ? entry.tags.map(tag => `<span class="bg-purple-300/30 text-accent-lavender-dark text-xs px-2 py-1 rounded-full">${tag}</span>`).join(' ')
                        : '';
                    
                    return `
                        <div class="bg-gray-50 p-4 rounded-lg border border-accent-peach/20">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-white">${entry.title}</h4>
                                <span class="text-xs text-gray-600">${date}</span>
                            </div>
                            <p class="text-gray-300 text-sm mb-3">${preview}</p>
                            ${tagsHtml ? `<div class="flex flex-wrap gap-2 mb-2">${tagsHtml}</div>` : ''}
                            <button onclick="viewDiaryEntry(${entry.id})" class="text-primary-600 text-sm hover:text-cyan-500 transition-colors">
                                üìñ Ler completo
                            </button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading diary entries:', error);
            }
        };

        const viewDiaryEntry = async (entryId) => {
            try {
                const entries = await getAllFromStore('diaryEntries');
                const entry = entries.find(e => e.id === entryId);
                
                if (entry) {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const tagsHtml = entry.tags.length > 0 
                        ? entry.tags.map(tag => `<span class="bg-purple-300/30 text-accent-lavender-dark text-xs px-2 py-1 rounded-full">${tag}</span>`).join(' ')
                        : '';
                    
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4';
                    modal.innerHTML = `
                        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-primary-300/30">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-semibold text-primary-600">${entry.title}</h3>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-600 hover:text-white text-2xl">&times;</button>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">${date}</p>
                            ${tagsHtml ? `<div class="flex flex-wrap gap-2 mb-4">${tagsHtml}</div>` : ''}
                            <div class="text-gray-300 whitespace-pre-wrap">${entry.content}</div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Error viewing diary entry:', error);
            }
        };

        const updateDashboard = async () => {
            try {
                const [moodEntries, diaryEntries, breathingSessions, sleepEntries] = await Promise.all([
                    getAllFromStore('moodEntries'),
                    getAllFromStore('diaryEntries'),
                    getAllFromStore('breathingSessions'),
                    getAllFromStore('sleepEntries')
                ]);
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                // Update mood stats
                const monthlyMoodEntries = moodEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                });
                
                document.getElementById('monthlyRecords').textContent = monthlyMoodEntries.length;
                document.getElementById('exercisesCount').textContent = breathingSessions.length;
                
                updateMoodChart(moodEntries);
                updateRecentEntries(moodEntries, diaryEntries);
                
                // Update sleep statistics
                if (sleepEntries.length === 0) {
                    ['avgSleepHours', 'sleepQuality', 'sleepStreak'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = '-';
                    });
                } else {
                    // Average duration
                    const avgDuration = sleepEntries.reduce((sum, entry) => 
                        sum + parseFloat(entry.duration), 0) / sleepEntries.length;
                    const avgSleepEl = document.getElementById('avgSleepHours');
                    if (avgSleepEl) avgSleepEl.textContent = avgDuration.toFixed(1) + 'h';
                    
                    // Quality emoji
                    const avgQuality = sleepEntries.reduce((sum, entry) => sum + entry.quality, 0) / sleepEntries.length;
                    const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                    const sleepQualityEl = document.getElementById('sleepQuality');
                    if (sleepQualityEl) sleepQualityEl.textContent = qualityEmojis[Math.round(avgQuality) - 1];

                    // Count sleep records in the current month
                    const monthlyRecords = sleepEntries.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                    }).length;
                    
                    const sleepStreakEl = document.getElementById('sleepStreak');
                    if (sleepStreakEl) sleepStreakEl.textContent = monthlyRecords;
                }
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        };

        const updateMoodChart = (moodEntries) => {
            const chartContainer = document.getElementById('moodChart');
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                last7Days.push(date);
            }
            
            const chartData = last7Days.map(date => {
                const dayEntries = moodEntries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    entryDate.setHours(0, 0, 0, 0);
                    return entryDate.getTime() === date.getTime();
                });
                
                const avgMood = dayEntries.length > 0 
                    ? dayEntries.reduce((sum, entry) => sum + entry.mood, 0) / dayEntries.length 
                    : 0;
                
                return {
                    date: date.getDate(),
                    mood: avgMood,
                    hasData: dayEntries.length > 0
                };
            });
            
            chartContainer.innerHTML = chartData.map(day => {
                const height = day.hasData ? (day.mood / 5) * 100 : 10;
                const color = day.hasData ? getColorForMood(day.mood) : 'bg-gray-600';
                
                return `
                    <div class="flex flex-col items-center">
                        <div class="w-8 ${color} rounded-t" style="height: ${height}px; min-height: 10px;"></div>
                        <span class="text-xs text-gray-600 mt-2">${day.date}</span>
                    </div>
                `;
            }).join('');
        };

        const getColorForMood = (mood) => {
            if (mood <= 2) return 'bg-red-300';
            if (mood <= 3) return 'bg-accent-peach';
            if (mood <= 4) return 'bg-cyan-300';
            return 'bg-secondary-500';
        };

        const getMoodEmoji = (mood) => {
            switch(mood) {
                case 1: return 'üò∞';
                case 2: return 'üòû';
                case 3: return 'üòê';
                case 4: return 'üòä';
                case 5: return 'üòÑ';
                default: return 'üòê';
            }
        };

        const updateRecentEntries = (moodEntries, diaryEntries) => {
            const container = document.getElementById('recentEntries');
            
            const allEntries = [
                ...moodEntries.map(entry => ({ ...entry, type: 'mood' })),
                ...diaryEntries.map(entry => ({ ...entry, type: 'diary' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if (allEntries.length === 0) {
                container.innerHTML = '<p class="text-gray-600 text-center py-4">Nenhum registro ainda. Comece registrando seu humor!</p>';
                return;
            }
            
            container.innerHTML = allEntries.map(entry => {
                const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                if (entry.type === 'mood') {
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-primary-300/20">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${getMoodEmoji(entry.mood)}</span>
                                <div>
                                    <p class="font-medium">Registro de humor</p>
                                    <p class="text-xs text-gray-600">Ansiedade: ${entry.anxiety}/10</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-600">${date}</span>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-accent-peach/20">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">‚úçÔ∏è</span>
                                <div>
                                    <p class="font-medium">${entry.title}</p>
                                    <p class="text-xs text-gray-600">${entry.content.substring(0, 50)}...</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-600">${date}</span>
                        </div>
                    `;
                }
            }).join('');
        };

        let swRegistration = null;
        let deferredPrompt;

        const registerServiceWorker = async () => {
            if ('serviceWorker' in navigator) {
                try {
                    swRegistration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    console.log('‚úÖ Service Worker registered successfully');

                    swRegistration.addEventListener('updatefound', () => {
                        const newWorker = swRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });

                    if ('sync' in window.ServiceWorkerRegistration.prototype) {
                        setupBackgroundSync();
                    }

                    if ('Notification' in window && 'PushManager' in window) {
                        setupPushNotifications();
                    }

                } catch (error) {
                    console.log('‚ùå Service Worker registration failed:', error);
                }
            }
        };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            const installBtn = document.getElementById('installBtn');
            installBtn.classList.remove('hidden');
            console.log('PWA install prompt available');
        });

        const promptInstall = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    showToast('App instalado com sucesso! üéâ');
                    document.getElementById('installBtn').classList.add('hidden');
                } else {
                    showToast('Instala√ß√£o cancelada');
                }

                deferredPrompt = null;
                return;
            }

            showToast('Instala√ß√£o n√£o dispon√≠vel neste contexto.');
            const info = document.createElement('div');
            info.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white text-gray-700 px-4 py-2 rounded shadow-lg z-50 border border-primary-300/30';
            info.innerHTML = `
                <div class="text-sm">Para testar a instala√ß√£o: sirva o site via <strong>localhost</strong> (HTTPS) e abra no navegador. Em muitos navegadores, o prompt aparece automaticamente. No iOS, use "Adicionar √† Tela de In√≠cio" no menu de compartilhamento.</div>
                <div class="text-xs text-gray-600 mt-1">Fechar em 8s</div>
            `;
            document.body.appendChild(info);
            setTimeout(() => info.remove(), 8000);
        };

        const showUpdateNotification = () => {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'fixed top-0 left-0 right-0 bg-primary-600 text-white p-3 text-center z-50';
            updateBanner.innerHTML = `
                <p class="mb-2">Nova vers√£o dispon√≠vel!</p>
                <button onclick="applyUpdate()" class="bg-white text-primary-600 px-4 py-1 rounded text-sm mr-2">
                    Atualizar
                </button>
                <button onclick="this.parentElement.remove()" class="text-white text-sm">
                    Depois
                </button>
            `;
            document.body.appendChild(updateBanner);
        };

        const applyUpdate = async () => {
            if (swRegistration && swRegistration.waiting) {
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            }
        };

        const setupBackgroundSync = () => {
            navigator.serviceWorker.ready.then(registration => {
                console.log('üîÑ Background Sync ready');
            });
        };

        const setupPushNotifications = async () => {
            if (Notification.permission === 'default') {
                console.log('üîî Push notifications available');
            }
        };

        const requestNotificationPermission = async () => {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    showToast('Notifica√ß√µes ativadas! üîî');
                    scheduleWellnessReminders();
                } else {
                    showToast('Notifica√ß√µes negadas');
                }

                return permission;
            }
        };

        const scheduleWellnessReminders = () => {
            setInterval(() => {
                if (Notification.permission === 'granted') {
                    new Notification('Calm Mind - Lembrete', {
                        body: 'Que tal registrar como voc√™ est√° se sentindo hoje? üòä',
                        icon: '/icon-192.png',
                        tag: 'daily-mood-reminder'
                    });
                }
            }, 24 * 60 * 60 * 1000);
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('üí¨ Message from SW:', event.data);

                switch (event.data.type) {
                    case 'SYNC_COMPLETE':
                        console.log('‚úÖ Dados sincronizados:', event.data.data);
                        break;

                    case 'CACHE_UPDATED':
                        console.log('üì¶ Cache updated');
                        break;
                }
            });
        }

        // Sleep tracking state
        let currentSleepQuality = 0;

        function updateSleepDuration() {
            const sleepTime = document.getElementById('sleepTime').value;
            const wakeTime = document.getElementById('wakeTime').value;
            
            if (!sleepTime || !wakeTime) return;
            
            const sleepDate = new Date(sleepTime);
            const wakeDate = new Date(wakeTime);
            
            // If wake time is before sleep time, assume it's the next day
            let duration;
            if (wakeDate < sleepDate) {
                const wakeDateNextDay = new Date(wakeDate);
                wakeDateNextDay.setDate(wakeDateNextDay.getDate() + 1);
                duration = (wakeDateNextDay - sleepDate) / (1000 * 60 * 60);
            } else {
                duration = (wakeDate - sleepDate) / (1000 * 60 * 60);
            }
            
            // Validate duration to prevent numeric overflow in database (NUMERIC(4,2) max is 99.99)
            if (duration > 99.99) {
                console.warn('Dura√ß√£o do sono muito longa, limitando a 99.99h para evitar overflow num√©rico');
                duration = 99.99;
            }
            
            return duration;
        }

        function setSleepQuality(quality) {
            currentSleepQuality = quality;
            document.querySelectorAll('.sleep-quality-btn').forEach(btn => {
                btn.classList.remove('bg-primary-600/20', 'selected');
            });
            const selectedBtn = document.querySelector(`button[onclick="setSleepQuality(${quality})"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('bg-primary-600/20', 'selected');
            }
            
            // Add haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        async function saveSleepEntry() {
            const sleepTime = document.getElementById('sleepTime').value;
            const wakeTime = document.getElementById('wakeTime').value;
            const notes = document.getElementById('sleepNotes').value;
            
            if (!sleepTime || !wakeTime) {
                showToast('Por favor, preencha os hor√°rios de dormir e acordar');
                return;
            }
            
            if (currentSleepQuality === 0) {
                showToast('Por favor, selecione a qualidade do sono');
                return;
            }
            
            const duration = updateSleepDuration();
            
            const sleepEntry = {
                date: new Date().toISOString(),
                sleepTime,
                wakeTime,
                duration,
                quality: currentSleepQuality,
                notes,
                timestamp: Date.now()
            };
            
            try {
                await saveToStore('sleepEntries', sleepEntry);
                showToast('Registro de sono salvo com sucesso!');
                
                document.getElementById('sleepTime').value = '';
                document.getElementById('wakeTime').value = '';
                document.getElementById('sleepNotes').value = '';
                currentSleepQuality = 0;
                document.querySelectorAll('.sleep-quality-btn').forEach(btn => {
                    btn.classList.remove('bg-primary-600/20');
                });
                
                loadSleepHistory();
                updateDashboard();
            } catch (error) {
                showToast('Erro ao salvar registro de sono');
                console.error('Error saving sleep entry:', error);
            }
        }

        async function loadSleepHistory() {
            try {
                const entries = await getAllFromStore('sleepEntries');
                const container = document.getElementById('sleepHistory');
                
                if (entries.length === 0) {
                    container.innerHTML = '<p class="text-gray-600 text-center py-4">Nenhum registro de sono ainda.</p>';
                    return;
                }
                
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.slice(0, 7).map(entry => {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                    
                    return `
                        <div class="bg-gray-50 p-4 rounded-xl flex items-center gap-4">
                            <div class="text-2xl">${qualityEmojis[entry.quality - 1]}</div>
                            <div class="flex-1">
                                <div class="font-semibold">${date}</div>
                                <div class="text-sm text-gray-600">
                                    ${entry.sleepTime} - ${entry.wakeTime} (${entry.duration.toFixed(1)}h)
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading sleep history:', error);
            }
        }

        // Get sleep records for the last N days
        async function getSleepRecords(days = 7) {
            try {
                if (!db) {
                    await initDB();
                }
                const entries = await getAllFromStore('sleepEntries');
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                
                // Filter out invalid entries and ensure duration is a valid number
                const validEntries = entries.filter(r => {
                    // Check if entry has required fields
                    if (!r.date) return false;
                    
                    // Check if date is valid
                    const entryDate = new Date(r.date);
                    if (isNaN(entryDate.getTime())) return false;
                    
                    // Check if duration is valid (between 0 and 99.99 hours)
                    const duration = r.duration || 0;
                    if (typeof duration !== 'number' && typeof duration !== 'string') return false;
                    
                    const durationValue = typeof duration === 'string' ? parseFloat(duration) : duration;
                    if (isNaN(durationValue) || durationValue < 0 || durationValue > 99.99) return false;
                    
                    // Check if quality is valid (between 1 and 5)
                    const quality = r.quality || 0;
                    if (typeof quality !== 'number' || quality < 1 || quality > 5) return false;
                    
                    return entryDate >= cutoffDate;
                });
                
                return validEntries;
            } catch (error) {
                console.error('Error getting sleep records:', error);
                return [];
            }
        }

        // Update sleep insights
        async function updateSleepInsights() {
            try {
                console.log('Updating sleep insights...');
                const records = await getSleepRecords(7);
                console.log('Retrieved records:', records);
                
                if (records.length === 0) {
                    console.log('No records found, setting default values');
                    document.getElementById('avgSleepHours').textContent = '-';
                    document.getElementById('avgSleepHoursInsights').textContent = '-';
                    document.getElementById('sleepRegularity').textContent = '-';
                    document.getElementById('avgSleepQuality').textContent = '-';
                    return;
                }

                // Average hours
                console.log('Sleep records for average calculation:', records);
                const durations = records.map(r => parseFloat(r.duration));
                console.log('Durations:', durations);
                const totalDuration = durations.reduce((sum, duration) => sum + duration, 0);
                console.log('Total duration:', totalDuration);
                const avgHours = totalDuration / records.length;
                console.log('Average hours:', avgHours);
                document.getElementById('avgSleepHours').textContent = avgHours.toFixed(1) + 'h';
                document.getElementById('avgSleepHoursInsights').textContent = avgHours.toFixed(1) + 'h';

                // Average quality
                const avgQuality = records.reduce((sum, r) => sum + r.quality, 0) / records.length;
                console.log('Average quality:', avgQuality);
                const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                document.getElementById('avgSleepQuality').textContent = qualityEmojis[Math.round(avgQuality) - 1];

                // Regularity score
                const sleepTimes = records.map(r => {
                    const time = new Date(r.sleepTime);
                    return time.getHours() + time.getMinutes() / 60;
                });
                
                const avgSleepTime = sleepTimes.reduce((sum, t) => sum + t, 0) / sleepTimes.length;
                const variance = sleepTimes.reduce((sum, t) => sum + Math.pow(t - avgSleepTime, 2), 0) / sleepTimes.length;
                const stdDev = Math.sqrt(variance);
                
                const regularityScore = Math.max(0, Math.min(100, 100 - (stdDev * 20)));
                console.log('Regularity score:', regularityScore);
                document.getElementById('sleepRegularity').textContent = regularityScore.toFixed(0) + '%';
                
                console.log('Sleep insights updated successfully');
            } catch (error) {
                console.error('Error updating sleep insights:', error);
            }
        }
                // Show error state
                document.getElementById('avgSleepHours').textContent = 'Erro';
                document.getElementById('avgSleepHoursInsights').textContent = 'Erro';
                document.getElementById('sleepRegularity').textContent = 'Erro';
                document.getElementById('avgSleepQuality').textContent = 'Erro';


        // Load and display sleep history
        async function loadSleepHistory() {
            try {
                console.log('Loading sleep history...');
                const entries = await getAllFromStore('sleepEntries');
                console.log('Retrieved sleep entries:', entries);
                const container = document.getElementById('sleepHistory');
                
                if (entries.length === 0) {
                    console.log('No sleep entries found');
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-3">üåô</div>
                            <p class="text-gray-600">Nenhum registro de sono ainda.<br>Comece registrando sua primeira noite!</p>
                        </div>
                    `;
                    return;
                }
                
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = entries.slice(0, 7).map(entry => {
                    const date = new Date(entry.date).toLocaleDateString('pt-BR', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const sleepTime = new Date(entry.sleepTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                    const wakeTime = new Date(entry.wakeTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                    const qualityEmojis = ['üò´', 'üòï', 'üòê', 'üòä', 'üò¥'];
                    
                    return `
                        <div class="bg-gray-50 p-4 rounded-xl flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="text-2xl">${qualityEmojis[entry.quality - 1]}</div>
                                <div>
                                    <div class="font-medium">${date}</div>
                                    <div class="text-sm text-gray-600">${sleepTime} ‚Üí ${wakeTime}</div>
                                </div>
                            </div>
                            <div class="text-lg font-medium text-primary-600">
                                ${parseFloat(entry.duration).toFixed(1)}h
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('Sleep history loaded successfully');
            } catch (error) {
                console.error('Error loading sleep history:', error);
            }
        }

        // Schedule sleep reminders
        function scheduleSleepReminders() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    const sleepEnabled = document.getElementById('sleepReminder').checked;
                    const morningEnabled = document.getElementById('morningReminder').checked;
                    
                    localStorage.setItem('sleepReminderEnabled', sleepEnabled);
                    localStorage.setItem('morningReminderEnabled', morningEnabled);
                    
                    if (sleepEnabled || morningEnabled) {
                        showToast('Lembretes configurados! üîî');
                    }
                });
            }
        }

        // Initialize sleep tracking functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Quality button click handlers
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.quality-btn').forEach(b => {
                        b.classList.remove('active', 'bg-primary-600/20', 'scale-110', 'shadow-lg');
                    });
                    this.classList.add('active', 'bg-primary-600/20', 'scale-110', 'shadow-lg');
                    document.getElementById('sleepQuality').value = this.dataset.quality;
                    
                    // Add haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                });
            });

            // Sleep form submission
            document.getElementById('sleepForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const sleepTime = new Date(document.getElementById('sleepTime').value);
                const wakeTime = new Date(document.getElementById('wakeTime').value);
                const quality = document.getElementById('sleepQuality').value;

                if (!quality) {
                    showToast('Por favor, selecione a qualidade do sono');
                    return;
                }

                // Calculate duration properly handling overnight sleep
                let duration;
                if (wakeTime < sleepTime) {
                    // If wake time is before sleep time, assume it's the next day
                    const wakeTimeNextDay = new Date(wakeTime);
                    wakeTimeNextDay.setDate(wakeTimeNextDay.getDate() + 1);
                    duration = (wakeTimeNextDay - sleepTime) / (1000 * 60 * 60); // hours
                } else {
                    duration = (wakeTime - sleepTime) / (1000 * 60 * 60); // hours
                }

                // Validate duration to prevent numeric overflow in database (NUMERIC(4,2) max is 99.99)
                if (duration > 99.99) {
                    showToast('Dura√ß√£o do sono muito longa. M√°ximo permitido √© 99.99 horas (aprox. 4 dias).');
                    return;
                }

                try {
                    const sleepEntry = {
                        date: new Date().toISOString(),
                        sleepTime: sleepTime.toISOString(),
                        wakeTime: wakeTime.toISOString(),
                        duration: duration.toFixed(2),
                        quality: parseInt(quality),
                        timestamp: Date.now()
                    };

                    try {
                        await saveToStore('sleepEntries', sleepEntry);
                        showToast('Registro de sono salvo com sucesso! üéâ');
                        
                        // Reset form
                        document.querySelectorAll('.quality-btn').forEach(btn => {
                            btn.classList.remove('active', 'bg-primary-600/20', 'scale-110', 'shadow-lg');
                        });
                        document.getElementById('sleepQuality').value = '';
                        
                        // Update UI
                        console.log('Updating UI after saving sleep entry');
                        await loadSleepHistory();
                        await updateSleepInsights();
                        await updateDashboard();
                        console.log('UI updated successfully');
                    } catch (error) {
                        showToast('Erro ao salvar registro');
                        console.error('Error saving sleep entry:', error);
                    }
                } catch (error) {
                    showToast('Erro ao salvar registro');
                    console.error('Error creating sleep entry:', error);
                }
            });

            // Load saved reminder preferences
            document.getElementById('sleepReminder').checked = 
                localStorage.getItem('sleepReminderEnabled') === 'true';
            document.getElementById('morningReminder').checked = 
                localStorage.getItem('morningReminderEnabled') === 'true';

            // Reminder toggle handlers
            document.getElementById('sleepReminder').addEventListener('change', function() {
                localStorage.setItem('sleepReminderEnabled', this.checked);
                if (this.checked) scheduleSleepReminders();
            });

            document.getElementById('morningReminder').addEventListener('change', function() {
                localStorage.setItem('morningReminderEnabled', this.checked);
                if (this.checked) scheduleSleepReminders();
            });

            // Set default datetime values for sleep form
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            yesterday.setHours(22, 0);
            now.setHours(7, 0);
            
            if (document.getElementById('sleepTime')) {
                document.getElementById('sleepTime').value = yesterday.toISOString().slice(0, 16);
            }
            if (document.getElementById('wakeTime')) {
                document.getElementById('wakeTime').value = now.toISOString().slice(0, 16);
            }

            // Initial UI update if we're in the sleep section
            if (!document.getElementById('sleep-section').classList.contains('hidden')) {
                loadSleepHistory();
                updateSleepInsights();
            }
        });

        const initApp = async () => {
            try {
                // üÜï VERIFICAR AUTENTICA√á√ÉO ANTES DE TUDO
                console.log('Verificando autentica√ß√£o...');
                const isAuthenticated = await checkAuth();
                
                if (!isAuthenticated) {
                    console.log('Usu√°rio n√£o autenticado, redirecionando...');
                    return; // Redireciona para landing page
                }
                
                console.log('Usu√°rio autenticado!');
                
                // üÜï INICIALIZAR SUPABASE
                if (!initSupabase()) {
                    console.error('Erro ao inicializar Supabase');
                }
                
                // üÜï EXIBIR NOME DO USU√ÅRIO
                displayUserGreeting();
                
                // Inicializar banco de dados local
                await initDB();
                console.log('Database initialized');
                
                // üÜï TRAZER DADOS DO SUPABASE PRIMEIRO
                console.log('Carregando dados da nuvem...');
                await syncFromSupabase().catch(err => console.error('Erro ao sincronizar dados iniciais:', err));
                
                // üÜï INICIAR SINCRONIZA√á√ÉO AUTOM√ÅTICA
                console.log('Iniciando sincroniza√ß√£o autom√°tica...');
                startAutoSync();
                
                // Carrega frases favoritas
                loadFavoritePhrases();
                
                // Inicia rota√ß√£o de frases motivacionais
                startPhraseRotation();
                
                // üÜï INICIAR SISTEMA DE MOMENTOS DE REFLEX√ÉO
                startReflectionSystem();
                
                // Initialize sleep tracking
                await loadSleepHistory();
                await updateSleepInsights();
                
                // Ocultar loading e mostrar app
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                // Mostrar dashboard
                showSection('dashboard');

                // Registrar Service Worker
                registerServiceWorker();
                
                try {
                    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                        const installBtn = document.getElementById('installBtn');
                        if (installBtn) {
                            installBtn.classList.remove('hidden');
                            installBtn.title = 'Teste: instala√ß√£o (localhost) - em produ√ß√£o o prompt aparece automaticamente quando dispon√≠vel';
                        }
                    }
                } catch (err) {
                    console.warn('Erro ao tentar mostrar bot√£o de instala√ß√£o em dev:', err);
                }
                
            } catch (error) {
                console.error('Error initializing app:', error);
                
                // Mesmo com erro, mostrar o app em modo offline
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                showSection('dashboard');
                
                showToast('App iniciado em modo offline', true);
            }
        };

        // ==========================================
        // SISTEMA DE LOGOUT COM VALIDA√á√ÉO
        // ==========================================

        // Abrir modal de confirma√ß√£o de logout
        function openLogoutModal() {
            document.getElementById('logoutModal').classList.remove('hidden');
        }

        // Fechar modal de logout
        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.add('hidden');
        }

        // Confirmar logout e fazer a desconex√£o
        async function confirmLogout() {
            closeLogoutModal();
            
            const logoutBtn = document.querySelector('button[onclick="openLogoutModal()"]');
            logoutBtn.disabled = true;
            logoutBtn.innerHTML = '<span class="text-lg animate-sync">‚è≥</span> <span class="hidden sm:inline">Saindo...</span>';
            
            try {
                // Aguardar sincroniza√ß√£o final antes de sair
                await syncToSupabase();
                
                // Limpar dados locais
                localStorage.removeItem('calm_mind_session');
                localStorage.removeItem('calmMindFavorites');
                
                // Fazer logout no Supabase
                await logout();
                
                showToast('At√© logo! üëã');
                
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                logoutBtn.disabled = false;
                logoutBtn.innerHTML = '<span class="text-lg">üö™</span> <span class="hidden sm:inline">Sair</span>';
                showToast('Erro ao desconectar. Tente novamente.');
            }
        }

        // Fechar modal ao clicar fora
        document.addEventListener('click', (e) => {
            const logoutModal = document.getElementById('logoutModal');
            if (e.target === logoutModal) {
                closeLogoutModal();
            }
        });

        // ==========================================
        // SISTEMA DE SINCRONIZA√á√ÉO COM FEEDBACK VISUAL
        // ==========================================

        // Sincroniza√ß√£o manual com feedback visual otimizado
        async function manualSync() {
            // Verificar se j√° existe sincroniza√ß√£o em andamento (global)
            if (typeof isSyncing !== 'undefined' && isSyncing) {
                return;
            }

            const syncBtn = document.getElementById('syncBtn');
            const syncIcon = document.getElementById('syncIcon');
            
            if (!syncBtn || !syncIcon) return;

            // Feedback visual: animar √≠cone
            syncIcon.classList.add('animate-sync');
            syncBtn.disabled = true;

            try {
                // Executar sincroniza√ß√µes em paralelo para ser mais r√°pido
                await Promise.all([
                    syncToSupabase(),
                    syncFromSupabase()
                ]);
                
                // Sucesso - mostrar ‚úÖ por 2 segundos
                syncIcon.classList.remove('animate-sync');
                syncIcon.textContent = '‚úÖ';
                
                // Voltar ao normal ap√≥s 2 segundos
                setTimeout(() => {
                    syncIcon.textContent = '‚òÅÔ∏è';
                    syncBtn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
                syncIcon.classList.remove('animate-sync');
                syncIcon.textContent = '‚ùå';
                
                // Voltar ao normal ap√≥s 3 segundos
                setTimeout(() => {
                    syncIcon.textContent = '‚òÅÔ∏è';
                    syncBtn.disabled = false;
                }, 3000);
            }
        }

        // ==========================================

        // SISTEMA DE SINCRONIZA√á√ÉO COM SUPABASE
        // As constantes e fun√ß√µes est√£o no arquivo js/supabase-sync.js

        // ==========================================

        // Inicializar cliente Supabase
        function initSupabase() {
            if (typeof supabase === 'undefined') {
                console.error('Biblioteca Supabase n√£o carregada');
                return false;
            }
            
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            return true;
        }

        // Verificar autentica√ß√£o
        async function checkAuth() {
            if (!supabaseClient) {
                if (!initSupabase()) return false;
            }

            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error || !session) {
                    // Redirecionar para landing page se n√£o estiver autenticado
                    window.location.href = '/login';
                    return false;
                }
                
                // Salvar sess√£o localmente
                localStorage.setItem('calm_mind_session', JSON.stringify(session));
                return true;
            } catch (error) {
                console.error('Erro ao verificar autentica√ß√£o:', error);
                return false;
            }
        }

        // Logout
        async function logout() {
            try {
                // üÜï PARAR SISTEMA DE REFLEX√ÉO
                stopReflectionSystem();
                
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                localStorage.removeItem('calm_mind_session');
                localStorage.removeItem('calm_mind_user');
                window.location.href = '/login';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }

        // ==========================================
        // FUN√á√ïES DE SINCRONIZA√á√ÉO
        // ==========================================

        // Obter ID do usu√°rio atual
        function getCurrentUserId() {
            const session = JSON.parse(localStorage.getItem('calm_mind_session') || '{}');
            return session?.user?.id;
        }

        // Sincronizar dados do IndexedDB com Supabase
        async function syncToSupabase() {
            const userId = getCurrentUserId();
            if (!userId) {
                console.log('Usu√°rio n√£o autenticado, pulando sincroniza√ß√£o');
                return;
            }

            if (!navigator.onLine) {
                console.log('Sem conex√£o, sincroniza√ß√£o adiada');
                return;
            }

            console.log('Iniciando sincroniza√ß√£o com Supabase...');

            try {
                // Sincronizar registros de humor
                await syncMoodEntries(userId);
                
                // Sincronizar entradas do di√°rio
                await syncDiaryEntries(userId);
                
                // Sincronizar sess√µes de respira√ß√£o
                await syncBreathingSessions(userId);
                
                // Sincronizar registros de sono
                await syncSleepEntries(userId);
                
                console.log('Sincroniza√ß√£o conclu√≠da com sucesso!');
                
                // Atualizar timestamp da √∫ltima sincroniza√ß√£o
                localStorage.setItem('last_sync', new Date().toISOString());
            } catch (error) {
                console.error('Erro na sincroniza√ß√£o:', error);
            }
        }

        // Sincronizar registros de humor
        async function syncMoodEntries(userId) {
            const localEntries = await getAllFromStore('moodEntries');
            
            // Filtrar apenas entradas n√£o sincronizadas
            const unsyncedEntries = localEntries.filter(entry => !entry.synced);
            
            if (unsyncedEntries.length === 0) {
                console.log('Nenhum registro de humor para sincronizar');
                return;
            }

            console.log(`Sincronizando ${unsyncedEntries.length} registros de humor...`);

            for (const entry of unsyncedEntries) {
                try {
                    const { data, error } = await supabaseClient
                        .from('mood_entries')
                        .upsert({
                            user_id: userId,
                            local_id: entry.id,
                            date: entry.date,
                            mood: entry.mood,
                            anxiety: entry.anxiety,
                            notes: entry.notes,
                            timestamp: entry.timestamp
                        }, {
                            onConflict: 'user_id,local_id'
                        });

                    if (error) throw error;

                    // Marcar como sincronizado no IndexedDB
                    await updateSyncStatus('moodEntries', entry.id);
                } catch (error) {
                    console.error('Erro ao sincronizar registro de humor:', error);
                }
            }
        }

        // Sincronizar entradas do di√°rio
        async function syncDiaryEntries(userId) {
            const localEntries = await getAllFromStore('diaryEntries');
            const unsyncedEntries = localEntries.filter(entry => !entry.synced);
            
            if (unsyncedEntries.length === 0) {
                console.log('Nenhuma entrada de di√°rio para sincronizar');
                return;
            }

            console.log(`Sincronizando ${unsyncedEntries.length} entradas de di√°rio...`);

            for (const entry of unsyncedEntries) {
                try {
                    const { data, error } = await supabaseClient
                        .from('diary_entries')
                        .upsert({
                            user_id: userId,
                            local_id: entry.id,
                            date: entry.date,
                            title: entry.title,
                            content: entry.content,
                            tags: entry.tags,
                            timestamp: entry.timestamp
                        }, {
                            onConflict: 'user_id,local_id'
                        });

                    if (error) throw error;

                    await updateSyncStatus('diaryEntries', entry.id);
                } catch (error) {
                    console.error('Erro ao sincronizar entrada de di√°rio:', error);
                }
            }
        }

        // Sincronizar sess√µes de respira√ß√£o
        async function syncBreathingSessions(userId) {
            const localSessions = await getAllFromStore('breathingSessions');
            const unsyncedSessions = localSessions.filter(session => !session.synced);
            
            if (unsyncedSessions.length === 0) {
                console.log('Nenhuma sess√£o de respira√ß√£o para sincronizar');
                return;
            }

            console.log(`Sincronizando ${unsyncedSessions.length} sess√µes de respira√ß√£o...`);

            for (const session of unsyncedSessions) {
                try {
                    const { data, error } = await supabaseClient
                        .from('breathing_sessions')
                        .upsert({
                            user_id: userId,
                            local_id: session.id,
                            date: session.date,
                            exercise: session.exercise,
                            duration: session.duration,
                            completed: session.completed,
                            timestamp: session.timestamp
                        }, {
                            onConflict: 'user_id,local_id'
                        });

                    if (error) throw error;

                    await updateSyncStatus('breathingSessions', session.id);
                } catch (error) {
                    console.error('Erro ao sincronizar sess√£o de respira√ß√£o:', error);
                }
            }
        }

        // Sincronizar registros de sono
        async function syncSleepEntries(userId) {
            const localEntries = await getAllFromStore('sleepEntries');
            const unsyncedEntries = localEntries.filter(entry => !entry.synced);
            
            if (unsyncedEntries.length === 0) {
                console.log('Nenhum registro de sono para sincronizar');
                return;
            }

            console.log(`Sincronizando ${unsyncedEntries.length} registros de sono...`);

            for (const entry of unsyncedEntries) {
                try {
                    // Validate duration to prevent numeric overflow in database (NUMERIC(4,2) max is 99.99)
                    let duration = entry.duration || 0;
                    
                    // Convert to number if it's a string
                    if (typeof duration === 'string') {
                        duration = parseFloat(duration);
                    }
                    
                    // Ensure duration is a valid number
                    if (isNaN(duration) || typeof duration !== 'number' || !isFinite(duration)) {
                        console.warn(`Dura√ß√£o inv√°lida (${entry.duration}), definindo como 0`);
                        duration = 0;
                    }
                    
                    // Cap duration at maximum allowed value to prevent overflow
                    if (duration > 99.99) {
                        console.warn(`Dura√ß√£o do sono muito longa (${duration}h), limitando a 99.99h para evitar overflow num√©rico`);
                        duration = 99.99;
                    }
                    
                    // Ensure duration is not negative
                    if (duration < 0) {
                        console.warn(`Dura√ß√£o negativa (${duration}h), definindo como 0`);
                        duration = 0;
                    }
                    
                    // Ensure duration is formatted correctly for NUMERIC(4,2) field
                    duration = Number(duration.toFixed(2));

                    // Log the data being sent for debugging
                    console.log('Sending sleep entry to Supabase:', {
                        user_id: userId,
                        local_id: entry.id,
                        date: entry.date,
                        sleep_time: entry.sleepTime,
                        wake_time: entry.wakeTime,
                        duration: duration,
                        quality: entry.quality,
                        notes: entry.notes,
                        timestamp: entry.timestamp
                    });
                    
                    const { data, error } = await supabaseClient
                        .from('sleep_entries')
                        .upsert({
                            user_id: userId,
                            local_id: entry.id,
                            date: entry.date,
                            sleep_time: entry.sleepTime,
                            wake_time: entry.wakeTime,
                            duration: duration,
                            quality: entry.quality,
                            notes: entry.notes,
                            timestamp: entry.timestamp
                        }, {
                            onConflict: 'user_id,local_id'
                        });

                    if (error) throw error;

                    await updateSyncStatus('sleepEntries', entry.id);
                } catch (error) {
                    console.error('Erro ao sincronizar registro de sono:', error);
                }
            }
        }

        // Atualizar status de sincroniza√ß√£o no IndexedDB
        async function updateSyncStatus(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);

                request.onsuccess = () => {
                    const data = request.result;
                    data.synced = true;
                    data.syncedAt = new Date().toISOString();
                    
                    const updateRequest = store.put(data);
                    updateRequest.onsuccess = () => resolve();
                    updateRequest.onerror = () => reject(updateRequest.error);
                };

                request.onerror = () => reject(request.error);
            });
        }

        // ==========================================
        // SINCRONIZA√á√ÉO BIDIRECIONAL (DOWNLOAD)
        // ==========================================

        // Baixar dados do Supabase para o IndexedDB
        async function syncFromSupabase() {
            const userId = getCurrentUserId();
            if (!userId || !navigator.onLine) return;

            console.log('Baixando dados do Supabase...');

            try {
                // Buscar √∫ltima sincroniza√ß√£o
                const lastSync = localStorage.getItem('last_sync');
                const timestamp = lastSync ? new Date(lastSync) : new Date(0);

                // Baixar registros de humor
                await downloadMoodEntries(userId, timestamp);
                
                // Baixar entradas do di√°rio
                await downloadDiaryEntries(userId, timestamp);
                
                // Baixar sess√µes de respira√ß√£o
                await downloadBreathingSessions(userId, timestamp);
                
                // Baixar registros de sono
                await downloadSleepEntries(userId, timestamp);

                console.log('Download de dados conclu√≠do!');
            } catch (error) {
                console.error('Erro ao baixar dados:', error);
            }
        }

        // Baixar registros de humor
        async function downloadMoodEntries(userId, since) {
            try {
                const { data, error } = await supabaseClient
                    .from('mood_entries')
                    .select('*')
                    .eq('user_id', userId)
                    .gt('updated_at', since.toISOString());

                if (error) throw error;

                for (const entry of data || []) {
                    // Verificar se j√° existe localmente
                    const localEntries = await getAllFromStore('moodEntries');
                    const exists = localEntries.some(e => e.id === entry.local_id);

                    if (!exists) {
                        await saveToStore('moodEntries', {
                            id: entry.local_id,
                            date: entry.date,
                            mood: entry.mood,
                            anxiety: entry.anxiety,
                            notes: entry.notes,
                            timestamp: entry.timestamp,
                            synced: true,
                            syncedAt: entry.updated_at
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao baixar registros de humor:', error);
            }
        }

        // Baixar entradas do di√°rio
        async function downloadDiaryEntries(userId, since) {
            try {
                const { data, error } = await supabaseClient
                    .from('diary_entries')
                    .select('*')
                    .eq('user_id', userId)
                    .gt('updated_at', since.toISOString());

                if (error) throw error;

                for (const entry of data || []) {
                    // Verificar se j√° existe localmente
                    const localEntries = await getAllFromStore('diaryEntries');
                    const exists = localEntries.some(e => e.id === entry.local_id);

                    if (!exists) {
                        await saveToStore('diaryEntries', {
                            id: entry.local_id,
                            date: entry.date,
                            title: entry.title,
                            content: entry.content,
                            tags: entry.tags,
                            timestamp: entry.timestamp,
                            synced: true,
                            syncedAt: entry.updated_at
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao baixar entradas de di√°rio:', error);
            }
        }

        // Baixar sess√µes de respira√ß√£o
        async function downloadBreathingSessions(userId, since) {
            try {
                const { data, error } = await supabaseClient
                    .from('breathing_sessions')
                    .select('*')
                    .eq('user_id', userId)
                    .gt('updated_at', since.toISOString());

                if (error) throw error;

                for (const session of data || []) {
                    // Verificar se j√° existe localmente
                    const localSessions = await getAllFromStore('breathingSessions');
                    const exists = localSessions.some(s => s.id === session.local_id);

                    if (!exists) {
                        await saveToStore('breathingSessions', {
                            id: session.local_id,
                            date: session.date,
                            exercise: session.exercise,
                            duration: session.duration,
                            completed: session.completed,
                            timestamp: session.timestamp,
                            synced: true,
                            syncedAt: session.updated_at
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao baixar sess√µes de respira√ß√£o:', error);
            }
        }

        // Baixar registros de sono
        async function downloadSleepEntries(userId, since) {
            try {
                const { data, error } = await supabaseClient
                    .from('sleep_entries')
                    .select('*')
                    .eq('user_id', userId)
                    .gt('updated_at', since.toISOString());

                if (error) throw error;

                for (const entry of data || []) {
                    // Verificar se j√° existe localmente
                    const localEntries = await getAllFromStore('sleepEntries');
                    const exists = localEntries.some(e => e.id === entry.local_id);

                    if (!exists) {
                        // Validate duration to prevent issues with invalid data from server
                        let duration = entry.duration || 0;
                        
                        // Convert to number if it's a string
                        if (typeof duration === 'string') {
                            duration = parseFloat(duration);
                        }
                        
                        // Ensure duration is a valid number
                        if (isNaN(duration) || typeof duration !== 'number' || !isFinite(duration)) {
                            console.warn(`Dura√ß√£o inv√°lida (${entry.duration}) recebida do servidor, definindo como 0`);
                            duration = 0;
                        }
                        
                        // Cap duration at maximum allowed value to prevent overflow
                        if (duration > 99.99) {
                            console.warn(`Dura√ß√£o do sono muito longa (${duration}h) recebida do servidor, limitando a 99.99h`);
                            duration = 99.99;
                        }
                        
                        // Ensure duration is not negative
                        if (duration < 0) {
                            console.warn(`Dura√ß√£o negativa (${duration}h) recebida do servidor, definindo como 0`);
                            duration = 0;
                        }
                        
                        // Ensure duration is formatted correctly for NUMERIC(4,2) field
                        duration = Number(duration.toFixed(2));
                        
                        await saveToStore('sleepEntries', {
                            id: entry.local_id,
                            date: entry.date,
                            sleepTime: entry.sleep_time,
                            wakeTime: entry.wake_time,
                            duration: duration,
                            quality: entry.quality,
                            notes: entry.notes,
                            timestamp: entry.timestamp,
                            synced: true,
                            syncedAt: entry.updated_at
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao baixar registros de sono:', error);
            }
        }

        // Iniciar sincroniza√ß√£o peri√≥dica
        function startSyncInterval() {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            syncInterval = setInterval(async () => {
                await syncToSupabase();
                await syncFromSupabase();
            }, SYNC_INTERVAL_MS);
        }

        // ==========================================

        document.addEventListener('DOMContentLoaded', initApp);

        // --- Valida√ß√£o do Registro de Sono ---
        document.getElementById("sleepForm").addEventListener("submit", function (e) {
        const sleepTimeInput = document.getElementById("sleepTime");
        const wakeTimeInput = document.getElementById("wakeTime");

        const sleepTime = new Date(sleepTimeInput.value);
        const wakeTime = new Date(wakeTimeInput.value);

        if (!sleepTime || !wakeTime) return;

        if (wakeTime <= sleepTime) {
            e.preventDefault();
            alert("A hora que acordou deve ser maior que a hora que dormiu.");
            return;
        }
        
        // Validate duration to prevent numeric overflow in database (NUMERIC(4,2) max is 99.99)
        let duration;
        if (wakeTime < sleepTime) {
            // If wake time is before sleep time, assume it's the next day
            const wakeTimeNextDay = new Date(wakeTime);
            wakeTimeNextDay.setDate(wakeTimeNextDay.getDate() + 1);
            duration = (wakeTimeNextDay - sleepTime) / (1000 * 60 * 60); // hours
        } else {
            duration = (wakeTime - sleepTime) / (1000 * 60 * 60); // hours
        }
        
        if (duration > 99.99) {
            e.preventDefault();
            alert("Dura√ß√£o do sono muito longa. M√°ximo permitido √© 99.99 horas (aprox. 4 dias).");
            return;
        }
    });

    // --- Bloqueia sele√ß√£o inv√°lida imediatamente ---
    document.getElementById("wakeTime").addEventListener("change", function () {
        const sleepTime = new Date(document.getElementById("sleepTime").value);
        const wakeTime = new Date(this.value);

        if (sleepTime && wakeTime <= sleepTime) {
            alert("A hora que acordou deve ser maior que a hora que dormiu.");
            this.value = "";
        }
    });

 function formatLocalDate(date) {
        const pad = (n) => String(n).padStart(2, "0");

        return (
            date.getFullYear() +
            "-" +
            pad(date.getMonth() + 1) +
            "-" +
            pad(date.getDate()) +
            "T" +
            pad(date.getHours()) +
            ":" +
            pad(date.getMinutes())
        );
    }

    document.addEventListener("DOMContentLoaded", () => {
        const sleepInput = document.getElementById("sleepTime");
        const wakeInput = document.getElementById("wakeTime");

        // Dormiu: hoje 23:00 (hor√°rio local real)
        const sleep = new Date();
        sleep.setHours(23, 0, 0, 0);
        sleepInput.value = formatLocalDate(sleep);

        // Acordou: amanh√£ 07:00
        const wake = new Date();
        wake.setDate(wake.getDate() + 1);
        wake.setHours(7, 0, 0, 0);
        wakeInput.value = formatLocalDate(wake);

    });
</script>

    </script>
    
    <!-- üî• ADICIONAR ANTES DO </body> -->
    
    <!-- Sistema de Sincroniza√ß√£o com Supabase -->
    <script src="/js/supabase-sync.js"></script>
    
    <!-- Melhorias de UI para Sincroniza√ß√£o -->
    <script src="/js/sync-ui-enhancements.js"></script>
    
    <!-- Carregar o Componente React -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" src="/js/oceanmind.jsx"></script>
</body>
</html>






